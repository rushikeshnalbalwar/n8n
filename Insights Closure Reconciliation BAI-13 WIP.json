{"updatedAt":"2025-12-18T19:30:55.965Z","createdAt":"2025-08-21T15:58:29.504Z","id":"yKwxcKzgjfQYG2QN","name":"Insights Closure Reconciliation BAI-13 WIP","active":true,"isArchived":false,"nodes":[{"parameters":{"url":"https://api.hubapi.com/crm/v3/objects/deals/42228302623/associations/line_items","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-640,-704],"id":"90e6e00e-520d-4e91-9ac6-402a499bb87a","name":"HTTP Get pf_line_item","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}},"disabled":true},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"properties","value":"group_id,offer_type,country,description,reconciliation_type,reconciliation_status,scrub_rate__line_item_,scrub_rate__billable_event_,"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,-704],"id":"bb979bb2-2123-421f-9951-e790ab7a57cc","name":"HTTP Get pf_line_item values","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}},"disabled":true},{"parameters":{"content":"# pf_line_item","height":320,"width":608,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-672,-864],"typeVersion":1,"id":"37ba02fc-988a-4dc7-b4cc-250a32836504","name":"Sticky Note","disabled":true},{"parameters":{"fieldToSplitOut":"results","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-416,-704],"id":"34f4db3f-4cb9-42b8-9afa-c953c4942a15","name":"Split Out","disabled":true},{"parameters":{"jsCode":"// ===========================================\n// ðŸ” Generate Prodege Signature for Reconciliation\n// ===========================================\nconst crypto = require('crypto');\n\n// Get the decrypted keys from the current input\nconst apiKey = $json.apiKey;\nconst secretKey = $json.secretKey;\nconst reconciliationNote = $json.reconciliationNote || '';\nconst timeOffsetNode = $('timeOffset').item.json;\nconst timeOffset = timeOffsetNode.request_time_offset || 0;\n\n// ===========================================\n// ðŸ“Š Group Data by Project ID\n// ===========================================\n// Get all items from Edit Fields node to group by project\nconst editFieldsItems = $('Edit Fields').all();\nconst groupedData = {};\n\nconsole.log('Debug - Edit Fields Items:', editFieldsItems.map(item => ({ \n  projectId: item.json.prodegeProjectId, \n  ticketId: item.json.ticket_id \n})));\n\neditFieldsItems.forEach(item => {\n  const projectId = item.json.prodegeProjectId;\n  const successfulIds = item.json.successfulTransactionIds;\n  const transactionRewards = item.json.transaction_rewards;\n  const ticketId = item.json.ticket_id;\n  \n  if (!groupedData[projectId]) {\n    groupedData[projectId] = {\n      successfulTransactionIds: [],\n      transactionRewards: [],\n      ticketId: ticketId // Store the ticket_id for this project\n    };\n  }\n  \n  // Update ticket_id if not already set (in case of multiple items per project)\n  if (!groupedData[projectId].ticketId && ticketId) {\n    groupedData[projectId].ticketId = ticketId;\n  }\n  \n  // Add successful transaction IDs\n  if (successfulIds) {\n    const idsArray = Array.isArray(successfulIds) \n      ? successfulIds \n      : successfulIds.toString().split(',').map(id => id.trim());\n    groupedData[projectId].successfulTransactionIds.push(...idsArray);\n  }\n  \n  // Add transaction rewards\n  if (transactionRewards && Array.isArray(transactionRewards)) {\n    groupedData[projectId].transactionRewards.push(...transactionRewards);\n  }\n});\n\n// ===========================================\n// ðŸ•’ Compute Correct Timestamp\n// ===========================================\nconst clientTime = Date.now();\nconst requestDate = clientTime + timeOffset;\n\n// ===========================================\n// âœ… Return Multiple Items - One Per Project with Signatures\n// ===========================================\nconst results = [];\n\nObject.keys(groupedData).forEach(projectId => {\n  // Remove duplicate transaction IDs and convert to comma-separated string\n  const uniqueIds = [...new Set(groupedData[projectId].successfulTransactionIds)];\n  const successfulTransactionIds = uniqueIds.join(',');\n  \n  // Remove duplicate transaction rewards based on TransactionID\n  const uniqueRewards = [];\n  const seenIds = new Set();\n  groupedData[projectId].transactionRewards.forEach(reward => {\n    if (!seenIds.has(reward.TransactionID)) {\n      seenIds.add(reward.TransactionID);\n      uniqueRewards.push(reward);\n    }\n  });\n  \n  // ===========================================\n  // ðŸ“‹ CPI Check - List each transaction and CPI status\n  // ===========================================\n  const cpiCheck = uniqueRewards.map(reward => ({\n    TransactionID: reward.TransactionID,\n    CPI: reward.CPI,\n    CPIStatus: (reward.CPI === null || reward.CPI === undefined || reward.CPI === '') ? 'Blank' : 'Populated'\n  }));\n  \n  // ===========================================\n  // ðŸ§© Build Params and Signing String for THIS project\n  // ===========================================\n  const params = {\n    apik: apiKey,\n    request_date: requestDate,\n    prodege_project_id: projectId,\n    successful_transaction_ids: successfulTransactionIds,\n    reconciliation_note: reconciliationNote\n  };\n\n  const stringToSign = Object.keys(params)\n    .sort()\n    .map(key => `${key}=${params[key]}`)\n    .join(':');\n\n  // ===========================================\n  // ðŸ” Generate Signature (standard Base64) for THIS project\n  // ===========================================\n  const utf8Encoded = Buffer.from(`${secretKey}:${stringToSign}`, 'utf8');\n  const sha256Hash = crypto.createHash('sha256').update(utf8Encoded).digest();\n  const signature = sha256Hash.toString('base64');\n  \n  results.push({\n    json: {\n      // Clean structure you requested\n      projectId: projectId,\n      ticketId: groupedData[projectId].ticketId, // âœ… Added ticket_id to output\n      successfulTransactionIds: successfulTransactionIds,\n      transactionRewards: uniqueRewards,\n      //cpiCheck: cpiCheck, // âœ… NEW - CPI check output with corrected logic\n      // Original signature fields (FIXED - was missing signature)\n      apik: apiKey,\n      request_date: requestDate,\n      reconciliation_note: reconciliationNote,\n      signature: signature // âœ… FIXED - Added missing signature\n    }\n  });\n});\n\nconsole.log('Debug - Final results:', results.map(r => ({ \n  projectId: r.json.projectId,\n  ticketId: r.json.ticketId, \n  hasSignature: !!r.json.signature \n})));\n\nreturn results;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-560,-128],"id":"e1ce95f5-1b62-4075-bc6f-125937a9d4e0","name":"Generate Signature"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"prodegeProjectId\": \"{{ $json.PROJECTID }}\",\n  \"encryptedApiKey\": \"b8bf506b7cb157e3e3fb549b865ec8fb:b04c382cb8e13b1411175ec4e3d0e058\",\n  \"encryptedSecretKey\": \"2288a8ec9a2fcb29aa77927896d4c21e:e0f1a9125b9e6478324b8aa4a5d0d64d2fc7b99e80d81949ef0b2834bdcb9ec7bdbffe0b3bca7fc2eeea4dfff3f6d168\",\n  \"encryptionPassword\": \"MySecretPassword123!\",\n  \"successfulTransactionIds\": \"{{ $json.successful_transaction_ids }}\" , \n  \"reconciliationNote\": \"Reconciliation note\",\n  \"ticket_id\": \"{{ $json.ticket_id }}\" ,\n  \"transaction_rewards\": {{ $('Re-Clean Data').item.json.transaction_rewards }}\n} ","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-944,-128],"id":"c4398afb-099c-4d83-a2d8-bd9063f56833","name":"Edit Fields"},{"parameters":{"url":"=https://surveypmr.prodegeapisqa.com/prodegemr/lookup-request-time-offset?client_time={{ Date.now() }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-768,-128],"id":"cfef2fb8-0b5e-4c1b-aebe-0d458cdaae72","name":"timeOffset","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"}}},{"parameters":{"content":"## ðŸ”µ **Credentials Used**\n\n\n**HTTP Bearer Auth:**\nâ€¢ **Credential Name:** `peeqAPI`\nâ€¢ **Usage:** Authenticate API requests to Prodege QA endpoints\n\n**n8n Storage:**\nâ€¢ Credentials stored securely in n8n\n\n**Notes:**\nâ€¢ Ensure API keys and tokens match environment (Sandbox vs Prod)\nâ€¢ Only use credentials in nodes that require authentication","height":324,"width":480,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-1280,-864],"typeVersion":1,"id":"0ca56a4a-2325-4deb-9c46-e399f0d88ae1","name":"Credentials Used"},{"parameters":{"content":"## ðŸŸ¡ **Summary of Project Reconciliation Workflow**\n\n**Purpose:**\nAutomates reconciliation of scrubbed IDs in Peeq, updating project status and maintaining accurate transaction records.\n\n**Trigger Node:**\nâ€¢ `When clicking â€˜Execute workflowâ€™` â€“ manual execution\n\n**Key Nodes and Flow:**\nâ€¢ **Edit Fields:** Sets dynamic input: project ID, transaction IDs, and reconciliation note\nâ€¢ **timeOffset:** Retrieves server-client time offset for accurate signature\nâ€¢ **Generate Signature:** Calculates SHA256 signature using hardcoded API keys and dynamic input\nâ€¢ **Reconciliation:** HTTP POST to Prodege QA endpoint\n\n**Functionality:**\nâ€¢ Reconciles scrubbed IDs in Peeq\nâ€¢ Moves projects to **Pending Complete** status\nâ€¢ Adds projects into **Pending Reconciliations** queue\nâ€¢ Sends reconciliation data securely using Bearer Auth\n\n**Inputs:**\nâ€¢ Prodege Project ID\nâ€¢ Successful Transaction IDs\nâ€¢ Reconciliation Note\n\n","height":608,"width":520},"type":"n8n-nodes-base.stickyNote","position":[-1872,-1152],"typeVersion":1,"id":"36be662a-b3c6-4ae7-987f-c647ea45c225","name":"Project Reconciliation Overview"},{"parameters":{"jsCode":"// Get all input items\nconst items = $input.all();\n\n// Group items by project ID AND line item ID combination\nconst itemMap = new Map();\n\nitems.forEach(inputItem => {\n  const item = inputItem.json;\n  let projectId;\n  let lineItemId;\n  let statusId = null;\n  let message = null;\n  \n  // Determine project ID from either PROJECTID field or signatureData.projectId\n  if (item.PROJECTID) {\n    projectId = item.PROJECTID.toString();\n  } else if (item.signatureData?.projectId) {\n    projectId = item.signatureData.projectId;\n  }\n  \n  // Get line item ID\n  lineItemId = item.id?.toString();\n  \n  // Create unique key combining project ID and line item ID\n  const uniqueKey = `${projectId}_${lineItemId}`;\n  \n  // If this item has a data field, parse the status information\n  if (item.data) {\n    try {\n      const parsed = JSON.parse(item.data);\n      statusId = parsed.return_status.status_id;\n      message = parsed.return_status.message[0]; // message is an array\n    } catch (error) {\n      console.log('Error parsing data field:', error);\n    }\n  }\n  \n  // Get existing item data or create new entry\n  if (itemMap.has(uniqueKey)) {\n    // Merge with existing item data (preserve all fields, update status if available)\n    const existing = itemMap.get(uniqueKey);\n    itemMap.set(uniqueKey, {\n      ...existing,\n      ...item,\n      // Preserve or update status info\n      statusId: statusId || existing.statusId,\n      message: message || existing.message,\n      // Ensure signatureData is preserved\n      signatureData: item.signatureData || existing.signatureData\n    });\n  } else {\n    // Create new item entry\n    itemMap.set(uniqueKey, {\n      ...item,\n      statusId,\n      message,\n      signatureData: item.signatureData || null\n    });\n  }\n});\n\n// Convert map back to array and log debug info\nconst mergedResults = Array.from(itemMap.values());\n\nconsole.log(`Total unique items after processing: ${mergedResults.length}`);\n\n// Group by project ID for logging\nconst projectGroups = {};\nmergedResults.forEach((item, index) => {\n  const projectId = item.PROJECTID || item.signatureData?.projectId;\n  if (!projectGroups[projectId]) {\n    projectGroups[projectId] = [];\n  }\n  projectGroups[projectId].push(item);\n  \n  console.log(`Item ${index + 1}:`);\n  console.log('  Project ID:', projectId);\n  console.log('  Line Item ID:', item.id);\n  console.log('  Has signatureData:', !!item.signatureData);\n  console.log('  StatusId:', item.statusId);\n  console.log('  Message:', item.message);\n  console.log('---');\n});\n\n// Log summary by project\nObject.keys(projectGroups).forEach(projectId => {\n  console.log(`Project ${projectId}: ${projectGroups[projectId].length} line items`);\n});\n\nreturn mergedResults.map(item => ({ json: item }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2464,48],"id":"af649b74-3999-47f3-b74a-c6ab8cefc86e","name":"StatusCode"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6c4aaab8-947a-431e-967d-a39cbf7c994a","leftValue":"={{ $json.data }}","rightValue":"1","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2960,48],"id":"32e37a6c-e29f-4920-a068-9b21c2e94dee","name":"If"},{"parameters":{"httpMethod":"POST","path":"5f9c967c-peeq-project-reconciliation-automation","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2928,-128],"id":"78877e92-47dd-4fae-9980-537e5ad823e7","name":"Webhook","webhookId":"5f9c967c-00c4-4993-a7ba-3023380e2f2f"},{"parameters":{"url":"=https://api.hubapi.com/crm/v4/objects/tickets/{{ $('Edit Fields').first().json.ticket_id }}/associations/deals","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Accept","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-368,-128],"id":"ddb32663-dea9-43ec-95b2-59e5a3691fe1","name":"GET Deal on Ticket","executeOnce":false,"credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://api.hubapi.com/files/v3/files/{{ $json.reconciliation_file }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2272,-128],"id":"71fcf8cb-5f33-4347-bb4a-66c5903429b7","name":"Get Reconciliation File ID","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://api.hubapi.com/filemanager/api/v3/files/{{ $json.id }}/signed-url","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{"redirect":{"redirect":{"maxRedirects":5}},"response":{"response":{"responseFormat":"text"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2080,-128],"id":"fd753cff-278c-4b12-8c7a-f8e4527acf6c","name":"Get Reconciliation File Signed URL","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"jsCode":"// Parse the JSON response and extract the URL\nconst responseData = JSON.parse($input.item.json.data);\nreturn {\n  signedUrl: responseData.url,\n  fileName: responseData.name,\n  fileSize: responseData.size\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1888,-128],"id":"0e3cb167-ad02-4c15-bdd6-e6c514df3aa7","name":"Break Out URL and Name"},{"parameters":{"url":"={{ $json.signedUrl }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{"redirect":{"redirect":{"maxRedirects":5}},"response":{"response":{"responseFormat":"text"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1712,-128],"id":"a8a833e3-3e2c-4547-8f9e-b8865a69d1b0","name":"Get File Data","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"jsCode":"// Get the CSV data\nconst csvData = $input.item.json.data;\n\n// Split into lines and process\nconst lines = csvData.split('\\n');\n\n// Extract TransactionIDs for comma-separated string (keep existing logic)\nconst transactionIds = lines\n  .slice(1) // Skip header row\n  .map(line => line.split(',')[0]) // Get first column (TransactionID)\n  .filter(id => id && id.trim() !== '') // Remove empty lines\n  .map(id => id.trim()); // Clean whitespace\n\n// Create transaction_rewards array from CSV data\nconst transactionRewards = lines\n  .slice(1) // Skip header row\n  .filter(line => line && line.trim() !== '') // Remove empty lines\n  .map(line => {\n    const columns = line.split(',');\n    \n    // Handle CPI column - only convert to number if not empty\n    let cpi;\n    const cpiValue = columns[1]?.trim();\n    if (cpiValue === '' || cpiValue === undefined) {\n      cpi = \"Empty\";\n    } else {\n      cpi = parseFloat(cpiValue) || 0;\n    }\n    \n    // Handle Reward column - only convert to number if not empty\n    let reward;\n    const rewardValue = columns[2]?.trim();\n    if (rewardValue === '' || rewardValue === undefined) {\n      reward = \"Empty\";\n    } else {\n      reward = parseFloat(rewardValue) || 0;\n    }\n    \n    return {\n      \"TransactionID\": parseInt(columns[0]?.trim()) || 0,\n      \"CPI\": cpi,\n      \"Reward\": reward\n    };\n  })\n  .filter(item => !isNaN(item.TransactionID) && item.TransactionID > 0); // Remove invalid entries\n\n// Return both formats\nreturn {\n  transactionIds: transactionIds.join(','), // Keep comma-separated string\n  transactionIdsArray: transactionIds, // Keep simple array\n  transaction_rewards: transactionRewards, // New API format\n  count: transactionIds.length\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,-128],"id":"01f958cc-e100-4c96-88b2-4998cc72d549","name":"Clean Data"},{"parameters":{"fieldToSplitOut":"results","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[0,-128],"id":"67f5b9c4-2401-4f5e-a06b-6a6c47e1d613","name":"Split Out3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eb427cf3-6717-4d57-826e-625ccfcfd93e","leftValue":"={{ $json.properties.billable_event }}","rightValue":"={{ $('Webhook').item.json.body.billable_event }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[832,-128],"id":"03f47c5b-31fa-4233-b1b0-6ce64f4e0904","name":"Match Line Item to Ticket"},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/deals/{{ $json.results[0].toObjectId }}/associations/line_items","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-160,-128],"id":"7ddf8bdc-ff7f-4298-b575-eb18fa721f16","name":"GET Line Items","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"properties","value":"group_id,offer_type,country,description,reconciliation_type,reconciliation_status,scrub_rate__line_item_,scrub_rate__billable_event_,billable_event,quantity,price,name"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[160,-128],"id":"4282724c-6072-4b3d-9736-18d13984d32a","name":"Get Line Items Details","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.properties.reconciliation_type }}","rightValue":"simple","operator":{"type":"string","operation":"contains"},"id":"ced71726-f1fc-42d9-b9de-063e6518d0ad"}],"combinator":"and"},"renameOutput":true,"outputKey":"Simple"},{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c01698e-f06e-4510-adce-f879eaa55014","leftValue":"={{ $json.properties.reconciliation_type }}","rightValue":"complex","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Complex"}]},"options":{"ignoreCase":true,"allMatchingOutputs":false}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1104,-144],"id":"a5ade583-24d0-4d03-b81a-20c9ee7710fe","name":"Switch"},{"parameters":{"operation":"executeQuery","query":"select projectid,  LISTAGG(clickid, ',') as clickids\n\nFROM \n\nOPS_AUTOMATION_DB.SURVEYS.PROJECT_COMPLETION pc\n--LEFT JOIN stage.surveys.PROJECT_COMPLETION_TYPE ct on ct.completiontypeid = pc.completiontype\n\nwhere clickid in ({{ $json.transactionIds }})\n\ngroup by 1"},"type":"n8n-nodes-base.snowflake","typeVersion":1,"position":[-1328,-128],"id":"70b73047-2567-4bf4-94b0-17eeceafcb86","name":"Snowflake","alwaysOutputData":false,"credentials":{"snowflake":{"id":"reIlyZhfAfZTYk8S","name":"Snowflake prodegeqa"}},"onError":"continueRegularOutput"},{"parameters":{"url":"=https://surveypmr.prodegeapisqa.com/prodegemr/project-get-info","authentication":"genericCredentialType","genericAuthType":"httpCustomAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"=request_date","value":"={{ $json.signatureData.request_date }}"},{"name":"prodege_project_id","value":"={{ $json.signatureData.projectId }}"},{"name":"signature","value":"={{ $json.signatureData.signature }}"}]},"sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}","options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3168,-176],"id":"5f4d5403-ffde-4a75-b9b0-fa5f705e77d1","name":"Get Project Status","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"},"httpCustomAuth":{"id":"K3SygLYbImTEQK8q","name":"peeqAPI Query Auth"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.status }}","rightValue":"COMPLETE","operator":{"type":"string","operation":"equals"},"id":"3df91b38-282a-426f-850b-2558bb9d5da2"}],"combinator":"and"},"renameOutput":true,"outputKey":"AUTO APPROVED"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0cbb38af-910f-48ea-ba60-a96932529995","leftValue":"={{ $json.status }}","rightValue":"PENDING_COMPLETE","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"PENDING APPROVAL"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[3536,-256],"id":"c577d9f2-0a1e-4df0-b422-8d9723f459f7","name":"Switch1"},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.properties.hs_object_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Auto Approved\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3936,-368],"id":"c992d3d7-f21c-4666-8e48-3eb37eac80ca","name":"Auto Approved Status","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Pending Approval\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4144,-176],"id":"d9290cf0-612c-4d6b-9246-0f2728679ca7","name":"Pending Approval Status","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://surveypmr.prodegeapisqa.com/prodegemr/project-get-info","authentication":"genericCredentialType","genericAuthType":"httpCustomAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"=request_date","value":"={{ $json.request_date }}"},{"name":"prodege_project_id","value":"={{ $json.project_id }}"},{"name":"signature","value":"={{ $json.signature }}"}]},"sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}","options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4896,-176],"id":"e7bf930a-6588-429d-80cb-f8b2d84a9532","name":"Get Project Status1","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"},"httpCustomAuth":{"id":"K3SygLYbImTEQK8q","name":"peeqAPI Query Auth"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.status }}","rightValue":"COMPLETE","operator":{"type":"string","operation":"equals"},"id":"3df91b38-282a-426f-850b-2558bb9d5da2"}],"combinator":"and"},"renameOutput":true,"outputKey":"MANAGER APPROVED"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"56a7fd1e-de4d-4e64-b962-1bcd8df25bbe","leftValue":"={{ $json.status }}","rightValue":"PAUSED","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"MANAGE REJECTED"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0cbb38af-910f-48ea-ba60-a96932529995","leftValue":"={{ $json.status }}","rightValue":"PENDING_COMPLETE","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"PENDING APPROVAL"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[5280,-192],"id":"cc69375c-961c-45de-9dfe-ee3b0ea45597","name":"Switch2"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[4336,-176],"id":"a58c3326-7e30-4aa5-bf6b-d8985baa21fb","name":"Wait 1 Day","webhookId":"ce563f87-34ca-452f-bd0a-396d369531ce"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// ===========================================\n// PEEQ API SIGNATURE GENERATOR (PRODUCTION)\n// ===========================================\n\n// Get current item's time offset data\nconst currentItemData = $input.item.json;\nlet timeOffset = 0;\n\ntry {\n  const timeOffsetResponse = JSON.parse(currentItemData.data);\n  timeOffset = timeOffsetResponse.request_time_offset || 0;\n  console.log('Time offset for this item:', timeOffset);\n} catch (e) {\n  console.error('Error parsing time offset data:', e.message);\n  timeOffset = 0;\n}\n\n// Get project data from Switch1 node (which has the project info)\nconst switch1Items = $('Switch1').all();\nconst currentSwitch1Item = switch1Items[$itemIndex];\n\nlet prodegeProjectId = null;\nlet projectInfo = null;\n\nif (currentSwitch1Item) {\n  try {\n    const switch1Data = JSON.parse(currentSwitch1Item.json.data);\n    if (switch1Data.project_info) {\n      projectInfo = switch1Data.project_info;\n      prodegeProjectId = projectInfo.prodege_project_id;\n      console.log('âœ… Found project info from Switch1');\n      console.log('ðŸŽ¯ Processing project ID:', prodegeProjectId);\n    }\n  } catch (e) {\n    console.error('Error parsing Switch1 data:', e.message);\n  }\n}\n\n// Fallback: try to get from signatureData if not found\nif (!prodegeProjectId && currentSwitch1Item?.json.signatureData) {\n  prodegeProjectId = currentSwitch1Item.json.signatureData.projectId;\n  console.log('ðŸ”„ Using fallback project ID from Switch1 signatureData:', prodegeProjectId);\n}\n\n// Get reconciliation note and transaction IDs from Switch1 item\nlet reconciliationNote = \"\";\nlet successfulTransactionIds = \"\";\n\nif (currentSwitch1Item?.json.signatureData) {\n  reconciliationNote = currentSwitch1Item.json.signatureData.reconciliation_note || \"\";\n  successfulTransactionIds = currentSwitch1Item.json.signatureData.successfulTransactionIds || \"\";\n} else {\n  // Final fallback to Edit Fields\n  const editFieldsItem = $('Edit Fields').first().json;\n  reconciliationNote = editFieldsItem.reconciliationNote || \"\";\n  successfulTransactionIds = editFieldsItem.successfulTransactionIds || \"\";\n}\n\nconsole.log('ðŸ“‹ Transaction IDs:', successfulTransactionIds);\n\n// Parse transaction IDs\nlet transactionIds = [];\nif (successfulTransactionIds) {\n  transactionIds = successfulTransactionIds\n    .split(',')\n    .map(id => parseInt(id.trim()))\n    .filter(id => !isNaN(id));\n}\n\n// ===========================================\n// ðŸ”“ DECRYPT KEYS (ONLY ENCRYPTED VALUES IN WORKFLOW)\n// ===========================================\n\nconst crypto = require('crypto');\n\n// Get encrypted data from Edit Fields node (keys are shared across all projects)\nconst editFieldsItem = $('Edit Fields').first().json;\nconst encryptedApiKey = editFieldsItem.encryptedApiKey;\nconst encryptedSecretKey = editFieldsItem.encryptedSecretKey; \nconst encryptionPassword = editFieldsItem.encryptionPassword;\n\n// Decryption function\nfunction decryptString(encryptedText, password) {\n  const algorithm = 'aes-256-cbc';\n  const key = crypto.scryptSync(password, 'salt', 32);\n  \n  const [ivHex, encrypted] = encryptedText.split(':');\n  const iv = Buffer.from(ivHex, 'hex');\n  \n  const decipher = crypto.createDecipheriv(algorithm, key, iv);\n  let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n  decrypted += decipher.final('utf8');\n  \n  return decrypted;\n}\n\n// ðŸ”“ Decrypt the keys at runtime\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('âœ… Keys decrypted successfully');\nconsole.log(`ðŸ”‘ API Key length: ${apiKey.length}`);\nconsole.log(`ðŸ—ï¸ Secret Key length: ${secretKey.length}`);\n\n// ===========================================\n// ðŸ” GENERATE SIGNATURE (PROJECT-SPECIFIC)\n// ===========================================\n\nif (!prodegeProjectId) {\n  throw new Error('âŒ No project ID found in Switch1 data or signatureData');\n}\n\nconst clientTime = Date.now();\nconst requestDate = clientTime + timeOffset;\n\nconst params = {\n  apik: apiKey,\n  request_date: requestDate,\n  prodege_project_id: prodegeProjectId,\n  successful_transaction_ids: transactionIds.join(','),\n  reconciliation_note: reconciliationNote\n};\n\nconst stringToSign = Object.keys(params)\n  .sort()\n  .map(key => `${key}=${params[key]}`)\n  .join(':');\n\nconst utf8Encoded = Buffer.from(`${secretKey}:${stringToSign}`, 'utf8');\nconst sha256Hash = crypto.createHash('sha256').update(utf8Encoded).digest();\nconst base64Encoded = sha256Hash.toString('base64');\n\nconst signature = base64Encoded\n  .replace(/\\+/g, '-')\n  .replace(/\\//g, '_')\n  .replace(/=/g, '');\n\nconsole.log('ðŸ” Signature generated successfully');\nconsole.log(`âœ… Using time offset: ${timeOffset} for project: ${prodegeProjectId}`);\nconsole.log(`ðŸ“Š Item index: ${$itemIndex}`);\n\nreturn {\n  json: {\n    // Preserve all original data\n    ...currentItemData,\n    // Add signature data\n    request_date: requestDate,\n    reconciliation_note: reconciliationNote,\n    signature: signature,\n    time_offset_used: timeOffset,\n    project_id: prodegeProjectId, // Include the specific project ID\n    // Keep project info if available\n    projectInfo: projectInfo\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4688,-176],"id":"b440391f-1d5b-48ce-8dff-fcff58c2449a","name":"Generate Signature1"},{"parameters":{"url":"=https://surveypmr.prodegeapisqa.com/prodegemr/lookup-request-time-offset?client_time={{ Date.now() }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4512,-176],"id":"2ffb72f8-c55d-4c7e-8eb4-e4ecdee0e908","name":"timeOffset1","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse the JSON string from the data field\nconst jsonData = JSON.parse($input.item.json.data);\nconst item = $input.item.json;\n\n// Get ALL data from the IF node (which contains the merged line item data from StatusCode)\nconst ifNodeData = $('If').first().json;\n\n// Extract the status from project_info  \nconst status = jsonData.project_info.status;\n\n// Log to debug\nconsole.log('Item has signatureData from IF node:', !!ifNodeData.signatureData);\nconsole.log('Project status:', status);\nconsole.log('IF node data keys:', Object.keys(ifNodeData));\n\n// Return the status while preserving ALL data from both sources\nreturn {\n  json: {\n    // Start with ALL the merged line item data from the IF node\n    ...ifNodeData,\n    // Override with current HTTP response data (headers, statusCode, etc.)\n    ...item,\n    // Add the extracted status\n    status: status,\n    // Ensure signatureData is preserved from IF node (in case it got overwritten)\n    signatureData: ifNodeData.signatureData || null\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3344,-256],"id":"566c261a-44c5-4ad8-8915-c08da1579889","name":"Clean Status"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse the JSON string from the data field\nconst jsonData = JSON.parse($input.item.json.data);\nconst item = $input.item.json;\n\n// Get ALL data from the IF node (which contains the merged line item data from StatusCode)\nconst ifNodeData = $('If').first().json;\n\n// Extract the status from project_info  \nconst status = jsonData.project_info.status;\n\n// Log to debug\nconsole.log('Item has signatureData from IF node:', !!ifNodeData.signatureData);\nconsole.log('Project status:', status);\nconsole.log('IF node data keys:', Object.keys(ifNodeData));\n\n// Return the status while preserving ALL data from both sources\nreturn {\n  json: {\n    // Start with ALL the merged line item data from the IF node\n    ...ifNodeData,\n    // Override with current HTTP response data (headers, statusCode, etc.)\n    ...item,\n    // Add the extracted status\n    status: status,\n    // Ensure signatureData is preserved from IF node (in case it got overwritten)\n    signatureData: ifNodeData.signatureData || null\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5088,-176],"id":"23497c5f-f0ff-4121-8328-5d78e91183a4","name":"Clean Status1"},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.properties.hs_object_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Manager Rejected\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2960,-640],"id":"d9c8e398-288d-463f-bbe7-6e258eaff8e2","name":"Manager Rejected","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.properties.hs_object_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Manager Rejected\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5600,-80],"id":"4fabfdd2-66a3-4d46-b975-7ace80c8bcad","name":"Manager Rejected1","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.properties.hs_object_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Manager Approved\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5600,-320],"id":"16e5dc85-d452-48fe-b74c-4412752f8ef4","name":"Manager Approved Status","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Get current Snowflake item (the one being processed in this iteration)\nconst snowflakeItem = $input.item.json;\n\n// Get transaction_rewards from the Clean Data node\nconst cleanDataNode = $('Clean Data').item.json;\nconst allTransactionRewards = cleanDataNode.transaction_rewards || [];\n\n// Get ticket_id from the First Variables node\nconst firstVariablesNode = $('First Variables').item.json;\nconst ticketId = firstVariablesNode.ticket_id;\n\n// Get the transaction IDs for this project\nconst projectTransactionIds = snowflakeItem.CLICKIDS.split(',').map(id => parseInt(id.trim()));\n\n// Filter transaction_rewards to only include this project's transactions\nconst filteredTransactionRewards = allTransactionRewards.filter(reward => \n  projectTransactionIds.includes(reward.TransactionID)\n);\n\nconst result = {\n  PROJECTID: snowflakeItem.PROJECTID,\n  successful_transaction_ids: snowflakeItem.CLICKIDS,\n  transaction_rewards: filteredTransactionRewards,\n  ticket_id: ticketId\n};\n\nconsole.log(`Project ${result.PROJECTID}: ${result.successful_transaction_ids}`);\nconsole.log(`Ticket ID: ${ticketId}`);\nconsole.log(`Filtered transaction rewards: ${filteredTransactionRewards.length}/${allTransactionRewards.length}`);\n\nreturn { json: result };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1120,-128],"id":"52bd363f-4bc6-4fa8-90c6-cc358f382aca","name":"Re-Clean Data"},{"parameters":{"assignments":{"assignments":[{"id":"e5571b33-60b1-42bb-adc1-cc5d7548f858","name":"ticket_id","value":"={{ $json.body.ticketId }}","type":"string"},{"id":"e6a81c1f-11c2-44f4-80a2-994f122fad54","name":"reconciliation_file","value":"={{ $json.body.reconciliation_file }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2432,-128],"id":"56e922f2-7321-4edf-8f4c-2bbcb0f00ff3","name":"First Variables"},{"parameters":{"method":"POST","url":"https://api-na1.hubapi.com/automation/v4/webhook-triggers/40213119/H7OXUX2","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"ticketId","value":"={{ $('Clean Status').first().json.signatureData.ticketId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4160,-368],"id":"882393a8-c499-45c9-80cc-dea42b67f6fa","name":"Assembly Webhook1","executeOnce":true,"credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"method":"POST","url":"https://api-na1.hubapi.com/automation/v4/webhook-triggers/40213119/H7OXUX2","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"ticketId","value":"={{ $('Clean Status1').first().json.signatureData.ticketId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5792,-320],"id":"ae445b43-8b96-4939-9db2-f0169ea1c391","name":"Assembly Webhook2","executeOnce":true,"credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"af8c5301-4709-4dae-9d82-4c25eb6e8607","leftValue":"={{ $json.properties.name }}","rightValue":"Sample","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[624,-128],"id":"07ffad07-cb70-49b8-a920-4a4ebde0610a","name":"Filter"},{"parameters":{"jsCode":"// ===========================================\n// ðŸ”„ Remove Duplicates + Add Signature Data\n// ===========================================\n\nconst currentItems = $input.all();\n\n// Try to get signature data directly from Generate Signature node\nlet generateSignatureData = [];\ntry {\n  generateSignatureData = $('Generate Signature').all();\n  console.log('âœ… Successfully accessed Generate Signature node');\n} catch (error) {\n  console.log('âŒ Could not access Generate Signature node:', error.message);\n  // Try alternative node name in case of exact name mismatch\n  try {\n    generateSignatureData = $('Generate Signature').all();\n    console.log('âœ… Found Generate Signature with alternative access');\n  } catch (error2) {\n    console.log('âŒ Still could not access Generate Signature node');\n  }\n}\n\nconsole.log('Current items count:', currentItems.length);\nconsole.log('Generate Signature items count:', generateSignatureData.length);\nconsole.log('Available project IDs:', generateSignatureData.map(sig => sig.json?.projectId || 'undefined'));\n\n// ===========================================\n// ðŸ§¹ Remove Duplicates (based on line item ID)\n// ===========================================\nconst uniqueItems = [];\nconst seenIds = new Set();\n\ncurrentItems.forEach(item => {\n  const itemId = item.json.id;\n  if (!seenIds.has(itemId)) {\n    seenIds.add(itemId);\n    uniqueItems.push(item);\n  }\n});\n\nconsole.log('Unique items count after deduplication:', uniqueItems.length);\n\n// ===========================================\n// ðŸ”— Add Signature Data to Each Item\n// ===========================================\nconst processedItems = [];\n\nuniqueItems.forEach((item, itemIndex) => {\n  const lineItem = item.json;\n  const billableEvent = lineItem.properties?.billable_event;\n  \n  // Simple approach: distribute signatures evenly across all unique items\n  let matchingSignature = null;\n  if (generateSignatureData.length > 0) {\n    // Use modulo to cycle through available signatures\n    const signatureIndex = itemIndex % generateSignatureData.length;\n    matchingSignature = generateSignatureData[signatureIndex]?.json;\n  }\n  \n  console.log(`Line item ${lineItem.id}: billable_event=${billableEvent}, assigned projectId=${matchingSignature?.projectId || 'none'}`);\n  \n  processedItems.push({\n    json: {\n      ...lineItem,\n      signatureData: matchingSignature || null,\n      properties: lineItem.properties,\n      id: lineItem.id\n    }\n  });\n});\n\nconsole.log('Final processed items:', processedItems.length);\nconsole.log('Items with signatures:', processedItems.filter(item => !!item.json.signatureData).length);\nconsole.log('Signature distribution:', processedItems.map(item => item.json.signatureData?.projectId || 'no-signature'));\n\nreturn processedItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,-128],"id":"49cbb317-72ad-46fe-89b0-0bdd5b33fd13","name":"De-Dup & Add Sig Back"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// ===========================================\n// ðŸ”— Merge HTTP Response with Switch Node Data\n// ===========================================\n\nconst httpResponse = $input.item.json;\nconst switchItems = $('Switch').all();\n\n// Find the matching item from the Switch node for this response\n// Since HTTP requests maintain item order, we can use $itemIndex\nconst switchItem = switchItems[$itemIndex];\n\nconsole.log('HTTP Response:', httpResponse);\nconsole.log('Switch item has signatureData:', !!switchItem?.json.signatureData);\nconsole.log('Project ID from signature:', switchItem?.json.signatureData?.projectId);\nconsole.log('Reconciliation type:', switchItem?.json.properties?.reconciliation_type);\n\nreturn {\n  json: {\n    // HTTP response data\n    ...httpResponse,\n    // Switch node data (including reconciliation info and signatureData)\n    ...switchItem?.json,\n    // Ensure signatureData is preserved\n    signatureData: switchItem?.json.signatureData || null,\n    // Ensure reconciliation info is preserved\n    properties: {\n      ...switchItem?.json.properties,\n      // Preserve any HTTP response properties if they exist\n      ...httpResponse.properties\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1712,-288],"id":"4112326c-f84b-4be4-9cc8-c6bba5a9038a","name":"Merge Reco and Info"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// ===========================================\n// ðŸ”— Merge HTTP Response with Switch Node Data\n// ===========================================\n\nconst httpResponse = $input.item.json;\nconst switchItems = $('Switch').all();\n\n// Find the matching item from the Switch node for this response\n// Since HTTP requests maintain item order, we can use $itemIndex\nconst switchItem = switchItems[$itemIndex];\n\nconsole.log('HTTP Response:', httpResponse);\nconsole.log('Switch item has signatureData:', !!switchItem?.json.signatureData);\nconsole.log('Project ID from signature:', switchItem?.json.signatureData?.projectId);\nconsole.log('Reconciliation type:', switchItem?.json.properties?.reconciliation_type);\n\nreturn {\n  json: {\n    // HTTP response data\n    ...httpResponse,\n    // Switch node data (including reconciliation info and signatureData)\n    ...switchItem?.json,\n    // Ensure signatureData is preserved\n    signatureData: switchItem?.json.signatureData || null,\n    // Ensure reconciliation info is preserved\n    properties: {\n      ...switchItem?.json.properties,\n      // Preserve any HTTP response properties if they exist\n      ...httpResponse.properties\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1712,0],"id":"f75feffa-229b-43f9-a14e-a4b7c0d6af9b","name":"Merge Reco and Info1"},{"parameters":{"httpMethod":"POST","path":"656f3ebe-e94d-47f6-8db3-18130bd3c93b","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[96,-896],"id":"21753257-a149-43d5-8e47-ad6d60addb76","name":"Webhook1","webhookId":"656f3ebe-e94d-47f6-8db3-18130bd3c93b","disabled":true},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/tickets/{{ $('First Variables').item.json.ticket_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"associations","value":"deals"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-432,416],"id":"3e9502b8-2955-408a-9d2b-799c1216d2f4","name":"HTTP Request: get dealid","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"operation":"executeQuery","query":"SELECT *, \nFROM OPS_AUTOMATION_DB.SURVEYS.NETSUITE_LINE_PROJECT_MAP\nWHERE projectid in ({{ $json.PROJECTID }})"},"type":"n8n-nodes-base.snowflake","typeVersion":1,"position":[-1072,320],"id":"837df6bd-fb15-475e-8be8-41848e66a87d","name":"NetSuitelLineItem","alwaysOutputData":true,"credentials":{"snowflake":{"id":"reIlyZhfAfZTYk8S","name":"Snowflake prodegeqa"}}},{"parameters":{"jsCode":"// Extract line item IDs from the response\nconst lineItemIds = $input.all()[0].json.results.map(result => result.id);\n\nif (lineItemIds.length === 0) {\n  console.log(\"No line items found for this deal\");\n  return [{ success: true, message: \"No line items to delete\", lineItemId: null }];\n}\n\n// Return each line item ID as a separate object\nreturn lineItemIds.map(id => ({\n  success: true,\n  lineItemId: id\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[0,416],"id":"b811f0dd-445c-4be4-9dc7-d0efa3d111cd","name":"cleanLineItems"},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.lineItemId }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"properties","value":"netsuite_line_id, line_,billable_event,name"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[208,416],"id":"452e62d2-f5fb-4ae8-adb6-c0937b3bdb2c","name":"HTTP Get NS_line_item values","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/deals/{{ $json.associations.deals.results[0].id }}/associations/line_items","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-224,416],"id":"5cf7baac-5cf3-4a17-a6e8-efb9449ae46f","name":"HTTP Get HS_line_items","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"mode":"combine","advanced":true,"mergeByFields":{"values":[{"field1":"NETSUITELINEITEMID","field2":"properties.netsuite_line_id"}]},"joinMode":"keepEverything","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[880,288],"id":"a9210332-9d19-42fa-867a-7d1ba24d43fe","name":"Merge"},{"parameters":{"assignments":{"assignments":[{"id":"eb44415f-38ce-443a-825e-f33259bd253d","name":"id","value":"={{ $json.id }}","type":"number"},{"id":"de93b522-c788-4912-84b5-1beed514030b","name":"properties.billable_event","value":"={{ $json.properties.billable_event }}","type":"number"},{"id":"0962daf0-323c-4b75-98e9-112be4770740","name":"properties.createdate","value":"={{ $json.properties.createdate }}","type":"string"},{"id":"456735ec-fbc4-49df-931b-dcd268d3a8af","name":"properties.hs_lastmodifieddate","value":"={{ $json.properties.hs_lastmodifieddate }}","type":"string"},{"id":"7245531e-e0b8-402c-a017-09c1aa0ca5ac","name":"properties.hs_object_id","value":"={{ $json.properties.hs_object_id }}","type":"number"},{"id":"6d3aa425-b37c-4e47-9b1a-eeaad8b1a81e","name":"properties.line_","value":"={{ $json.properties.line_ }}","type":"number"},{"id":"1c302186-cff9-4528-b0d4-4da71562a212","name":"properties.name","value":"={{ $json.properties.name }}","type":"string"},{"id":"da327cc9-f660-478b-96e6-2653bbe4132d","name":"properties.netsuite_line_id","value":"={{ $json.properties.netsuite_line_id }}","type":"number"},{"id":"4725cb2c-8cc8-4ebf-bacc-ec641f7c7321","name":"createdAt","value":"={{ $json.createdAt }}","type":"string"},{"id":"088e93fc-73b5-4119-bb97-bcb7718e4e17","name":"updatedAt","value":"={{ $json.updatedAt }}","type":"string"},{"id":"ed4aec6d-fe31-4536-8300-7cf7187e2804","name":"archived","value":"={{ $json.archived }}","type":"boolean"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[640,416],"id":"faab9f13-2544-4501-834d-2ed754e2926f","name":"cleanJSON"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"83046a82-dc51-458a-8c2f-b7cb9b418cf6","leftValue":"={{ $json.properties.billable_event }}","rightValue":"={{ $('Webhook').first().json.body.billable_event }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"dcccfcf7-f2d6-4c60-b741-133039f73d56","leftValue":"={{ $json.properties.name }}","rightValue":"Sample","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[432,416],"id":"6aa88dbb-a93b-45b0-aeab-329971a51451","name":"Filter1"},{"parameters":{"method":"POST","url":"=https://surveypmr.prodegeapisqa.com/prodegemr/project-reconciliation-final","authentication":"genericCredentialType","genericAuthType":"httpCustomAuth","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/x-www-form-urlencoded\",\n  \"Accept\": \"application/x-www-form-urlencoded\"\n}","sendBody":true,"bodyParameters":{"parameters":[{"name":"request_date","value":"={{ $json.signatureData.request_date }}"},{"name":"prodege_project_id","value":"={{ $json.signatureData.projectId }}"},{"name":"reconciliation_note","value":"={{ $json.signatureData.reconciliation_note }}"},{"name":"signature","value":"={{ $json.signatureData.signature }}"},{"name":"successful_transaction_ids","value":"={{ $json.signatureData.successfulTransactionIds }}"},{"name":"transaction_rewards","value":"={{ $json.signatureData.transactionRewards }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1440,64],"id":"3230558e-62ce-4310-89a4-24fcb11a788e","name":"Complex Reconciliation2","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"},"httpCustomAuth":{"id":"K3SygLYbImTEQK8q","name":"peeqAPI Query Auth"}}},{"parameters":{"method":"POST","url":"=https://surveypmr.prodegeapisqa.com/prodegemr/project-reconciliation-final","authentication":"genericCredentialType","genericAuthType":"httpCustomAuth","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/x-www-form-urlencoded\",\n  \"Accept\": \"application/x-www-form-urlencoded\"\n}","sendBody":true,"bodyParameters":{"parameters":[{"name":"request_date","value":"={{ $json.signatureData.request_date }}"},{"name":"prodege_project_id","value":"={{ $json.signatureData.projectId }}"},{"name":"reconciliation_note","value":"={{ $json.signatureData.reconciliation_note }}"},{"name":"signature","value":"={{ $json.signatureData.signature }}"},{"name":"successful_transaction_ids","value":"={{ $json.signatureData.successfulTransactionIds }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1440,-240],"id":"8e2b8b01-11bf-4a80-b64e-ed0c79b158dd","name":"Simple Reconciliation1","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"},"httpCustomAuth":{"id":"K3SygLYbImTEQK8q","name":"peeqAPI Query Auth"}}},{"parameters":{"jsCode":"// Process each item and ensure the field is added to ALL items\nconst items = $input.all();\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  \n  // Check if NETSUITELINEITEMID exists and is not null\n  const hasLineItemId = item.json.NETSUITELINEITEMID != null;\n  \n  // Check if properties.netsuite_line_id exists and is not null\n  const hasLineId = item.json.properties?.netsuite_line_id != null;\n  \n  // Add the boolean field to EVERY item\n  item.json.matching_netsuite_ids = hasLineItemId && hasLineId;\n}\n\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1184,304],"id":"639d2ae0-2d5e-429e-b0e1-ef71a2226bf3","name":"lineItemIdMatch"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2224,32],"id":"29a53b0e-a8f5-4c95-9c42-4e3cba747b93","name":"Merge1"},{"parameters":{"operation":"executeQuery","query":"select  revenue ,count(clickid)\n\nFROM \n\nOPS_AUTOMATION_DB.SURVEYS.PROJECT_CLICK pc\n--LEFT JOIN stage.surveys.PROJECT_COMPLETION_TYPE ct on ct.completiontypeid = pc.completiontype\n\nwhere clickid in ({{ $json.signatureData.successfulTransactionIds }})\n\ngroup by 1"},"type":"n8n-nodes-base.snowflake","typeVersion":1,"position":[1408,-464],"id":"354b9978-8e32-4382-989a-49b8df21d0bf","name":"Snowflake1","alwaysOutputData":false,"executeOnce":false,"credentials":{"snowflake":{"id":"reIlyZhfAfZTYk8S","name":"Snowflake prodegeqa"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"55fe6939-3050-41b0-9425-e95f2ab18546","leftValue":"={{ $json.signatureData.transactionRewards.some(item => item.CPI > 0 || item.Reward > 0) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[208,-1088],"id":"cf97f633-00f0-4be7-b264-1cf5dd31865e","name":"If1","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"01a8e83d-7997-45c4-9d44-df1eb221258f","leftValue":"={{ $json.allMatched.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2032,-592],"id":"7ecfae7a-7f5b-426b-9169-df99d769ded0","name":"If2"},{"parameters":{"errorMessage":"Not all CPIS/Rewards an Quantities Matched Between Peeq/Client and Hubspot."},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[2304,-688],"id":"33b314d6-e984-42dd-8260-54d60be26504","name":"Stop and Error"},{"parameters":{"jsCode":"// Get transaction data from current input\nconst transactionItems = $input.all();\n\n// Get HubSpot data from Switch3 node\nlet hubspotData = [];\ntry {\n  const hubspotItems = $('Switch3').all();\n  hubspotData = hubspotItems.map(item => ({\n    id: item.json.id,\n    price: parseFloat(item.json.properties.price) || 0,\n    quantity: parseInt(item.json.properties.quantity) || 0\n  }));\n} catch (error) {\n  return {\n    json: {\n      error: 'Could not access HubSpot data from Switch3',\n      allMatched: false,\n      message: error.message\n    }\n  };\n}\n\n// Process transaction data to get CPI counts\nconst transactionData = [];\ntransactionItems.forEach((item, index) => {\n  try {\n    // Parse the transaction_rewards JSON string\n    const transactionRewards = JSON.parse(item.json.transaction_rewards);\n    \n    // Count transactions by CPI value\n    const cpiCounts = {};\n    transactionRewards.forEach(transaction => {\n      const cpi = transaction.CPI;\n      cpiCounts[cpi] = (cpiCounts[cpi] || 0) + 1;\n    });\n    \n    // Convert to array format for easier matching\n    Object.keys(cpiCounts).forEach(cpiValue => {\n      transactionData.push({\n        cpi: parseFloat(cpiValue),\n        count: cpiCounts[cpiValue]\n      });\n    });\n    \n    console.log(`Transaction Item ${index + 1} - CPI Counts:`, cpiCounts);\n  } catch (error) {\n    console.error(`Error parsing transaction_rewards for item ${index + 1}:`, error);\n  }\n});\n\nconsole.log('HubSpot Data:', hubspotData);\nconsole.log('Transaction Data (CPI/Count pairs):', transactionData);\n\n// Match HubSpot line items with transaction CPI data\nconst matches = [];\nconst unmatchedHubspot = [];\nconst unmatchedTransactions = [...transactionData]; // Copy to track unmatched\n\nhubspotData.forEach(hubspotItem => {\n  // Skip items with zero quantity (not billable)\n  if (hubspotItem.quantity === 0) {\n    console.log(`Skipping HubSpot item ${hubspotItem.id} - zero quantity`);\n    return;\n  }\n\n  let foundMatch = false;\n  \n  // Look for matching transaction data\n  for (let i = 0; i < unmatchedTransactions.length; i++) {\n    const transactionItem = unmatchedTransactions[i];\n    \n    if (hubspotItem.price === transactionItem.cpi && \n        hubspotItem.quantity === transactionItem.count) {\n      \n      matches.push({\n        hubspotId: hubspotItem.id,\n        hubspotPrice: hubspotItem.price,\n        hubspotQuantity: hubspotItem.quantity,\n        transactionCpi: transactionItem.cpi,\n        transactionCount: transactionItem.count\n      });\n      \n      // Remove from unmatched list\n      unmatchedTransactions.splice(i, 1);\n      foundMatch = true;\n      console.log(`âœ… Match found! HubSpot ID: ${hubspotItem.id}, Price: ${hubspotItem.price}, Qty: ${hubspotItem.quantity} matches CPI: ${transactionItem.cpi}, Count: ${transactionItem.count}`);\n      break;\n    }\n  }\n  \n  if (!foundMatch) {\n    unmatchedHubspot.push(hubspotItem);\n    console.log(`âŒ No match for HubSpot ID: ${hubspotItem.id}, Price: ${hubspotItem.price}, Qty: ${hubspotItem.quantity}`);\n  }\n});\n\n// Calculate totals for validation\nconst hubspotTotal = hubspotData.reduce((sum, item) => sum + (item.quantity * item.price), 0);\nconst transactionTotal = transactionData.reduce((sum, item) => sum + (item.count * item.cpi), 0);\n\nconst allMatched = unmatchedHubspot.length === 0 && unmatchedTransactions.length === 0;\n\n// Log unmatched items for debugging\nif (unmatchedTransactions.length > 0) {\n  console.log('âŒ Unmatched Transaction Data:', unmatchedTransactions);\n}\n\nconsole.log(`ðŸ“Š Summary - HubSpot items: ${hubspotData.length}, Transaction groups: ${transactionData.length}, Matches: ${matches.length}`);\nconsole.log(`ðŸ’° Revenue check - HubSpot total: ${hubspotTotal}, Transaction total: ${transactionTotal}`);\n\n// Return comprehensive results\nreturn {\n  json: {\n    reconciliationType: \"CPI Transaction Matching\",\n    allMatched: allMatched,\n    revenueMatched: hubspotTotal === transactionTotal,\n    summary: {\n      hubspotItems: hubspotData.length,\n      transactionGroups: transactionData.length,\n      matchedPairs: matches.length,\n      unmatchedHubspot: unmatchedHubspot.length,\n      unmatchedTransactions: unmatchedTransactions.length\n    },\n    financial: {\n      hubspotTotalRevenue: hubspotTotal,\n      transactionTotalRevenue: transactionTotal,\n      revenueDifference: hubspotTotal - transactionTotal\n    },\n    details: {\n      matches: matches,\n      unmatchedHubspotItems: unmatchedHubspot,\n      unmatchedTransactionItems: unmatchedTransactions,\n      hubspotData: hubspotData,\n      transactionData: transactionData\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1536,-1008],"id":"927a4694-670c-41ed-bfd8-e4eeec0f75df","name":"For Complex"},{"parameters":{"jsCode":"// Get Snowflake data from current input\nconst snowflakeItems = $input.all();\n\n// Get HubSpot data from Switch3 node (which contains the line items)\nlet hubspotData = [];\ntry {\n  const hubspotItems = $('Switch3').all();\n  hubspotData = hubspotItems.map(item => ({\n    id: item.json.id,\n    price: parseFloat(item.json.properties.price) || 0,\n    quantity: parseInt(item.json.properties.quantity) || 0\n  }));\n} catch (error) {\n  return {\n    json: {\n      error: 'Could not access HubSpot data from Switch3',\n      allMatched: false,\n      message: error.message\n    }\n  };\n}\n\n// Transform Snowflake data (rename columns to match expected structure)\nconst snowflakeData = snowflakeItems.map(item => ({\n  revenue: item.json.REVENUE || 0,\n  count: item.json[\"COUNT(CLICKID)\"] || 0\n}));\n\nconsole.log('HubSpot Data:', hubspotData);\nconsole.log('Snowflake Data:', snowflakeData);\n\n// For \"Full Simple\" reconciliation, we need to match:\n// - HubSpot line item quantities with Snowflake count\n// - HubSpot line item prices with Snowflake revenue\nconst matches = [];\nconst unmatchedHubspot = [];\nconst unmatchedSnowflake = [...snowflakeData]; // Copy to track unmatched\n\nhubspotData.forEach(hubspotItem => {\n  // Skip items with zero quantity (not billable)\n  if (hubspotItem.quantity === 0) {\n    console.log(`Skipping HubSpot item ${hubspotItem.id} - zero quantity`);\n    return;\n  }\n\n  let foundMatch = false;\n  \n  // Look for matching Snowflake data\n  for (let i = 0; i < unmatchedSnowflake.length; i++) {\n    const snowflakeItem = unmatchedSnowflake[i];\n    \n    if (hubspotItem.quantity === snowflakeItem.count && \n        hubspotItem.price === snowflakeItem.revenue) {\n      \n      matches.push({\n        hubspotId: hubspotItem.id,\n        quantity: hubspotItem.quantity,\n        price: hubspotItem.price,\n        snowflakeCount: snowflakeItem.count,\n        snowflakeRevenue: snowflakeItem.revenue\n      });\n      \n      // Remove from unmatched list\n      unmatchedSnowflake.splice(i, 1);\n      foundMatch = true;\n      console.log(`âœ… Match found! HubSpot ID: ${hubspotItem.id}, Qty: ${hubspotItem.quantity}, Price: ${hubspotItem.price}`);\n      break;\n    }\n  }\n  \n  if (!foundMatch) {\n    unmatchedHubspot.push(hubspotItem);\n    console.log(`âŒ No match for HubSpot ID: ${hubspotItem.id}, Qty: ${hubspotItem.quantity}, Price: ${hubspotItem.price}`);\n  }\n});\n\n// Calculate totals for validation\nconst hubspotTotal = hubspotData.reduce((sum, item) => sum + (item.quantity * item.price), 0);\nconst snowflakeTotal = snowflakeData.reduce((sum, item) => sum + (item.count * item.revenue), 0);\n\nconst allMatched = unmatchedHubspot.length === 0 && unmatchedSnowflake.length === 0;\n\nconsole.log(`ðŸ“Š Summary - Total HubSpot items: ${hubspotData.length}, Matched: ${matches.length}, Unmatched: ${unmatchedHubspot.length}`);\nconsole.log(`ðŸ’° Revenue check - HubSpot total: ${hubspotTotal}, Snowflake total: ${snowflakeTotal}`);\n\n// Return comprehensive results\nreturn {\n  json: {\n    reconciliationType: \"Full Simple\",\n    allMatched: allMatched,\n    revenueMatched: hubspotTotal === snowflakeTotal,\n    summary: {\n      hubspotItems: hubspotData.length,\n      snowflakeItems: snowflakeData.length,\n      matchedPairs: matches.length,\n      unmatchedHubspot: unmatchedHubspot.length,\n      unmatchedSnowflake: unmatchedSnowflake.length\n    },\n    financial: {\n      hubspotTotalRevenue: hubspotTotal,\n      snowflakeTotalRevenue: snowflakeTotal,\n      revenueDifference: hubspotTotal - snowflakeTotal\n    },\n    details: {\n      matches: matches,\n      unmatchedHubspotItems: unmatchedHubspot,\n      unmatchedSnowflakeItems: unmatchedSnowflake,\n      hubspotData: hubspotData,\n      snowflakeData: snowflakeData\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1632,-464],"id":"bcc971a2-1bbe-43da-912c-a5ca3f65aabd","name":"For Simple"},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Manager Rejected\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[352,-912],"id":"1c5dae2d-c0ac-46c2-ab1e-1783d99bc870","name":"put line item","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}},"disabled":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.signatureData.transactionRewards.every(item => item.CPI !== \"Empty\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"1b7c538d-35aa-42bd-b633-6c6f7148abd1"}],"combinator":"and"},"renameOutput":true,"outputKey":"Full Complex"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"709bb8a7-6116-4f3d-acdd-5739e33c6dd2","leftValue":"={{ $json.signatureData.transactionRewards.some(item => item.CPI === \"Empty\") && !$json.signatureData.transactionRewards.every(item => item.CPI === \"Empty\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Simple & Complex"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"875cf252-a728-4f4f-b60b-da9e887154fa","leftValue":"={{ $json.signatureData.transactionRewards.every(item => item.CPI === \"Empty\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Full Simple"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[752,-624],"id":"e7838b73-95cd-4d8f-9381-3263002cd2bf","name":"Switch3"},{"parameters":{"operation":"executeQuery","query":"select  revenue ,clickid\n\nFROM \n\nOPS_AUTOMATION_DB.SURVEYS.PROJECT_COMPLETION pc\n--LEFT JOIN stage.surveys.PROJECT_COMPLETION_TYPE ct on ct.completiontypeid = pc.completiontype\n\nwhere clickid in ({{ $json.simple_transactions }})\n\n--group by 1"},"type":"n8n-nodes-base.snowflake","typeVersion":1,"position":[1344,-688],"id":"8501228c-282b-443e-8926-675401cfabac","name":"Snowflake2","alwaysOutputData":false,"credentials":{"snowflake":{"id":"reIlyZhfAfZTYk8S","name":"Snowflake prodegeqa"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"n8n-nodes-base.removeDuplicates","typeVersion":2,"position":[1248,-464],"id":"200ae295-5486-49cb-82a9-d1788755e658","name":"Remove Duplicates"},{"parameters":{"options":{}},"type":"n8n-nodes-base.removeDuplicates","typeVersion":2,"position":[1296,-1008],"id":"f6251947-896b-445c-bcd2-0eaa4d337859","name":"Remove Duplicates1"},{"parameters":{"assignments":{"assignments":[{"id":"840dfb9f-4086-4d87-8768-ea08791eca36","name":"transaction_rewards","value":"={{ $json.signatureData.transactionRewards }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1072,-960],"id":"8630d04d-789d-4315-9d4e-716a065f4c4e","name":"set_trans_rewards"},{"parameters":{"assignments":{"assignments":[{"id":"00cdd0c6-3c96-4239-adcf-ee2301ba8126","name":"signatureData.successfulTransactionIds","value":"={{ $json.signatureData.successfulTransactionIds }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1072,-464],"id":"6e739485-57aa-4fdf-9acb-c3f2d1651135","name":"set_trans"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eb427cf3-6717-4d57-826e-625ccfcfd93e","leftValue":"={{ $json.properties.billable_event }}","rightValue":"={{ $('Webhook').item.json.body.billable_event }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"02e55a39-190d-489a-a412-897332f39a17","leftValue":"={{ $json.properties.name }}","rightValue":"Sample","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[544,-368],"id":"e86e20ac-d526-4b13-ab3f-b6d8d15a8fb2","name":"Match Line Item to Ticket1"},{"parameters":{"jsCode":"// Get all input items\nconst items = $input.all();\n\n// Process each item\nconst results = [];\n\nitems.forEach((inputItem, index) => {\n  const item = inputItem.json;\n  const transactionRewards = item.signatureData.transactionRewards || [];\n  \n  console.log(`Processing item ${index + 1}, Project ID: ${item.signatureData.projectId}`);\n  console.log(`Total transactions: ${transactionRewards.length}`);\n  \n  // Separate transactions by CPI status\n  const complexTransactions = [];\n  const simpleTransactionIds = [];\n  \n  transactionRewards.forEach(transaction => {\n    if (transaction.CPI !== \"Empty\" && transaction.CPI !== null && transaction.CPI !== undefined) {\n      // Non-empty CPI - add to complex transactions\n      complexTransactions.push({\n        TransactionID: transaction.TransactionID,\n        CPI: transaction.CPI,\n        Reward: transaction.Reward\n      });\n      console.log(`  Complex transaction: ${transaction.TransactionID} (CPI: ${transaction.CPI})`);\n    } else {\n      // Empty CPI - add transaction ID to simple list\n      simpleTransactionIds.push(transaction.TransactionID);\n      console.log(`  Simple transaction: ${transaction.TransactionID} (CPI: Empty)`);\n    }\n  });\n  \n  // Create the output structure\n  const result = {};\n  \n  // Add complex transactions as JSON string if any exist\n  if (complexTransactions.length > 0) {\n    result.complex_transactions = JSON.stringify(complexTransactions);\n    console.log(`  Created complex_transactions with ${complexTransactions.length} transactions`);\n  }\n  \n  // Add simple transaction IDs as comma-separated string if any exist\n  if (simpleTransactionIds.length > 0) {\n    result.simple_transactions = simpleTransactionIds.join(',');\n    console.log(`  Created simple_transactions with ${simpleTransactionIds.length} transaction IDs`);\n  }\n  \n  // Only add result if there are transactions to process\n  if (Object.keys(result).length > 0) {\n    results.push(result);\n  }\n  \n  console.log(`  Result for item ${index + 1}:`, result);\n});\n\nconsole.log(`\\nTotal results created: ${results.length}`);\n\n// Return results in the expected format\nreturn results.map(result => ({ json: result }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[992,-688],"id":"22fd7901-77bd-4ffd-9051-5ec4c34f15f7","name":"Seperate Complex and Simple"},{"parameters":{"assignments":{"assignments":[{"id":"840dfb9f-4086-4d87-8768-ea08791eca36","name":"complex_transactions","value":"={{ $json.complex_transactions }}","type":"string"},{"id":"ef5f052c-7014-42d7-8936-041325e13ee5","name":"simple_transactions","value":"={{ $json.simple_transactions }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1168,-688],"id":"06a48ed6-5702-4dd9-97f8-2ca8fa6a6fa9","name":"Set CPIS"},{"parameters":{"jsCode":"// Get transaction data from current input\nconst transactionItems = $input.all();\n\n// Get HubSpot data from Switch3 node\nlet hubspotData = [];\ntry {\n  const hubspotItems = $('Switch3').all();\n  hubspotData = hubspotItems.map(item => ({\n    id: item.json.id,\n    price: parseFloat(item.json.properties.price) || 0,\n    quantity: parseInt(item.json.properties.quantity) || 0\n  }));\n} catch (error) {\n  return {\n    json: {\n      error: 'Could not access HubSpot data from Switch3',\n      allMatched: false,\n      message: error.message\n    }\n  };\n}\n\n// Process transaction data to get CPI counts\nconst transactionData = [];\ntransactionItems.forEach((item, index) => {\n  try {\n    // Parse the transaction_rewards JSON string\n    const transactionRewards = JSON.parse(item.json.transaction_rewards);\n    \n    // Count transactions by CPI value\n    const cpiCounts = {};\n    transactionRewards.forEach(transaction => {\n      const cpi = transaction.CPI;\n      cpiCounts[cpi] = (cpiCounts[cpi] || 0) + 1;\n    });\n    \n    // Convert to array format for easier matching\n    Object.keys(cpiCounts).forEach(cpiValue => {\n      transactionData.push({\n        cpi: parseFloat(cpiValue),\n        count: cpiCounts[cpiValue]\n      });\n    });\n    \n    console.log(`Transaction Item ${index + 1} - CPI Counts:`, cpiCounts);\n  } catch (error) {\n    console.error(`Error parsing transaction_rewards for item ${index + 1}:`, error);\n  }\n});\n\nconsole.log('HubSpot Data:', hubspotData);\nconsole.log('Transaction Data (CPI/Count pairs):', transactionData);\n\n// Match HubSpot line items with transaction CPI data\nconst matches = [];\nconst unmatchedHubspot = [];\nconst unmatchedTransactions = [...transactionData]; // Copy to track unmatched\n\nhubspotData.forEach(hubspotItem => {\n  // Skip items with zero quantity (not billable)\n  if (hubspotItem.quantity === 0) {\n    console.log(`Skipping HubSpot item ${hubspotItem.id} - zero quantity`);\n    return;\n  }\n\n  let foundMatch = false;\n  \n  // Look for matching transaction data\n  for (let i = 0; i < unmatchedTransactions.length; i++) {\n    const transactionItem = unmatchedTransactions[i];\n    \n    if (hubspotItem.price === transactionItem.cpi && \n        hubspotItem.quantity === transactionItem.count) {\n      \n      matches.push({\n        hubspotId: hubspotItem.id,\n        hubspotPrice: hubspotItem.price,\n        hubspotQuantity: hubspotItem.quantity,\n        transactionCpi: transactionItem.cpi,\n        transactionCount: transactionItem.count\n      });\n      \n      // Remove from unmatched list\n      unmatchedTransactions.splice(i, 1);\n      foundMatch = true;\n      console.log(`âœ… Match found! HubSpot ID: ${hubspotItem.id}, Price: ${hubspotItem.price}, Qty: ${hubspotItem.quantity} matches CPI: ${transactionItem.cpi}, Count: ${transactionItem.count}`);\n      break;\n    }\n  }\n  \n  if (!foundMatch) {\n    unmatchedHubspot.push(hubspotItem);\n    console.log(`âŒ No match for HubSpot ID: ${hubspotItem.id}, Price: ${hubspotItem.price}, Qty: ${hubspotItem.quantity}`);\n  }\n});\n\n// Calculate totals for validation\nconst hubspotTotal = hubspotData.reduce((sum, item) => sum + (item.quantity * item.price), 0);\nconst transactionTotal = transactionData.reduce((sum, item) => sum + (item.count * item.cpi), 0);\n\nconst allMatched = unmatchedHubspot.length === 0 && unmatchedTransactions.length === 0;\n\n// Log unmatched items for debugging\nif (unmatchedTransactions.length > 0) {\n  console.log('âŒ Unmatched Transaction Data:', unmatchedTransactions);\n}\n\nconsole.log(`ðŸ“Š Summary - HubSpot items: ${hubspotData.length}, Transaction groups: ${transactionData.length}, Matches: ${matches.length}`);\nconsole.log(`ðŸ’° Revenue check - HubSpot total: ${hubspotTotal}, Transaction total: ${transactionTotal}`);\n\n// Return comprehensive results\nreturn {\n  json: {\n    reconciliationType: \"CPI Transaction Matching\",\n    allMatched: allMatched,\n    revenueMatched: hubspotTotal === transactionTotal,\n    summary: {\n      hubspotItems: hubspotData.length,\n      transactionGroups: transactionData.length,\n      matchedPairs: matches.length,\n      unmatchedHubspot: unmatchedHubspot.length,\n      unmatchedTransactions: unmatchedTransactions.length\n    },\n    financial: {\n      hubspotTotalRevenue: hubspotTotal,\n      transactionTotalRevenue: transactionTotal,\n      revenueDifference: hubspotTotal - transactionTotal\n    },\n    details: {\n      matches: matches,\n      unmatchedHubspotItems: unmatchedHubspot,\n      unmatchedTransactionItems: unmatchedTransactions,\n      hubspotData: hubspotData,\n      transactionData: transactionData\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1680,-688],"id":"ea79aa12-b4a3-44cd-8254-334640602aa7","name":"CPI Check"},{"parameters":{"jsCode":"// Get data from previous nodes\nconst snowflakeData = $input.all(); // Snowflake results with individual CLICKID/REVENUE pairs\nconst previousNodeData = $('Set CPIS').all(); // Get complex and simple transactions\n\nconsole.log('Snowflake Data:', snowflakeData);\nconsole.log('Previous Node Data:', previousNodeData);\n\nconst results = [];\n\npreviousNodeData.forEach((item, index) => {\n  console.log(`\\nProcessing item ${index + 1}:`);\n  \n  // Parse complex transactions\n  let complexTransactions = [];\n  if (item.json.complex_transactions) {\n    try {\n      complexTransactions = JSON.parse(item.json.complex_transactions);\n      console.log(`Found ${complexTransactions.length} complex transactions`);\n    } catch (error) {\n      console.error('Error parsing complex transactions:', error);\n    }\n  }\n  \n  // Get simple transaction IDs\n  let simpleTransactionIds = [];\n  if (item.json.simple_transactions) {\n    simpleTransactionIds = item.json.simple_transactions.split(',').map(id => parseInt(id.trim()));\n    console.log(`Found ${simpleTransactionIds.length} simple transaction IDs:`, simpleTransactionIds);\n  }\n  \n  // Create a map of transaction ID to CPI from Snowflake data\n  const transactionCpiMap = {};\n  snowflakeData.forEach(snowflakeItem => {\n    const clickId = snowflakeItem.json.CLICKID;\n    const revenue = snowflakeItem.json.REVENUE;\n    transactionCpiMap[clickId] = revenue;\n    console.log(`Snowflake mapping: Transaction ${clickId} -> CPI ${revenue}`);\n  });\n  \n  // Convert simple transactions to complex format using Snowflake mappings\n  const convertedSimpleTransactions = [];\n  \n  simpleTransactionIds.forEach(transactionId => {\n    if (transactionCpiMap[transactionId] !== undefined) {\n      const cpi = transactionCpiMap[transactionId];\n      convertedSimpleTransactions.push({\n        TransactionID: transactionId,\n        CPI: cpi,\n        Reward: \"Empty\"\n      });\n      console.log(`  Converted transaction ${transactionId} with CPI ${cpi}`);\n    } else {\n      console.warn(`  Warning: No CPI found for transaction ${transactionId} in Snowflake data`);\n      // Optionally, you can still include it with CPI as \"Empty\" or skip it\n      convertedSimpleTransactions.push({\n        TransactionID: transactionId,\n        CPI: \"Empty\",\n        Reward: \"Empty\"\n      });\n    }\n  });\n  \n  // Combine complex and converted simple transactions\n  const allTransactions = [...complexTransactions, ...convertedSimpleTransactions];\n  \n  console.log(`Total combined transactions: ${allTransactions.length}`);\n  console.log(`(${complexTransactions.length} complex + ${convertedSimpleTransactions.length} converted simple)`);\n  \n  // Sort by TransactionID for consistent output (optional)\n  allTransactions.sort((a, b) => a.TransactionID - b.TransactionID);\n  \n  // Create the final result\n  const result = {\n    transaction_rewards: JSON.stringify(allTransactions)\n  };\n  \n  results.push(result);\n  console.log('Final result for item:', result);\n});\n\nconsole.log(`\\nTotal results created: ${results.length}`);\n\n// Return results in the expected format\nreturn results.map(result => ({ json: result }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1504,-688],"id":"0eba49f5-bf49-47aa-8a12-75a1698b03c3","name":"GroupTransactionIDs"},{"parameters":{"method":"POST","url":"https://api.hubspot.com/crm/v3/objects/notes","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"hs_timestamp\": {{ new Date($now.toISO()).getTime() }},\n    \"hs_note_body\": \"Reconciliation n8n Execution: https://prodegellc.app.n8n.cloud/{{ $workflow.id }}/executions/{{ $execution.id }}\"\n  },\n  \"associations\": [\n    {\n      \"to\": {\n        \"id\": {{ $json.body.ticketId }}\n      },\n      \"types\": [\n        {\n          \"associationCategory\": \"HUBSPOT_DEFINED\",\n          \"associationTypeId\": 228\n        }\n      ]\n    }\n  ]\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2640,-400],"id":"918204e0-0ac2-4f6a-883e-63d5a272cade","name":"createEngagmentTracker","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}}],"connections":{"HTTP Get pf_line_item":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"HTTP Get pf_line_item values","type":"main","index":0}]]},"Generate Signature":{"main":[[{"node":"GET Deal on Ticket","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"timeOffset","type":"main","index":0}]]},"timeOffset":{"main":[[{"node":"Generate Signature","type":"main","index":0}]]},"StatusCode":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Get Project Status","type":"main","index":0}],[{"node":"Manager Rejected","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"First Variables","type":"main","index":0},{"node":"createEngagmentTracker","type":"main","index":0}]]},"Get Reconciliation File ID":{"main":[[{"node":"Get Reconciliation File Signed URL","type":"main","index":0}]]},"Get Reconciliation File Signed URL":{"main":[[{"node":"Break Out URL and Name","type":"main","index":0}]]},"Break Out URL and Name":{"main":[[{"node":"Get File Data","type":"main","index":0}]]},"Get File Data":{"main":[[{"node":"Clean Data","type":"main","index":0}]]},"Clean Data":{"main":[[{"node":"Snowflake","type":"main","index":0}]]},"Split Out3":{"main":[[{"node":"Get Line Items Details","type":"main","index":0}]]},"GET Deal on Ticket":{"main":[[{"node":"GET Line Items","type":"main","index":0}]]},"Match Line Item to Ticket":{"main":[[{"node":"Switch","type":"main","index":0}]]},"GET Line Items":{"main":[[{"node":"Split Out3","type":"main","index":0}]]},"Get Line Items Details":{"main":[[{"node":"De-Dup & Add Sig Back","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Simple Reconciliation1","type":"main","index":0}],[{"node":"Complex Reconciliation2","type":"main","index":0}]]},"Snowflake":{"main":[[{"node":"Re-Clean Data","type":"main","index":0},{"node":"NetSuitelLineItem","type":"main","index":0}]]},"Get Project Status":{"main":[[{"node":"Clean Status","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Auto Approved Status","type":"main","index":0}],[{"node":"Pending Approval Status","type":"main","index":0}]]},"Pending Approval Status":{"main":[[{"node":"Wait 1 Day","type":"main","index":0}]]},"Get Project Status1":{"main":[[{"node":"Clean Status1","type":"main","index":0}]]},"Wait 1 Day":{"main":[[{"node":"timeOffset1","type":"main","index":0}]]},"timeOffset1":{"main":[[{"node":"Generate Signature1","type":"main","index":0}]]},"Generate Signature1":{"main":[[{"node":"Get Project Status1","type":"main","index":0}]]},"Clean Status":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Clean Status1":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"Manager Approved Status","type":"main","index":0}],[{"node":"Manager Rejected1","type":"main","index":0}],[{"node":"Wait 1 Day","type":"main","index":0}]]},"Re-Clean Data":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"First Variables":{"main":[[{"node":"Get Reconciliation File ID","type":"main","index":0}]]},"Manager Approved Status":{"main":[[{"node":"Assembly Webhook2","type":"main","index":0}]]},"Auto Approved Status":{"main":[[{"node":"Assembly Webhook1","type":"main","index":0}]]},"Assembly Webhook1":{"main":[[]]},"Filter":{"main":[[{"node":"Match Line Item to Ticket","type":"main","index":0}]]},"De-Dup & Add Sig Back":{"main":[[{"node":"Filter","type":"main","index":0},{"node":"Match Line Item to Ticket1","type":"main","index":0}]]},"Merge Reco and Info":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Merge Reco and Info1":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"HTTP Request: get dealid":{"main":[[{"node":"HTTP Get HS_line_items","type":"main","index":0}]]},"NetSuitelLineItem":{"main":[[{"node":"HTTP Request: get dealid","type":"main","index":0},{"node":"Merge","type":"main","index":0}]]},"cleanLineItems":{"main":[[{"node":"HTTP Get NS_line_item values","type":"main","index":0}]]},"HTTP Get NS_line_item values":{"main":[[{"node":"Filter1","type":"main","index":0}]]},"HTTP Get HS_line_items":{"main":[[{"node":"cleanLineItems","type":"main","index":0}]]},"cleanJSON":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Filter1":{"main":[[{"node":"cleanJSON","type":"main","index":0}]]},"Complex Reconciliation2":{"main":[[{"node":"Merge Reco and Info1","type":"main","index":0}]]},"Simple Reconciliation1":{"main":[[{"node":"Merge Reco and Info","type":"main","index":0}]]},"Merge":{"main":[[{"node":"lineItemIdMatch","type":"main","index":0}]]},"lineItemIdMatch":{"main":[[{"node":"Merge1","type":"main","index":2}]]},"Merge1":{"main":[[{"node":"StatusCode","type":"main","index":0}]]},"If1":{"main":[[],[]]},"Snowflake1":{"main":[[{"node":"For Simple","type":"main","index":0}]]},"If2":{"main":[[{"node":"Stop and Error","type":"main","index":0}]]},"For Complex":{"main":[[{"node":"If2","type":"main","index":0}]]},"For Simple":{"main":[[{"node":"If2","type":"main","index":0}]]},"Switch3":{"main":[[{"node":"set_trans_rewards","type":"main","index":0}],[{"node":"Seperate Complex and Simple","type":"main","index":0}],[{"node":"set_trans","type":"main","index":0}]]},"Remove Duplicates":{"main":[[{"node":"Snowflake1","type":"main","index":0}]]},"Remove Duplicates1":{"main":[[{"node":"For Complex","type":"main","index":0}]]},"set_trans_rewards":{"main":[[{"node":"Remove Duplicates1","type":"main","index":0}]]},"set_trans":{"main":[[{"node":"Remove Duplicates","type":"main","index":0}]]},"Match Line Item to Ticket1":{"main":[[{"node":"Switch3","type":"main","index":0}]]},"Manager Rejected":{"main":[[]]},"Seperate Complex and Simple":{"main":[[{"node":"Set CPIS","type":"main","index":0}]]},"Set CPIS":{"main":[[{"node":"Snowflake2","type":"main","index":0}]]},"Snowflake2":{"main":[[{"node":"GroupTransactionIDs","type":"main","index":0}]]},"GroupTransactionIDs":{"main":[[{"node":"CPI Check","type":"main","index":0}]]},"CPI Check":{"main":[[{"node":"If2","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timeSavedMode":"fixed","callerPolicy":"workflowsFromSameOwner","availableInMCP":false,"errorWorkflow":"oYA9v0CuR3mPGV14"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"e852def5-2ae8-4c44-bdc2-1f9e22de484d","activeVersionId":"e852def5-2ae8-4c44-bdc2-1f9e22de484d","triggerCount":1,"shared":[{"updatedAt":"2025-12-18T17:12:46.700Z","createdAt":"2025-12-18T17:12:46.700Z","role":"workflow:owner","workflowId":"yKwxcKzgjfQYG2QN","projectId":"PZkDRO2KVE09GlpT"}],"activeVersion":{"updatedAt":"2025-12-18T19:30:55.967Z","createdAt":"2025-12-18T19:30:55.967Z","versionId":"e852def5-2ae8-4c44-bdc2-1f9e22de484d","workflowId":"yKwxcKzgjfQYG2QN","nodes":[{"parameters":{"url":"https://api.hubapi.com/crm/v3/objects/deals/42228302623/associations/line_items","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-640,-704],"id":"90e6e00e-520d-4e91-9ac6-402a499bb87a","name":"HTTP Get pf_line_item","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}},"disabled":true},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"properties","value":"group_id,offer_type,country,description,reconciliation_type,reconciliation_status,scrub_rate__line_item_,scrub_rate__billable_event_,"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,-704],"id":"bb979bb2-2123-421f-9951-e790ab7a57cc","name":"HTTP Get pf_line_item values","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}},"disabled":true},{"parameters":{"content":"# pf_line_item","height":320,"width":608,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-672,-864],"typeVersion":1,"id":"37ba02fc-988a-4dc7-b4cc-250a32836504","name":"Sticky Note","disabled":true},{"parameters":{"fieldToSplitOut":"results","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-416,-704],"id":"34f4db3f-4cb9-42b8-9afa-c953c4942a15","name":"Split Out","disabled":true},{"parameters":{"jsCode":"// ===========================================\n// ðŸ” Generate Prodege Signature for Reconciliation\n// ===========================================\nconst crypto = require('crypto');\n\n// Get the decrypted keys from the current input\nconst apiKey = $json.apiKey;\nconst secretKey = $json.secretKey;\nconst reconciliationNote = $json.reconciliationNote || '';\nconst timeOffsetNode = $('timeOffset').item.json;\nconst timeOffset = timeOffsetNode.request_time_offset || 0;\n\n// ===========================================\n// ðŸ“Š Group Data by Project ID\n// ===========================================\n// Get all items from Edit Fields node to group by project\nconst editFieldsItems = $('Edit Fields').all();\nconst groupedData = {};\n\nconsole.log('Debug - Edit Fields Items:', editFieldsItems.map(item => ({ \n  projectId: item.json.prodegeProjectId, \n  ticketId: item.json.ticket_id \n})));\n\neditFieldsItems.forEach(item => {\n  const projectId = item.json.prodegeProjectId;\n  const successfulIds = item.json.successfulTransactionIds;\n  const transactionRewards = item.json.transaction_rewards;\n  const ticketId = item.json.ticket_id;\n  \n  if (!groupedData[projectId]) {\n    groupedData[projectId] = {\n      successfulTransactionIds: [],\n      transactionRewards: [],\n      ticketId: ticketId // Store the ticket_id for this project\n    };\n  }\n  \n  // Update ticket_id if not already set (in case of multiple items per project)\n  if (!groupedData[projectId].ticketId && ticketId) {\n    groupedData[projectId].ticketId = ticketId;\n  }\n  \n  // Add successful transaction IDs\n  if (successfulIds) {\n    const idsArray = Array.isArray(successfulIds) \n      ? successfulIds \n      : successfulIds.toString().split(',').map(id => id.trim());\n    groupedData[projectId].successfulTransactionIds.push(...idsArray);\n  }\n  \n  // Add transaction rewards\n  if (transactionRewards && Array.isArray(transactionRewards)) {\n    groupedData[projectId].transactionRewards.push(...transactionRewards);\n  }\n});\n\n// ===========================================\n// ðŸ•’ Compute Correct Timestamp\n// ===========================================\nconst clientTime = Date.now();\nconst requestDate = clientTime + timeOffset;\n\n// ===========================================\n// âœ… Return Multiple Items - One Per Project with Signatures\n// ===========================================\nconst results = [];\n\nObject.keys(groupedData).forEach(projectId => {\n  // Remove duplicate transaction IDs and convert to comma-separated string\n  const uniqueIds = [...new Set(groupedData[projectId].successfulTransactionIds)];\n  const successfulTransactionIds = uniqueIds.join(',');\n  \n  // Remove duplicate transaction rewards based on TransactionID\n  const uniqueRewards = [];\n  const seenIds = new Set();\n  groupedData[projectId].transactionRewards.forEach(reward => {\n    if (!seenIds.has(reward.TransactionID)) {\n      seenIds.add(reward.TransactionID);\n      uniqueRewards.push(reward);\n    }\n  });\n  \n  // ===========================================\n  // ðŸ“‹ CPI Check - List each transaction and CPI status\n  // ===========================================\n  const cpiCheck = uniqueRewards.map(reward => ({\n    TransactionID: reward.TransactionID,\n    CPI: reward.CPI,\n    CPIStatus: (reward.CPI === null || reward.CPI === undefined || reward.CPI === '') ? 'Blank' : 'Populated'\n  }));\n  \n  // ===========================================\n  // ðŸ§© Build Params and Signing String for THIS project\n  // ===========================================\n  const params = {\n    apik: apiKey,\n    request_date: requestDate,\n    prodege_project_id: projectId,\n    successful_transaction_ids: successfulTransactionIds,\n    reconciliation_note: reconciliationNote\n  };\n\n  const stringToSign = Object.keys(params)\n    .sort()\n    .map(key => `${key}=${params[key]}`)\n    .join(':');\n\n  // ===========================================\n  // ðŸ” Generate Signature (standard Base64) for THIS project\n  // ===========================================\n  const utf8Encoded = Buffer.from(`${secretKey}:${stringToSign}`, 'utf8');\n  const sha256Hash = crypto.createHash('sha256').update(utf8Encoded).digest();\n  const signature = sha256Hash.toString('base64');\n  \n  results.push({\n    json: {\n      // Clean structure you requested\n      projectId: projectId,\n      ticketId: groupedData[projectId].ticketId, // âœ… Added ticket_id to output\n      successfulTransactionIds: successfulTransactionIds,\n      transactionRewards: uniqueRewards,\n      //cpiCheck: cpiCheck, // âœ… NEW - CPI check output with corrected logic\n      // Original signature fields (FIXED - was missing signature)\n      apik: apiKey,\n      request_date: requestDate,\n      reconciliation_note: reconciliationNote,\n      signature: signature // âœ… FIXED - Added missing signature\n    }\n  });\n});\n\nconsole.log('Debug - Final results:', results.map(r => ({ \n  projectId: r.json.projectId,\n  ticketId: r.json.ticketId, \n  hasSignature: !!r.json.signature \n})));\n\nreturn results;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-560,-128],"id":"e1ce95f5-1b62-4075-bc6f-125937a9d4e0","name":"Generate Signature"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"prodegeProjectId\": \"{{ $json.PROJECTID }}\",\n  \"encryptedApiKey\": \"b8bf506b7cb157e3e3fb549b865ec8fb:b04c382cb8e13b1411175ec4e3d0e058\",\n  \"encryptedSecretKey\": \"2288a8ec9a2fcb29aa77927896d4c21e:e0f1a9125b9e6478324b8aa4a5d0d64d2fc7b99e80d81949ef0b2834bdcb9ec7bdbffe0b3bca7fc2eeea4dfff3f6d168\",\n  \"encryptionPassword\": \"MySecretPassword123!\",\n  \"successfulTransactionIds\": \"{{ $json.successful_transaction_ids }}\" , \n  \"reconciliationNote\": \"Reconciliation note\",\n  \"ticket_id\": \"{{ $json.ticket_id }}\" ,\n  \"transaction_rewards\": {{ $('Re-Clean Data').item.json.transaction_rewards }}\n} ","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-944,-128],"id":"c4398afb-099c-4d83-a2d8-bd9063f56833","name":"Edit Fields"},{"parameters":{"url":"=https://surveypmr.prodegeapisqa.com/prodegemr/lookup-request-time-offset?client_time={{ Date.now() }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-768,-128],"id":"cfef2fb8-0b5e-4c1b-aebe-0d458cdaae72","name":"timeOffset","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"}}},{"parameters":{"content":"## ðŸ”µ **Credentials Used**\n\n\n**HTTP Bearer Auth:**\nâ€¢ **Credential Name:** `peeqAPI`\nâ€¢ **Usage:** Authenticate API requests to Prodege QA endpoints\n\n**n8n Storage:**\nâ€¢ Credentials stored securely in n8n\n\n**Notes:**\nâ€¢ Ensure API keys and tokens match environment (Sandbox vs Prod)\nâ€¢ Only use credentials in nodes that require authentication","height":324,"width":480,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-1280,-864],"typeVersion":1,"id":"0ca56a4a-2325-4deb-9c46-e399f0d88ae1","name":"Credentials Used"},{"parameters":{"content":"## ðŸŸ¡ **Summary of Project Reconciliation Workflow**\n\n**Purpose:**\nAutomates reconciliation of scrubbed IDs in Peeq, updating project status and maintaining accurate transaction records.\n\n**Trigger Node:**\nâ€¢ `When clicking â€˜Execute workflowâ€™` â€“ manual execution\n\n**Key Nodes and Flow:**\nâ€¢ **Edit Fields:** Sets dynamic input: project ID, transaction IDs, and reconciliation note\nâ€¢ **timeOffset:** Retrieves server-client time offset for accurate signature\nâ€¢ **Generate Signature:** Calculates SHA256 signature using hardcoded API keys and dynamic input\nâ€¢ **Reconciliation:** HTTP POST to Prodege QA endpoint\n\n**Functionality:**\nâ€¢ Reconciles scrubbed IDs in Peeq\nâ€¢ Moves projects to **Pending Complete** status\nâ€¢ Adds projects into **Pending Reconciliations** queue\nâ€¢ Sends reconciliation data securely using Bearer Auth\n\n**Inputs:**\nâ€¢ Prodege Project ID\nâ€¢ Successful Transaction IDs\nâ€¢ Reconciliation Note\n\n","height":608,"width":520},"type":"n8n-nodes-base.stickyNote","position":[-1872,-1152],"typeVersion":1,"id":"36be662a-b3c6-4ae7-987f-c647ea45c225","name":"Project Reconciliation Overview"},{"parameters":{"jsCode":"// Get all input items\nconst items = $input.all();\n\n// Group items by project ID AND line item ID combination\nconst itemMap = new Map();\n\nitems.forEach(inputItem => {\n  const item = inputItem.json;\n  let projectId;\n  let lineItemId;\n  let statusId = null;\n  let message = null;\n  \n  // Determine project ID from either PROJECTID field or signatureData.projectId\n  if (item.PROJECTID) {\n    projectId = item.PROJECTID.toString();\n  } else if (item.signatureData?.projectId) {\n    projectId = item.signatureData.projectId;\n  }\n  \n  // Get line item ID\n  lineItemId = item.id?.toString();\n  \n  // Create unique key combining project ID and line item ID\n  const uniqueKey = `${projectId}_${lineItemId}`;\n  \n  // If this item has a data field, parse the status information\n  if (item.data) {\n    try {\n      const parsed = JSON.parse(item.data);\n      statusId = parsed.return_status.status_id;\n      message = parsed.return_status.message[0]; // message is an array\n    } catch (error) {\n      console.log('Error parsing data field:', error);\n    }\n  }\n  \n  // Get existing item data or create new entry\n  if (itemMap.has(uniqueKey)) {\n    // Merge with existing item data (preserve all fields, update status if available)\n    const existing = itemMap.get(uniqueKey);\n    itemMap.set(uniqueKey, {\n      ...existing,\n      ...item,\n      // Preserve or update status info\n      statusId: statusId || existing.statusId,\n      message: message || existing.message,\n      // Ensure signatureData is preserved\n      signatureData: item.signatureData || existing.signatureData\n    });\n  } else {\n    // Create new item entry\n    itemMap.set(uniqueKey, {\n      ...item,\n      statusId,\n      message,\n      signatureData: item.signatureData || null\n    });\n  }\n});\n\n// Convert map back to array and log debug info\nconst mergedResults = Array.from(itemMap.values());\n\nconsole.log(`Total unique items after processing: ${mergedResults.length}`);\n\n// Group by project ID for logging\nconst projectGroups = {};\nmergedResults.forEach((item, index) => {\n  const projectId = item.PROJECTID || item.signatureData?.projectId;\n  if (!projectGroups[projectId]) {\n    projectGroups[projectId] = [];\n  }\n  projectGroups[projectId].push(item);\n  \n  console.log(`Item ${index + 1}:`);\n  console.log('  Project ID:', projectId);\n  console.log('  Line Item ID:', item.id);\n  console.log('  Has signatureData:', !!item.signatureData);\n  console.log('  StatusId:', item.statusId);\n  console.log('  Message:', item.message);\n  console.log('---');\n});\n\n// Log summary by project\nObject.keys(projectGroups).forEach(projectId => {\n  console.log(`Project ${projectId}: ${projectGroups[projectId].length} line items`);\n});\n\nreturn mergedResults.map(item => ({ json: item }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2464,48],"id":"af649b74-3999-47f3-b74a-c6ab8cefc86e","name":"StatusCode"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6c4aaab8-947a-431e-967d-a39cbf7c994a","leftValue":"={{ $json.data }}","rightValue":"1","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2960,48],"id":"32e37a6c-e29f-4920-a068-9b21c2e94dee","name":"If"},{"parameters":{"httpMethod":"POST","path":"5f9c967c-peeq-project-reconciliation-automation","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2928,-128],"id":"78877e92-47dd-4fae-9980-537e5ad823e7","name":"Webhook","webhookId":"5f9c967c-00c4-4993-a7ba-3023380e2f2f"},{"parameters":{"url":"=https://api.hubapi.com/crm/v4/objects/tickets/{{ $('Edit Fields').first().json.ticket_id }}/associations/deals","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Accept","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-368,-128],"id":"ddb32663-dea9-43ec-95b2-59e5a3691fe1","name":"GET Deal on Ticket","executeOnce":false,"credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://api.hubapi.com/files/v3/files/{{ $json.reconciliation_file }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2272,-128],"id":"71fcf8cb-5f33-4347-bb4a-66c5903429b7","name":"Get Reconciliation File ID","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://api.hubapi.com/filemanager/api/v3/files/{{ $json.id }}/signed-url","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{"redirect":{"redirect":{"maxRedirects":5}},"response":{"response":{"responseFormat":"text"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2080,-128],"id":"fd753cff-278c-4b12-8c7a-f8e4527acf6c","name":"Get Reconciliation File Signed URL","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"jsCode":"// Parse the JSON response and extract the URL\nconst responseData = JSON.parse($input.item.json.data);\nreturn {\n  signedUrl: responseData.url,\n  fileName: responseData.name,\n  fileSize: responseData.size\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1888,-128],"id":"0e3cb167-ad02-4c15-bdd6-e6c514df3aa7","name":"Break Out URL and Name"},{"parameters":{"url":"={{ $json.signedUrl }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{"redirect":{"redirect":{"maxRedirects":5}},"response":{"response":{"responseFormat":"text"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1712,-128],"id":"a8a833e3-3e2c-4547-8f9e-b8865a69d1b0","name":"Get File Data","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"jsCode":"// Get the CSV data\nconst csvData = $input.item.json.data;\n\n// Split into lines and process\nconst lines = csvData.split('\\n');\n\n// Extract TransactionIDs for comma-separated string (keep existing logic)\nconst transactionIds = lines\n  .slice(1) // Skip header row\n  .map(line => line.split(',')[0]) // Get first column (TransactionID)\n  .filter(id => id && id.trim() !== '') // Remove empty lines\n  .map(id => id.trim()); // Clean whitespace\n\n// Create transaction_rewards array from CSV data\nconst transactionRewards = lines\n  .slice(1) // Skip header row\n  .filter(line => line && line.trim() !== '') // Remove empty lines\n  .map(line => {\n    const columns = line.split(',');\n    \n    // Handle CPI column - only convert to number if not empty\n    let cpi;\n    const cpiValue = columns[1]?.trim();\n    if (cpiValue === '' || cpiValue === undefined) {\n      cpi = \"Empty\";\n    } else {\n      cpi = parseFloat(cpiValue) || 0;\n    }\n    \n    // Handle Reward column - only convert to number if not empty\n    let reward;\n    const rewardValue = columns[2]?.trim();\n    if (rewardValue === '' || rewardValue === undefined) {\n      reward = \"Empty\";\n    } else {\n      reward = parseFloat(rewardValue) || 0;\n    }\n    \n    return {\n      \"TransactionID\": parseInt(columns[0]?.trim()) || 0,\n      \"CPI\": cpi,\n      \"Reward\": reward\n    };\n  })\n  .filter(item => !isNaN(item.TransactionID) && item.TransactionID > 0); // Remove invalid entries\n\n// Return both formats\nreturn {\n  transactionIds: transactionIds.join(','), // Keep comma-separated string\n  transactionIdsArray: transactionIds, // Keep simple array\n  transaction_rewards: transactionRewards, // New API format\n  count: transactionIds.length\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,-128],"id":"01f958cc-e100-4c96-88b2-4998cc72d549","name":"Clean Data"},{"parameters":{"fieldToSplitOut":"results","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[0,-128],"id":"67f5b9c4-2401-4f5e-a06b-6a6c47e1d613","name":"Split Out3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eb427cf3-6717-4d57-826e-625ccfcfd93e","leftValue":"={{ $json.properties.billable_event }}","rightValue":"={{ $('Webhook').item.json.body.billable_event }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[832,-128],"id":"03f47c5b-31fa-4233-b1b0-6ce64f4e0904","name":"Match Line Item to Ticket"},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/deals/{{ $json.results[0].toObjectId }}/associations/line_items","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-160,-128],"id":"7ddf8bdc-ff7f-4298-b575-eb18fa721f16","name":"GET Line Items","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"properties","value":"group_id,offer_type,country,description,reconciliation_type,reconciliation_status,scrub_rate__line_item_,scrub_rate__billable_event_,billable_event,quantity,price,name"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[160,-128],"id":"4282724c-6072-4b3d-9736-18d13984d32a","name":"Get Line Items Details","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.properties.reconciliation_type }}","rightValue":"simple","operator":{"type":"string","operation":"contains"},"id":"ced71726-f1fc-42d9-b9de-063e6518d0ad"}],"combinator":"and"},"renameOutput":true,"outputKey":"Simple"},{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c01698e-f06e-4510-adce-f879eaa55014","leftValue":"={{ $json.properties.reconciliation_type }}","rightValue":"complex","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Complex"}]},"options":{"ignoreCase":true,"allMatchingOutputs":false}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1104,-144],"id":"a5ade583-24d0-4d03-b81a-20c9ee7710fe","name":"Switch"},{"parameters":{"operation":"executeQuery","query":"select projectid,  LISTAGG(clickid, ',') as clickids\n\nFROM \n\nOPS_AUTOMATION_DB.SURVEYS.PROJECT_COMPLETION pc\n--LEFT JOIN stage.surveys.PROJECT_COMPLETION_TYPE ct on ct.completiontypeid = pc.completiontype\n\nwhere clickid in ({{ $json.transactionIds }})\n\ngroup by 1"},"type":"n8n-nodes-base.snowflake","typeVersion":1,"position":[-1328,-128],"id":"70b73047-2567-4bf4-94b0-17eeceafcb86","name":"Snowflake","alwaysOutputData":false,"credentials":{"snowflake":{"id":"reIlyZhfAfZTYk8S","name":"Snowflake prodegeqa"}},"onError":"continueRegularOutput"},{"parameters":{"url":"=https://surveypmr.prodegeapisqa.com/prodegemr/project-get-info","authentication":"genericCredentialType","genericAuthType":"httpCustomAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"=request_date","value":"={{ $json.signatureData.request_date }}"},{"name":"prodege_project_id","value":"={{ $json.signatureData.projectId }}"},{"name":"signature","value":"={{ $json.signatureData.signature }}"}]},"sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}","options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3168,-176],"id":"5f4d5403-ffde-4a75-b9b0-fa5f705e77d1","name":"Get Project Status","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"},"httpCustomAuth":{"id":"K3SygLYbImTEQK8q","name":"peeqAPI Query Auth"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.status }}","rightValue":"COMPLETE","operator":{"type":"string","operation":"equals"},"id":"3df91b38-282a-426f-850b-2558bb9d5da2"}],"combinator":"and"},"renameOutput":true,"outputKey":"AUTO APPROVED"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0cbb38af-910f-48ea-ba60-a96932529995","leftValue":"={{ $json.status }}","rightValue":"PENDING_COMPLETE","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"PENDING APPROVAL"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[3536,-256],"id":"c577d9f2-0a1e-4df0-b422-8d9723f459f7","name":"Switch1"},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.properties.hs_object_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Auto Approved\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3936,-368],"id":"c992d3d7-f21c-4666-8e48-3eb37eac80ca","name":"Auto Approved Status","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Pending Approval\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4144,-176],"id":"d9290cf0-612c-4d6b-9246-0f2728679ca7","name":"Pending Approval Status","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://surveypmr.prodegeapisqa.com/prodegemr/project-get-info","authentication":"genericCredentialType","genericAuthType":"httpCustomAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"=request_date","value":"={{ $json.request_date }}"},{"name":"prodege_project_id","value":"={{ $json.project_id }}"},{"name":"signature","value":"={{ $json.signature }}"}]},"sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}","options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4896,-176],"id":"e7bf930a-6588-429d-80cb-f8b2d84a9532","name":"Get Project Status1","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"},"httpCustomAuth":{"id":"K3SygLYbImTEQK8q","name":"peeqAPI Query Auth"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.status }}","rightValue":"COMPLETE","operator":{"type":"string","operation":"equals"},"id":"3df91b38-282a-426f-850b-2558bb9d5da2"}],"combinator":"and"},"renameOutput":true,"outputKey":"MANAGER APPROVED"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"56a7fd1e-de4d-4e64-b962-1bcd8df25bbe","leftValue":"={{ $json.status }}","rightValue":"PAUSED","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"MANAGE REJECTED"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0cbb38af-910f-48ea-ba60-a96932529995","leftValue":"={{ $json.status }}","rightValue":"PENDING_COMPLETE","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"PENDING APPROVAL"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[5280,-192],"id":"cc69375c-961c-45de-9dfe-ee3b0ea45597","name":"Switch2"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[4336,-176],"id":"a58c3326-7e30-4aa5-bf6b-d8985baa21fb","name":"Wait 1 Day","webhookId":"ce563f87-34ca-452f-bd0a-396d369531ce"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// ===========================================\n// PEEQ API SIGNATURE GENERATOR (PRODUCTION)\n// ===========================================\n\n// Get current item's time offset data\nconst currentItemData = $input.item.json;\nlet timeOffset = 0;\n\ntry {\n  const timeOffsetResponse = JSON.parse(currentItemData.data);\n  timeOffset = timeOffsetResponse.request_time_offset || 0;\n  console.log('Time offset for this item:', timeOffset);\n} catch (e) {\n  console.error('Error parsing time offset data:', e.message);\n  timeOffset = 0;\n}\n\n// Get project data from Switch1 node (which has the project info)\nconst switch1Items = $('Switch1').all();\nconst currentSwitch1Item = switch1Items[$itemIndex];\n\nlet prodegeProjectId = null;\nlet projectInfo = null;\n\nif (currentSwitch1Item) {\n  try {\n    const switch1Data = JSON.parse(currentSwitch1Item.json.data);\n    if (switch1Data.project_info) {\n      projectInfo = switch1Data.project_info;\n      prodegeProjectId = projectInfo.prodege_project_id;\n      console.log('âœ… Found project info from Switch1');\n      console.log('ðŸŽ¯ Processing project ID:', prodegeProjectId);\n    }\n  } catch (e) {\n    console.error('Error parsing Switch1 data:', e.message);\n  }\n}\n\n// Fallback: try to get from signatureData if not found\nif (!prodegeProjectId && currentSwitch1Item?.json.signatureData) {\n  prodegeProjectId = currentSwitch1Item.json.signatureData.projectId;\n  console.log('ðŸ”„ Using fallback project ID from Switch1 signatureData:', prodegeProjectId);\n}\n\n// Get reconciliation note and transaction IDs from Switch1 item\nlet reconciliationNote = \"\";\nlet successfulTransactionIds = \"\";\n\nif (currentSwitch1Item?.json.signatureData) {\n  reconciliationNote = currentSwitch1Item.json.signatureData.reconciliation_note || \"\";\n  successfulTransactionIds = currentSwitch1Item.json.signatureData.successfulTransactionIds || \"\";\n} else {\n  // Final fallback to Edit Fields\n  const editFieldsItem = $('Edit Fields').first().json;\n  reconciliationNote = editFieldsItem.reconciliationNote || \"\";\n  successfulTransactionIds = editFieldsItem.successfulTransactionIds || \"\";\n}\n\nconsole.log('ðŸ“‹ Transaction IDs:', successfulTransactionIds);\n\n// Parse transaction IDs\nlet transactionIds = [];\nif (successfulTransactionIds) {\n  transactionIds = successfulTransactionIds\n    .split(',')\n    .map(id => parseInt(id.trim()))\n    .filter(id => !isNaN(id));\n}\n\n// ===========================================\n// ðŸ”“ DECRYPT KEYS (ONLY ENCRYPTED VALUES IN WORKFLOW)\n// ===========================================\n\nconst crypto = require('crypto');\n\n// Get encrypted data from Edit Fields node (keys are shared across all projects)\nconst editFieldsItem = $('Edit Fields').first().json;\nconst encryptedApiKey = editFieldsItem.encryptedApiKey;\nconst encryptedSecretKey = editFieldsItem.encryptedSecretKey; \nconst encryptionPassword = editFieldsItem.encryptionPassword;\n\n// Decryption function\nfunction decryptString(encryptedText, password) {\n  const algorithm = 'aes-256-cbc';\n  const key = crypto.scryptSync(password, 'salt', 32);\n  \n  const [ivHex, encrypted] = encryptedText.split(':');\n  const iv = Buffer.from(ivHex, 'hex');\n  \n  const decipher = crypto.createDecipheriv(algorithm, key, iv);\n  let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n  decrypted += decipher.final('utf8');\n  \n  return decrypted;\n}\n\n// ðŸ”“ Decrypt the keys at runtime\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('âœ… Keys decrypted successfully');\nconsole.log(`ðŸ”‘ API Key length: ${apiKey.length}`);\nconsole.log(`ðŸ—ï¸ Secret Key length: ${secretKey.length}`);\n\n// ===========================================\n// ðŸ” GENERATE SIGNATURE (PROJECT-SPECIFIC)\n// ===========================================\n\nif (!prodegeProjectId) {\n  throw new Error('âŒ No project ID found in Switch1 data or signatureData');\n}\n\nconst clientTime = Date.now();\nconst requestDate = clientTime + timeOffset;\n\nconst params = {\n  apik: apiKey,\n  request_date: requestDate,\n  prodege_project_id: prodegeProjectId,\n  successful_transaction_ids: transactionIds.join(','),\n  reconciliation_note: reconciliationNote\n};\n\nconst stringToSign = Object.keys(params)\n  .sort()\n  .map(key => `${key}=${params[key]}`)\n  .join(':');\n\nconst utf8Encoded = Buffer.from(`${secretKey}:${stringToSign}`, 'utf8');\nconst sha256Hash = crypto.createHash('sha256').update(utf8Encoded).digest();\nconst base64Encoded = sha256Hash.toString('base64');\n\nconst signature = base64Encoded\n  .replace(/\\+/g, '-')\n  .replace(/\\//g, '_')\n  .replace(/=/g, '');\n\nconsole.log('ðŸ” Signature generated successfully');\nconsole.log(`âœ… Using time offset: ${timeOffset} for project: ${prodegeProjectId}`);\nconsole.log(`ðŸ“Š Item index: ${$itemIndex}`);\n\nreturn {\n  json: {\n    // Preserve all original data\n    ...currentItemData,\n    // Add signature data\n    request_date: requestDate,\n    reconciliation_note: reconciliationNote,\n    signature: signature,\n    time_offset_used: timeOffset,\n    project_id: prodegeProjectId, // Include the specific project ID\n    // Keep project info if available\n    projectInfo: projectInfo\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4688,-176],"id":"b440391f-1d5b-48ce-8dff-fcff58c2449a","name":"Generate Signature1"},{"parameters":{"url":"=https://surveypmr.prodegeapisqa.com/prodegemr/lookup-request-time-offset?client_time={{ Date.now() }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4512,-176],"id":"2ffb72f8-c55d-4c7e-8eb4-e4ecdee0e908","name":"timeOffset1","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse the JSON string from the data field\nconst jsonData = JSON.parse($input.item.json.data);\nconst item = $input.item.json;\n\n// Get ALL data from the IF node (which contains the merged line item data from StatusCode)\nconst ifNodeData = $('If').first().json;\n\n// Extract the status from project_info  \nconst status = jsonData.project_info.status;\n\n// Log to debug\nconsole.log('Item has signatureData from IF node:', !!ifNodeData.signatureData);\nconsole.log('Project status:', status);\nconsole.log('IF node data keys:', Object.keys(ifNodeData));\n\n// Return the status while preserving ALL data from both sources\nreturn {\n  json: {\n    // Start with ALL the merged line item data from the IF node\n    ...ifNodeData,\n    // Override with current HTTP response data (headers, statusCode, etc.)\n    ...item,\n    // Add the extracted status\n    status: status,\n    // Ensure signatureData is preserved from IF node (in case it got overwritten)\n    signatureData: ifNodeData.signatureData || null\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3344,-256],"id":"566c261a-44c5-4ad8-8915-c08da1579889","name":"Clean Status"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Parse the JSON string from the data field\nconst jsonData = JSON.parse($input.item.json.data);\nconst item = $input.item.json;\n\n// Get ALL data from the IF node (which contains the merged line item data from StatusCode)\nconst ifNodeData = $('If').first().json;\n\n// Extract the status from project_info  \nconst status = jsonData.project_info.status;\n\n// Log to debug\nconsole.log('Item has signatureData from IF node:', !!ifNodeData.signatureData);\nconsole.log('Project status:', status);\nconsole.log('IF node data keys:', Object.keys(ifNodeData));\n\n// Return the status while preserving ALL data from both sources\nreturn {\n  json: {\n    // Start with ALL the merged line item data from the IF node\n    ...ifNodeData,\n    // Override with current HTTP response data (headers, statusCode, etc.)\n    ...item,\n    // Add the extracted status\n    status: status,\n    // Ensure signatureData is preserved from IF node (in case it got overwritten)\n    signatureData: ifNodeData.signatureData || null\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5088,-176],"id":"23497c5f-f0ff-4121-8328-5d78e91183a4","name":"Clean Status1"},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.properties.hs_object_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Manager Rejected\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2960,-640],"id":"d9c8e398-288d-463f-bbe7-6e258eaff8e2","name":"Manager Rejected","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.properties.hs_object_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Manager Rejected\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5600,-80],"id":"4fabfdd2-66a3-4d46-b975-7ace80c8bcad","name":"Manager Rejected1","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.properties.hs_object_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Manager Approved\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5600,-320],"id":"16e5dc85-d452-48fe-b74c-4412752f8ef4","name":"Manager Approved Status","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Get current Snowflake item (the one being processed in this iteration)\nconst snowflakeItem = $input.item.json;\n\n// Get transaction_rewards from the Clean Data node\nconst cleanDataNode = $('Clean Data').item.json;\nconst allTransactionRewards = cleanDataNode.transaction_rewards || [];\n\n// Get ticket_id from the First Variables node\nconst firstVariablesNode = $('First Variables').item.json;\nconst ticketId = firstVariablesNode.ticket_id;\n\n// Get the transaction IDs for this project\nconst projectTransactionIds = snowflakeItem.CLICKIDS.split(',').map(id => parseInt(id.trim()));\n\n// Filter transaction_rewards to only include this project's transactions\nconst filteredTransactionRewards = allTransactionRewards.filter(reward => \n  projectTransactionIds.includes(reward.TransactionID)\n);\n\nconst result = {\n  PROJECTID: snowflakeItem.PROJECTID,\n  successful_transaction_ids: snowflakeItem.CLICKIDS,\n  transaction_rewards: filteredTransactionRewards,\n  ticket_id: ticketId\n};\n\nconsole.log(`Project ${result.PROJECTID}: ${result.successful_transaction_ids}`);\nconsole.log(`Ticket ID: ${ticketId}`);\nconsole.log(`Filtered transaction rewards: ${filteredTransactionRewards.length}/${allTransactionRewards.length}`);\n\nreturn { json: result };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1120,-128],"id":"52bd363f-4bc6-4fa8-90c6-cc358f382aca","name":"Re-Clean Data"},{"parameters":{"assignments":{"assignments":[{"id":"e5571b33-60b1-42bb-adc1-cc5d7548f858","name":"ticket_id","value":"={{ $json.body.ticketId }}","type":"string"},{"id":"e6a81c1f-11c2-44f4-80a2-994f122fad54","name":"reconciliation_file","value":"={{ $json.body.reconciliation_file }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2432,-128],"id":"56e922f2-7321-4edf-8f4c-2bbcb0f00ff3","name":"First Variables"},{"parameters":{"method":"POST","url":"https://api-na1.hubapi.com/automation/v4/webhook-triggers/40213119/H7OXUX2","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"ticketId","value":"={{ $('Clean Status').first().json.signatureData.ticketId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4160,-368],"id":"882393a8-c499-45c9-80cc-dea42b67f6fa","name":"Assembly Webhook1","executeOnce":true,"credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"method":"POST","url":"https://api-na1.hubapi.com/automation/v4/webhook-triggers/40213119/H7OXUX2","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"ticketId","value":"={{ $('Clean Status1').first().json.signatureData.ticketId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5792,-320],"id":"ae445b43-8b96-4939-9db2-f0169ea1c391","name":"Assembly Webhook2","executeOnce":true,"credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"af8c5301-4709-4dae-9d82-4c25eb6e8607","leftValue":"={{ $json.properties.name }}","rightValue":"Sample","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[624,-128],"id":"07ffad07-cb70-49b8-a920-4a4ebde0610a","name":"Filter"},{"parameters":{"jsCode":"// ===========================================\n// ðŸ”„ Remove Duplicates + Add Signature Data\n// ===========================================\n\nconst currentItems = $input.all();\n\n// Try to get signature data directly from Generate Signature node\nlet generateSignatureData = [];\ntry {\n  generateSignatureData = $('Generate Signature').all();\n  console.log('âœ… Successfully accessed Generate Signature node');\n} catch (error) {\n  console.log('âŒ Could not access Generate Signature node:', error.message);\n  // Try alternative node name in case of exact name mismatch\n  try {\n    generateSignatureData = $('Generate Signature').all();\n    console.log('âœ… Found Generate Signature with alternative access');\n  } catch (error2) {\n    console.log('âŒ Still could not access Generate Signature node');\n  }\n}\n\nconsole.log('Current items count:', currentItems.length);\nconsole.log('Generate Signature items count:', generateSignatureData.length);\nconsole.log('Available project IDs:', generateSignatureData.map(sig => sig.json?.projectId || 'undefined'));\n\n// ===========================================\n// ðŸ§¹ Remove Duplicates (based on line item ID)\n// ===========================================\nconst uniqueItems = [];\nconst seenIds = new Set();\n\ncurrentItems.forEach(item => {\n  const itemId = item.json.id;\n  if (!seenIds.has(itemId)) {\n    seenIds.add(itemId);\n    uniqueItems.push(item);\n  }\n});\n\nconsole.log('Unique items count after deduplication:', uniqueItems.length);\n\n// ===========================================\n// ðŸ”— Add Signature Data to Each Item\n// ===========================================\nconst processedItems = [];\n\nuniqueItems.forEach((item, itemIndex) => {\n  const lineItem = item.json;\n  const billableEvent = lineItem.properties?.billable_event;\n  \n  // Simple approach: distribute signatures evenly across all unique items\n  let matchingSignature = null;\n  if (generateSignatureData.length > 0) {\n    // Use modulo to cycle through available signatures\n    const signatureIndex = itemIndex % generateSignatureData.length;\n    matchingSignature = generateSignatureData[signatureIndex]?.json;\n  }\n  \n  console.log(`Line item ${lineItem.id}: billable_event=${billableEvent}, assigned projectId=${matchingSignature?.projectId || 'none'}`);\n  \n  processedItems.push({\n    json: {\n      ...lineItem,\n      signatureData: matchingSignature || null,\n      properties: lineItem.properties,\n      id: lineItem.id\n    }\n  });\n});\n\nconsole.log('Final processed items:', processedItems.length);\nconsole.log('Items with signatures:', processedItems.filter(item => !!item.json.signatureData).length);\nconsole.log('Signature distribution:', processedItems.map(item => item.json.signatureData?.projectId || 'no-signature'));\n\nreturn processedItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[352,-128],"id":"49cbb317-72ad-46fe-89b0-0bdd5b33fd13","name":"De-Dup & Add Sig Back"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// ===========================================\n// ðŸ”— Merge HTTP Response with Switch Node Data\n// ===========================================\n\nconst httpResponse = $input.item.json;\nconst switchItems = $('Switch').all();\n\n// Find the matching item from the Switch node for this response\n// Since HTTP requests maintain item order, we can use $itemIndex\nconst switchItem = switchItems[$itemIndex];\n\nconsole.log('HTTP Response:', httpResponse);\nconsole.log('Switch item has signatureData:', !!switchItem?.json.signatureData);\nconsole.log('Project ID from signature:', switchItem?.json.signatureData?.projectId);\nconsole.log('Reconciliation type:', switchItem?.json.properties?.reconciliation_type);\n\nreturn {\n  json: {\n    // HTTP response data\n    ...httpResponse,\n    // Switch node data (including reconciliation info and signatureData)\n    ...switchItem?.json,\n    // Ensure signatureData is preserved\n    signatureData: switchItem?.json.signatureData || null,\n    // Ensure reconciliation info is preserved\n    properties: {\n      ...switchItem?.json.properties,\n      // Preserve any HTTP response properties if they exist\n      ...httpResponse.properties\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1712,-288],"id":"4112326c-f84b-4be4-9cc8-c6bba5a9038a","name":"Merge Reco and Info"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// ===========================================\n// ðŸ”— Merge HTTP Response with Switch Node Data\n// ===========================================\n\nconst httpResponse = $input.item.json;\nconst switchItems = $('Switch').all();\n\n// Find the matching item from the Switch node for this response\n// Since HTTP requests maintain item order, we can use $itemIndex\nconst switchItem = switchItems[$itemIndex];\n\nconsole.log('HTTP Response:', httpResponse);\nconsole.log('Switch item has signatureData:', !!switchItem?.json.signatureData);\nconsole.log('Project ID from signature:', switchItem?.json.signatureData?.projectId);\nconsole.log('Reconciliation type:', switchItem?.json.properties?.reconciliation_type);\n\nreturn {\n  json: {\n    // HTTP response data\n    ...httpResponse,\n    // Switch node data (including reconciliation info and signatureData)\n    ...switchItem?.json,\n    // Ensure signatureData is preserved\n    signatureData: switchItem?.json.signatureData || null,\n    // Ensure reconciliation info is preserved\n    properties: {\n      ...switchItem?.json.properties,\n      // Preserve any HTTP response properties if they exist\n      ...httpResponse.properties\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1712,0],"id":"f75feffa-229b-43f9-a14e-a4b7c0d6af9b","name":"Merge Reco and Info1"},{"parameters":{"httpMethod":"POST","path":"656f3ebe-e94d-47f6-8db3-18130bd3c93b","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[96,-896],"id":"21753257-a149-43d5-8e47-ad6d60addb76","name":"Webhook1","webhookId":"656f3ebe-e94d-47f6-8db3-18130bd3c93b","disabled":true},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/tickets/{{ $('First Variables').item.json.ticket_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"associations","value":"deals"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-432,416],"id":"3e9502b8-2955-408a-9d2b-799c1216d2f4","name":"HTTP Request: get dealid","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"operation":"executeQuery","query":"SELECT *, \nFROM OPS_AUTOMATION_DB.SURVEYS.NETSUITE_LINE_PROJECT_MAP\nWHERE projectid in ({{ $json.PROJECTID }})"},"type":"n8n-nodes-base.snowflake","typeVersion":1,"position":[-1072,320],"id":"837df6bd-fb15-475e-8be8-41848e66a87d","name":"NetSuitelLineItem","alwaysOutputData":true,"credentials":{"snowflake":{"id":"reIlyZhfAfZTYk8S","name":"Snowflake prodegeqa"}}},{"parameters":{"jsCode":"// Extract line item IDs from the response\nconst lineItemIds = $input.all()[0].json.results.map(result => result.id);\n\nif (lineItemIds.length === 0) {\n  console.log(\"No line items found for this deal\");\n  return [{ success: true, message: \"No line items to delete\", lineItemId: null }];\n}\n\n// Return each line item ID as a separate object\nreturn lineItemIds.map(id => ({\n  success: true,\n  lineItemId: id\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[0,416],"id":"b811f0dd-445c-4be4-9dc7-d0efa3d111cd","name":"cleanLineItems"},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.lineItemId }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"properties","value":"netsuite_line_id, line_,billable_event,name"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[208,416],"id":"452e62d2-f5fb-4ae8-adb6-c0937b3bdb2c","name":"HTTP Get NS_line_item values","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"url":"=https://api.hubapi.com/crm/v3/objects/deals/{{ $json.associations.deals.results[0].id }}/associations/line_items","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-224,416],"id":"5cf7baac-5cf3-4a17-a6e8-efb9449ae46f","name":"HTTP Get HS_line_items","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}},{"parameters":{"mode":"combine","advanced":true,"mergeByFields":{"values":[{"field1":"NETSUITELINEITEMID","field2":"properties.netsuite_line_id"}]},"joinMode":"keepEverything","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[880,288],"id":"a9210332-9d19-42fa-867a-7d1ba24d43fe","name":"Merge"},{"parameters":{"assignments":{"assignments":[{"id":"eb44415f-38ce-443a-825e-f33259bd253d","name":"id","value":"={{ $json.id }}","type":"number"},{"id":"de93b522-c788-4912-84b5-1beed514030b","name":"properties.billable_event","value":"={{ $json.properties.billable_event }}","type":"number"},{"id":"0962daf0-323c-4b75-98e9-112be4770740","name":"properties.createdate","value":"={{ $json.properties.createdate }}","type":"string"},{"id":"456735ec-fbc4-49df-931b-dcd268d3a8af","name":"properties.hs_lastmodifieddate","value":"={{ $json.properties.hs_lastmodifieddate }}","type":"string"},{"id":"7245531e-e0b8-402c-a017-09c1aa0ca5ac","name":"properties.hs_object_id","value":"={{ $json.properties.hs_object_id }}","type":"number"},{"id":"6d3aa425-b37c-4e47-9b1a-eeaad8b1a81e","name":"properties.line_","value":"={{ $json.properties.line_ }}","type":"number"},{"id":"1c302186-cff9-4528-b0d4-4da71562a212","name":"properties.name","value":"={{ $json.properties.name }}","type":"string"},{"id":"da327cc9-f660-478b-96e6-2653bbe4132d","name":"properties.netsuite_line_id","value":"={{ $json.properties.netsuite_line_id }}","type":"number"},{"id":"4725cb2c-8cc8-4ebf-bacc-ec641f7c7321","name":"createdAt","value":"={{ $json.createdAt }}","type":"string"},{"id":"088e93fc-73b5-4119-bb97-bcb7718e4e17","name":"updatedAt","value":"={{ $json.updatedAt }}","type":"string"},{"id":"ed4aec6d-fe31-4536-8300-7cf7187e2804","name":"archived","value":"={{ $json.archived }}","type":"boolean"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[640,416],"id":"faab9f13-2544-4501-834d-2ed754e2926f","name":"cleanJSON"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"83046a82-dc51-458a-8c2f-b7cb9b418cf6","leftValue":"={{ $json.properties.billable_event }}","rightValue":"={{ $('Webhook').first().json.body.billable_event }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"dcccfcf7-f2d6-4c60-b741-133039f73d56","leftValue":"={{ $json.properties.name }}","rightValue":"Sample","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[432,416],"id":"6aa88dbb-a93b-45b0-aeab-329971a51451","name":"Filter1"},{"parameters":{"method":"POST","url":"=https://surveypmr.prodegeapisqa.com/prodegemr/project-reconciliation-final","authentication":"genericCredentialType","genericAuthType":"httpCustomAuth","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/x-www-form-urlencoded\",\n  \"Accept\": \"application/x-www-form-urlencoded\"\n}","sendBody":true,"bodyParameters":{"parameters":[{"name":"request_date","value":"={{ $json.signatureData.request_date }}"},{"name":"prodege_project_id","value":"={{ $json.signatureData.projectId }}"},{"name":"reconciliation_note","value":"={{ $json.signatureData.reconciliation_note }}"},{"name":"signature","value":"={{ $json.signatureData.signature }}"},{"name":"successful_transaction_ids","value":"={{ $json.signatureData.successfulTransactionIds }}"},{"name":"transaction_rewards","value":"={{ $json.signatureData.transactionRewards }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1440,64],"id":"3230558e-62ce-4310-89a4-24fcb11a788e","name":"Complex Reconciliation2","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"},"httpCustomAuth":{"id":"K3SygLYbImTEQK8q","name":"peeqAPI Query Auth"}}},{"parameters":{"method":"POST","url":"=https://surveypmr.prodegeapisqa.com/prodegemr/project-reconciliation-final","authentication":"genericCredentialType","genericAuthType":"httpCustomAuth","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/x-www-form-urlencoded\",\n  \"Accept\": \"application/x-www-form-urlencoded\"\n}","sendBody":true,"bodyParameters":{"parameters":[{"name":"request_date","value":"={{ $json.signatureData.request_date }}"},{"name":"prodege_project_id","value":"={{ $json.signatureData.projectId }}"},{"name":"reconciliation_note","value":"={{ $json.signatureData.reconciliation_note }}"},{"name":"signature","value":"={{ $json.signatureData.signature }}"},{"name":"successful_transaction_ids","value":"={{ $json.signatureData.successfulTransactionIds }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1440,-240],"id":"8e2b8b01-11bf-4a80-b64e-ed0c79b158dd","name":"Simple Reconciliation1","credentials":{"hubspotAppToken":{"id":"g2yPcP4yBsSlHE4S","name":"HubSpot: N8N-SANDBOX-DISCO-2025_0623a"},"httpBearerAuth":{"id":"pJPACs6HjurDIrzA","name":"peeqAPI QA"},"httpCustomAuth":{"id":"K3SygLYbImTEQK8q","name":"peeqAPI Query Auth"}}},{"parameters":{"jsCode":"// Process each item and ensure the field is added to ALL items\nconst items = $input.all();\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  \n  // Check if NETSUITELINEITEMID exists and is not null\n  const hasLineItemId = item.json.NETSUITELINEITEMID != null;\n  \n  // Check if properties.netsuite_line_id exists and is not null\n  const hasLineId = item.json.properties?.netsuite_line_id != null;\n  \n  // Add the boolean field to EVERY item\n  item.json.matching_netsuite_ids = hasLineItemId && hasLineId;\n}\n\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1184,304],"id":"639d2ae0-2d5e-429e-b0e1-ef71a2226bf3","name":"lineItemIdMatch"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2224,32],"id":"29a53b0e-a8f5-4c95-9c42-4e3cba747b93","name":"Merge1"},{"parameters":{"operation":"executeQuery","query":"select  revenue ,count(clickid)\n\nFROM \n\nOPS_AUTOMATION_DB.SURVEYS.PROJECT_CLICK pc\n--LEFT JOIN stage.surveys.PROJECT_COMPLETION_TYPE ct on ct.completiontypeid = pc.completiontype\n\nwhere clickid in ({{ $json.signatureData.successfulTransactionIds }})\n\ngroup by 1"},"type":"n8n-nodes-base.snowflake","typeVersion":1,"position":[1408,-464],"id":"354b9978-8e32-4382-989a-49b8df21d0bf","name":"Snowflake1","alwaysOutputData":false,"executeOnce":false,"credentials":{"snowflake":{"id":"reIlyZhfAfZTYk8S","name":"Snowflake prodegeqa"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"55fe6939-3050-41b0-9425-e95f2ab18546","leftValue":"={{ $json.signatureData.transactionRewards.some(item => item.CPI > 0 || item.Reward > 0) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[208,-1088],"id":"cf97f633-00f0-4be7-b264-1cf5dd31865e","name":"If1","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"01a8e83d-7997-45c4-9d44-df1eb221258f","leftValue":"={{ $json.allMatched.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2032,-592],"id":"7ecfae7a-7f5b-426b-9169-df99d769ded0","name":"If2"},{"parameters":{"errorMessage":"Not all CPIS/Rewards an Quantities Matched Between Peeq/Client and Hubspot."},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[2304,-688],"id":"33b314d6-e984-42dd-8260-54d60be26504","name":"Stop and Error"},{"parameters":{"jsCode":"// Get transaction data from current input\nconst transactionItems = $input.all();\n\n// Get HubSpot data from Switch3 node\nlet hubspotData = [];\ntry {\n  const hubspotItems = $('Switch3').all();\n  hubspotData = hubspotItems.map(item => ({\n    id: item.json.id,\n    price: parseFloat(item.json.properties.price) || 0,\n    quantity: parseInt(item.json.properties.quantity) || 0\n  }));\n} catch (error) {\n  return {\n    json: {\n      error: 'Could not access HubSpot data from Switch3',\n      allMatched: false,\n      message: error.message\n    }\n  };\n}\n\n// Process transaction data to get CPI counts\nconst transactionData = [];\ntransactionItems.forEach((item, index) => {\n  try {\n    // Parse the transaction_rewards JSON string\n    const transactionRewards = JSON.parse(item.json.transaction_rewards);\n    \n    // Count transactions by CPI value\n    const cpiCounts = {};\n    transactionRewards.forEach(transaction => {\n      const cpi = transaction.CPI;\n      cpiCounts[cpi] = (cpiCounts[cpi] || 0) + 1;\n    });\n    \n    // Convert to array format for easier matching\n    Object.keys(cpiCounts).forEach(cpiValue => {\n      transactionData.push({\n        cpi: parseFloat(cpiValue),\n        count: cpiCounts[cpiValue]\n      });\n    });\n    \n    console.log(`Transaction Item ${index + 1} - CPI Counts:`, cpiCounts);\n  } catch (error) {\n    console.error(`Error parsing transaction_rewards for item ${index + 1}:`, error);\n  }\n});\n\nconsole.log('HubSpot Data:', hubspotData);\nconsole.log('Transaction Data (CPI/Count pairs):', transactionData);\n\n// Match HubSpot line items with transaction CPI data\nconst matches = [];\nconst unmatchedHubspot = [];\nconst unmatchedTransactions = [...transactionData]; // Copy to track unmatched\n\nhubspotData.forEach(hubspotItem => {\n  // Skip items with zero quantity (not billable)\n  if (hubspotItem.quantity === 0) {\n    console.log(`Skipping HubSpot item ${hubspotItem.id} - zero quantity`);\n    return;\n  }\n\n  let foundMatch = false;\n  \n  // Look for matching transaction data\n  for (let i = 0; i < unmatchedTransactions.length; i++) {\n    const transactionItem = unmatchedTransactions[i];\n    \n    if (hubspotItem.price === transactionItem.cpi && \n        hubspotItem.quantity === transactionItem.count) {\n      \n      matches.push({\n        hubspotId: hubspotItem.id,\n        hubspotPrice: hubspotItem.price,\n        hubspotQuantity: hubspotItem.quantity,\n        transactionCpi: transactionItem.cpi,\n        transactionCount: transactionItem.count\n      });\n      \n      // Remove from unmatched list\n      unmatchedTransactions.splice(i, 1);\n      foundMatch = true;\n      console.log(`âœ… Match found! HubSpot ID: ${hubspotItem.id}, Price: ${hubspotItem.price}, Qty: ${hubspotItem.quantity} matches CPI: ${transactionItem.cpi}, Count: ${transactionItem.count}`);\n      break;\n    }\n  }\n  \n  if (!foundMatch) {\n    unmatchedHubspot.push(hubspotItem);\n    console.log(`âŒ No match for HubSpot ID: ${hubspotItem.id}, Price: ${hubspotItem.price}, Qty: ${hubspotItem.quantity}`);\n  }\n});\n\n// Calculate totals for validation\nconst hubspotTotal = hubspotData.reduce((sum, item) => sum + (item.quantity * item.price), 0);\nconst transactionTotal = transactionData.reduce((sum, item) => sum + (item.count * item.cpi), 0);\n\nconst allMatched = unmatchedHubspot.length === 0 && unmatchedTransactions.length === 0;\n\n// Log unmatched items for debugging\nif (unmatchedTransactions.length > 0) {\n  console.log('âŒ Unmatched Transaction Data:', unmatchedTransactions);\n}\n\nconsole.log(`ðŸ“Š Summary - HubSpot items: ${hubspotData.length}, Transaction groups: ${transactionData.length}, Matches: ${matches.length}`);\nconsole.log(`ðŸ’° Revenue check - HubSpot total: ${hubspotTotal}, Transaction total: ${transactionTotal}`);\n\n// Return comprehensive results\nreturn {\n  json: {\n    reconciliationType: \"CPI Transaction Matching\",\n    allMatched: allMatched,\n    revenueMatched: hubspotTotal === transactionTotal,\n    summary: {\n      hubspotItems: hubspotData.length,\n      transactionGroups: transactionData.length,\n      matchedPairs: matches.length,\n      unmatchedHubspot: unmatchedHubspot.length,\n      unmatchedTransactions: unmatchedTransactions.length\n    },\n    financial: {\n      hubspotTotalRevenue: hubspotTotal,\n      transactionTotalRevenue: transactionTotal,\n      revenueDifference: hubspotTotal - transactionTotal\n    },\n    details: {\n      matches: matches,\n      unmatchedHubspotItems: unmatchedHubspot,\n      unmatchedTransactionItems: unmatchedTransactions,\n      hubspotData: hubspotData,\n      transactionData: transactionData\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1536,-1008],"id":"927a4694-670c-41ed-bfd8-e4eeec0f75df","name":"For Complex"},{"parameters":{"jsCode":"// Get Snowflake data from current input\nconst snowflakeItems = $input.all();\n\n// Get HubSpot data from Switch3 node (which contains the line items)\nlet hubspotData = [];\ntry {\n  const hubspotItems = $('Switch3').all();\n  hubspotData = hubspotItems.map(item => ({\n    id: item.json.id,\n    price: parseFloat(item.json.properties.price) || 0,\n    quantity: parseInt(item.json.properties.quantity) || 0\n  }));\n} catch (error) {\n  return {\n    json: {\n      error: 'Could not access HubSpot data from Switch3',\n      allMatched: false,\n      message: error.message\n    }\n  };\n}\n\n// Transform Snowflake data (rename columns to match expected structure)\nconst snowflakeData = snowflakeItems.map(item => ({\n  revenue: item.json.REVENUE || 0,\n  count: item.json[\"COUNT(CLICKID)\"] || 0\n}));\n\nconsole.log('HubSpot Data:', hubspotData);\nconsole.log('Snowflake Data:', snowflakeData);\n\n// For \"Full Simple\" reconciliation, we need to match:\n// - HubSpot line item quantities with Snowflake count\n// - HubSpot line item prices with Snowflake revenue\nconst matches = [];\nconst unmatchedHubspot = [];\nconst unmatchedSnowflake = [...snowflakeData]; // Copy to track unmatched\n\nhubspotData.forEach(hubspotItem => {\n  // Skip items with zero quantity (not billable)\n  if (hubspotItem.quantity === 0) {\n    console.log(`Skipping HubSpot item ${hubspotItem.id} - zero quantity`);\n    return;\n  }\n\n  let foundMatch = false;\n  \n  // Look for matching Snowflake data\n  for (let i = 0; i < unmatchedSnowflake.length; i++) {\n    const snowflakeItem = unmatchedSnowflake[i];\n    \n    if (hubspotItem.quantity === snowflakeItem.count && \n        hubspotItem.price === snowflakeItem.revenue) {\n      \n      matches.push({\n        hubspotId: hubspotItem.id,\n        quantity: hubspotItem.quantity,\n        price: hubspotItem.price,\n        snowflakeCount: snowflakeItem.count,\n        snowflakeRevenue: snowflakeItem.revenue\n      });\n      \n      // Remove from unmatched list\n      unmatchedSnowflake.splice(i, 1);\n      foundMatch = true;\n      console.log(`âœ… Match found! HubSpot ID: ${hubspotItem.id}, Qty: ${hubspotItem.quantity}, Price: ${hubspotItem.price}`);\n      break;\n    }\n  }\n  \n  if (!foundMatch) {\n    unmatchedHubspot.push(hubspotItem);\n    console.log(`âŒ No match for HubSpot ID: ${hubspotItem.id}, Qty: ${hubspotItem.quantity}, Price: ${hubspotItem.price}`);\n  }\n});\n\n// Calculate totals for validation\nconst hubspotTotal = hubspotData.reduce((sum, item) => sum + (item.quantity * item.price), 0);\nconst snowflakeTotal = snowflakeData.reduce((sum, item) => sum + (item.count * item.revenue), 0);\n\nconst allMatched = unmatchedHubspot.length === 0 && unmatchedSnowflake.length === 0;\n\nconsole.log(`ðŸ“Š Summary - Total HubSpot items: ${hubspotData.length}, Matched: ${matches.length}, Unmatched: ${unmatchedHubspot.length}`);\nconsole.log(`ðŸ’° Revenue check - HubSpot total: ${hubspotTotal}, Snowflake total: ${snowflakeTotal}`);\n\n// Return comprehensive results\nreturn {\n  json: {\n    reconciliationType: \"Full Simple\",\n    allMatched: allMatched,\n    revenueMatched: hubspotTotal === snowflakeTotal,\n    summary: {\n      hubspotItems: hubspotData.length,\n      snowflakeItems: snowflakeData.length,\n      matchedPairs: matches.length,\n      unmatchedHubspot: unmatchedHubspot.length,\n      unmatchedSnowflake: unmatchedSnowflake.length\n    },\n    financial: {\n      hubspotTotalRevenue: hubspotTotal,\n      snowflakeTotalRevenue: snowflakeTotal,\n      revenueDifference: hubspotTotal - snowflakeTotal\n    },\n    details: {\n      matches: matches,\n      unmatchedHubspotItems: unmatchedHubspot,\n      unmatchedSnowflakeItems: unmatchedSnowflake,\n      hubspotData: hubspotData,\n      snowflakeData: snowflakeData\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1632,-464],"id":"bcc971a2-1bbe-43da-912c-a5ca3f65aabd","name":"For Simple"},{"parameters":{"method":"PATCH","url":"=https://api.hubapi.com/crm/v3/objects/line_items/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"reconciliation_status\": \"Manager Rejected\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[352,-912],"id":"1c5dae2d-c0ac-46c2-ab1e-1783d99bc870","name":"put line item","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}},"disabled":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.signatureData.transactionRewards.every(item => item.CPI !== \"Empty\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"1b7c538d-35aa-42bd-b633-6c6f7148abd1"}],"combinator":"and"},"renameOutput":true,"outputKey":"Full Complex"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"709bb8a7-6116-4f3d-acdd-5739e33c6dd2","leftValue":"={{ $json.signatureData.transactionRewards.some(item => item.CPI === \"Empty\") && !$json.signatureData.transactionRewards.every(item => item.CPI === \"Empty\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Simple & Complex"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"875cf252-a728-4f4f-b60b-da9e887154fa","leftValue":"={{ $json.signatureData.transactionRewards.every(item => item.CPI === \"Empty\") }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Full Simple"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[752,-624],"id":"e7838b73-95cd-4d8f-9381-3263002cd2bf","name":"Switch3"},{"parameters":{"operation":"executeQuery","query":"select  revenue ,clickid\n\nFROM \n\nOPS_AUTOMATION_DB.SURVEYS.PROJECT_COMPLETION pc\n--LEFT JOIN stage.surveys.PROJECT_COMPLETION_TYPE ct on ct.completiontypeid = pc.completiontype\n\nwhere clickid in ({{ $json.simple_transactions }})\n\n--group by 1"},"type":"n8n-nodes-base.snowflake","typeVersion":1,"position":[1344,-688],"id":"8501228c-282b-443e-8926-675401cfabac","name":"Snowflake2","alwaysOutputData":false,"credentials":{"snowflake":{"id":"reIlyZhfAfZTYk8S","name":"Snowflake prodegeqa"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"n8n-nodes-base.removeDuplicates","typeVersion":2,"position":[1248,-464],"id":"200ae295-5486-49cb-82a9-d1788755e658","name":"Remove Duplicates"},{"parameters":{"options":{}},"type":"n8n-nodes-base.removeDuplicates","typeVersion":2,"position":[1296,-1008],"id":"f6251947-896b-445c-bcd2-0eaa4d337859","name":"Remove Duplicates1"},{"parameters":{"assignments":{"assignments":[{"id":"840dfb9f-4086-4d87-8768-ea08791eca36","name":"transaction_rewards","value":"={{ $json.signatureData.transactionRewards }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1072,-960],"id":"8630d04d-789d-4315-9d4e-716a065f4c4e","name":"set_trans_rewards"},{"parameters":{"assignments":{"assignments":[{"id":"00cdd0c6-3c96-4239-adcf-ee2301ba8126","name":"signatureData.successfulTransactionIds","value":"={{ $json.signatureData.successfulTransactionIds }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1072,-464],"id":"6e739485-57aa-4fdf-9acb-c3f2d1651135","name":"set_trans"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eb427cf3-6717-4d57-826e-625ccfcfd93e","leftValue":"={{ $json.properties.billable_event }}","rightValue":"={{ $('Webhook').item.json.body.billable_event }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"02e55a39-190d-489a-a412-897332f39a17","leftValue":"={{ $json.properties.name }}","rightValue":"Sample","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[544,-368],"id":"e86e20ac-d526-4b13-ab3f-b6d8d15a8fb2","name":"Match Line Item to Ticket1"},{"parameters":{"jsCode":"// Get all input items\nconst items = $input.all();\n\n// Process each item\nconst results = [];\n\nitems.forEach((inputItem, index) => {\n  const item = inputItem.json;\n  const transactionRewards = item.signatureData.transactionRewards || [];\n  \n  console.log(`Processing item ${index + 1}, Project ID: ${item.signatureData.projectId}`);\n  console.log(`Total transactions: ${transactionRewards.length}`);\n  \n  // Separate transactions by CPI status\n  const complexTransactions = [];\n  const simpleTransactionIds = [];\n  \n  transactionRewards.forEach(transaction => {\n    if (transaction.CPI !== \"Empty\" && transaction.CPI !== null && transaction.CPI !== undefined) {\n      // Non-empty CPI - add to complex transactions\n      complexTransactions.push({\n        TransactionID: transaction.TransactionID,\n        CPI: transaction.CPI,\n        Reward: transaction.Reward\n      });\n      console.log(`  Complex transaction: ${transaction.TransactionID} (CPI: ${transaction.CPI})`);\n    } else {\n      // Empty CPI - add transaction ID to simple list\n      simpleTransactionIds.push(transaction.TransactionID);\n      console.log(`  Simple transaction: ${transaction.TransactionID} (CPI: Empty)`);\n    }\n  });\n  \n  // Create the output structure\n  const result = {};\n  \n  // Add complex transactions as JSON string if any exist\n  if (complexTransactions.length > 0) {\n    result.complex_transactions = JSON.stringify(complexTransactions);\n    console.log(`  Created complex_transactions with ${complexTransactions.length} transactions`);\n  }\n  \n  // Add simple transaction IDs as comma-separated string if any exist\n  if (simpleTransactionIds.length > 0) {\n    result.simple_transactions = simpleTransactionIds.join(',');\n    console.log(`  Created simple_transactions with ${simpleTransactionIds.length} transaction IDs`);\n  }\n  \n  // Only add result if there are transactions to process\n  if (Object.keys(result).length > 0) {\n    results.push(result);\n  }\n  \n  console.log(`  Result for item ${index + 1}:`, result);\n});\n\nconsole.log(`\\nTotal results created: ${results.length}`);\n\n// Return results in the expected format\nreturn results.map(result => ({ json: result }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[992,-688],"id":"22fd7901-77bd-4ffd-9051-5ec4c34f15f7","name":"Seperate Complex and Simple"},{"parameters":{"assignments":{"assignments":[{"id":"840dfb9f-4086-4d87-8768-ea08791eca36","name":"complex_transactions","value":"={{ $json.complex_transactions }}","type":"string"},{"id":"ef5f052c-7014-42d7-8936-041325e13ee5","name":"simple_transactions","value":"={{ $json.simple_transactions }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1168,-688],"id":"06a48ed6-5702-4dd9-97f8-2ca8fa6a6fa9","name":"Set CPIS"},{"parameters":{"jsCode":"// Get transaction data from current input\nconst transactionItems = $input.all();\n\n// Get HubSpot data from Switch3 node\nlet hubspotData = [];\ntry {\n  const hubspotItems = $('Switch3').all();\n  hubspotData = hubspotItems.map(item => ({\n    id: item.json.id,\n    price: parseFloat(item.json.properties.price) || 0,\n    quantity: parseInt(item.json.properties.quantity) || 0\n  }));\n} catch (error) {\n  return {\n    json: {\n      error: 'Could not access HubSpot data from Switch3',\n      allMatched: false,\n      message: error.message\n    }\n  };\n}\n\n// Process transaction data to get CPI counts\nconst transactionData = [];\ntransactionItems.forEach((item, index) => {\n  try {\n    // Parse the transaction_rewards JSON string\n    const transactionRewards = JSON.parse(item.json.transaction_rewards);\n    \n    // Count transactions by CPI value\n    const cpiCounts = {};\n    transactionRewards.forEach(transaction => {\n      const cpi = transaction.CPI;\n      cpiCounts[cpi] = (cpiCounts[cpi] || 0) + 1;\n    });\n    \n    // Convert to array format for easier matching\n    Object.keys(cpiCounts).forEach(cpiValue => {\n      transactionData.push({\n        cpi: parseFloat(cpiValue),\n        count: cpiCounts[cpiValue]\n      });\n    });\n    \n    console.log(`Transaction Item ${index + 1} - CPI Counts:`, cpiCounts);\n  } catch (error) {\n    console.error(`Error parsing transaction_rewards for item ${index + 1}:`, error);\n  }\n});\n\nconsole.log('HubSpot Data:', hubspotData);\nconsole.log('Transaction Data (CPI/Count pairs):', transactionData);\n\n// Match HubSpot line items with transaction CPI data\nconst matches = [];\nconst unmatchedHubspot = [];\nconst unmatchedTransactions = [...transactionData]; // Copy to track unmatched\n\nhubspotData.forEach(hubspotItem => {\n  // Skip items with zero quantity (not billable)\n  if (hubspotItem.quantity === 0) {\n    console.log(`Skipping HubSpot item ${hubspotItem.id} - zero quantity`);\n    return;\n  }\n\n  let foundMatch = false;\n  \n  // Look for matching transaction data\n  for (let i = 0; i < unmatchedTransactions.length; i++) {\n    const transactionItem = unmatchedTransactions[i];\n    \n    if (hubspotItem.price === transactionItem.cpi && \n        hubspotItem.quantity === transactionItem.count) {\n      \n      matches.push({\n        hubspotId: hubspotItem.id,\n        hubspotPrice: hubspotItem.price,\n        hubspotQuantity: hubspotItem.quantity,\n        transactionCpi: transactionItem.cpi,\n        transactionCount: transactionItem.count\n      });\n      \n      // Remove from unmatched list\n      unmatchedTransactions.splice(i, 1);\n      foundMatch = true;\n      console.log(`âœ… Match found! HubSpot ID: ${hubspotItem.id}, Price: ${hubspotItem.price}, Qty: ${hubspotItem.quantity} matches CPI: ${transactionItem.cpi}, Count: ${transactionItem.count}`);\n      break;\n    }\n  }\n  \n  if (!foundMatch) {\n    unmatchedHubspot.push(hubspotItem);\n    console.log(`âŒ No match for HubSpot ID: ${hubspotItem.id}, Price: ${hubspotItem.price}, Qty: ${hubspotItem.quantity}`);\n  }\n});\n\n// Calculate totals for validation\nconst hubspotTotal = hubspotData.reduce((sum, item) => sum + (item.quantity * item.price), 0);\nconst transactionTotal = transactionData.reduce((sum, item) => sum + (item.count * item.cpi), 0);\n\nconst allMatched = unmatchedHubspot.length === 0 && unmatchedTransactions.length === 0;\n\n// Log unmatched items for debugging\nif (unmatchedTransactions.length > 0) {\n  console.log('âŒ Unmatched Transaction Data:', unmatchedTransactions);\n}\n\nconsole.log(`ðŸ“Š Summary - HubSpot items: ${hubspotData.length}, Transaction groups: ${transactionData.length}, Matches: ${matches.length}`);\nconsole.log(`ðŸ’° Revenue check - HubSpot total: ${hubspotTotal}, Transaction total: ${transactionTotal}`);\n\n// Return comprehensive results\nreturn {\n  json: {\n    reconciliationType: \"CPI Transaction Matching\",\n    allMatched: allMatched,\n    revenueMatched: hubspotTotal === transactionTotal,\n    summary: {\n      hubspotItems: hubspotData.length,\n      transactionGroups: transactionData.length,\n      matchedPairs: matches.length,\n      unmatchedHubspot: unmatchedHubspot.length,\n      unmatchedTransactions: unmatchedTransactions.length\n    },\n    financial: {\n      hubspotTotalRevenue: hubspotTotal,\n      transactionTotalRevenue: transactionTotal,\n      revenueDifference: hubspotTotal - transactionTotal\n    },\n    details: {\n      matches: matches,\n      unmatchedHubspotItems: unmatchedHubspot,\n      unmatchedTransactionItems: unmatchedTransactions,\n      hubspotData: hubspotData,\n      transactionData: transactionData\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1680,-688],"id":"ea79aa12-b4a3-44cd-8254-334640602aa7","name":"CPI Check"},{"parameters":{"jsCode":"// Get data from previous nodes\nconst snowflakeData = $input.all(); // Snowflake results with individual CLICKID/REVENUE pairs\nconst previousNodeData = $('Set CPIS').all(); // Get complex and simple transactions\n\nconsole.log('Snowflake Data:', snowflakeData);\nconsole.log('Previous Node Data:', previousNodeData);\n\nconst results = [];\n\npreviousNodeData.forEach((item, index) => {\n  console.log(`\\nProcessing item ${index + 1}:`);\n  \n  // Parse complex transactions\n  let complexTransactions = [];\n  if (item.json.complex_transactions) {\n    try {\n      complexTransactions = JSON.parse(item.json.complex_transactions);\n      console.log(`Found ${complexTransactions.length} complex transactions`);\n    } catch (error) {\n      console.error('Error parsing complex transactions:', error);\n    }\n  }\n  \n  // Get simple transaction IDs\n  let simpleTransactionIds = [];\n  if (item.json.simple_transactions) {\n    simpleTransactionIds = item.json.simple_transactions.split(',').map(id => parseInt(id.trim()));\n    console.log(`Found ${simpleTransactionIds.length} simple transaction IDs:`, simpleTransactionIds);\n  }\n  \n  // Create a map of transaction ID to CPI from Snowflake data\n  const transactionCpiMap = {};\n  snowflakeData.forEach(snowflakeItem => {\n    const clickId = snowflakeItem.json.CLICKID;\n    const revenue = snowflakeItem.json.REVENUE;\n    transactionCpiMap[clickId] = revenue;\n    console.log(`Snowflake mapping: Transaction ${clickId} -> CPI ${revenue}`);\n  });\n  \n  // Convert simple transactions to complex format using Snowflake mappings\n  const convertedSimpleTransactions = [];\n  \n  simpleTransactionIds.forEach(transactionId => {\n    if (transactionCpiMap[transactionId] !== undefined) {\n      const cpi = transactionCpiMap[transactionId];\n      convertedSimpleTransactions.push({\n        TransactionID: transactionId,\n        CPI: cpi,\n        Reward: \"Empty\"\n      });\n      console.log(`  Converted transaction ${transactionId} with CPI ${cpi}`);\n    } else {\n      console.warn(`  Warning: No CPI found for transaction ${transactionId} in Snowflake data`);\n      // Optionally, you can still include it with CPI as \"Empty\" or skip it\n      convertedSimpleTransactions.push({\n        TransactionID: transactionId,\n        CPI: \"Empty\",\n        Reward: \"Empty\"\n      });\n    }\n  });\n  \n  // Combine complex and converted simple transactions\n  const allTransactions = [...complexTransactions, ...convertedSimpleTransactions];\n  \n  console.log(`Total combined transactions: ${allTransactions.length}`);\n  console.log(`(${complexTransactions.length} complex + ${convertedSimpleTransactions.length} converted simple)`);\n  \n  // Sort by TransactionID for consistent output (optional)\n  allTransactions.sort((a, b) => a.TransactionID - b.TransactionID);\n  \n  // Create the final result\n  const result = {\n    transaction_rewards: JSON.stringify(allTransactions)\n  };\n  \n  results.push(result);\n  console.log('Final result for item:', result);\n});\n\nconsole.log(`\\nTotal results created: ${results.length}`);\n\n// Return results in the expected format\nreturn results.map(result => ({ json: result }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1504,-688],"id":"0eba49f5-bf49-47aa-8a12-75a1698b03c3","name":"GroupTransactionIDs"},{"parameters":{"method":"POST","url":"https://api.hubspot.com/crm/v3/objects/notes","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"properties\": {\n    \"hs_timestamp\": {{ new Date($now.toISO()).getTime() }},\n    \"hs_note_body\": \"Reconciliation n8n Execution: https://prodegellc.app.n8n.cloud/{{ $workflow.id }}/executions/{{ $execution.id }}\"\n  },\n  \"associations\": [\n    {\n      \"to\": {\n        \"id\": {{ $json.body.ticketId }}\n      },\n      \"types\": [\n        {\n          \"associationCategory\": \"HUBSPOT_DEFINED\",\n          \"associationTypeId\": 228\n        }\n      ]\n    }\n  ]\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2640,-400],"id":"918204e0-0ac2-4f6a-883e-63d5a272cade","name":"createEngagmentTracker","credentials":{"httpBearerAuth":{"id":"oPwelkmcY7W8TTeJ","name":"Bearer Auth HubSpot N8N-SANDBOX-DISCO-2025_0623a"}}}],"connections":{"HTTP Get pf_line_item":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"HTTP Get pf_line_item values","type":"main","index":0}]]},"Generate Signature":{"main":[[{"node":"GET Deal on Ticket","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"timeOffset","type":"main","index":0}]]},"timeOffset":{"main":[[{"node":"Generate Signature","type":"main","index":0}]]},"StatusCode":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Get Project Status","type":"main","index":0}],[{"node":"Manager Rejected","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"First Variables","type":"main","index":0},{"node":"createEngagmentTracker","type":"main","index":0}]]},"Get Reconciliation File ID":{"main":[[{"node":"Get Reconciliation File Signed URL","type":"main","index":0}]]},"Get Reconciliation File Signed URL":{"main":[[{"node":"Break Out URL and Name","type":"main","index":0}]]},"Break Out URL and Name":{"main":[[{"node":"Get File Data","type":"main","index":0}]]},"Get File Data":{"main":[[{"node":"Clean Data","type":"main","index":0}]]},"Clean Data":{"main":[[{"node":"Snowflake","type":"main","index":0}]]},"Split Out3":{"main":[[{"node":"Get Line Items Details","type":"main","index":0}]]},"GET Deal on Ticket":{"main":[[{"node":"GET Line Items","type":"main","index":0}]]},"Match Line Item to Ticket":{"main":[[{"node":"Switch","type":"main","index":0}]]},"GET Line Items":{"main":[[{"node":"Split Out3","type":"main","index":0}]]},"Get Line Items Details":{"main":[[{"node":"De-Dup & Add Sig Back","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Simple Reconciliation1","type":"main","index":0}],[{"node":"Complex Reconciliation2","type":"main","index":0}]]},"Snowflake":{"main":[[{"node":"Re-Clean Data","type":"main","index":0},{"node":"NetSuitelLineItem","type":"main","index":0}]]},"Get Project Status":{"main":[[{"node":"Clean Status","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Auto Approved Status","type":"main","index":0}],[{"node":"Pending Approval Status","type":"main","index":0}]]},"Pending Approval Status":{"main":[[{"node":"Wait 1 Day","type":"main","index":0}]]},"Get Project Status1":{"main":[[{"node":"Clean Status1","type":"main","index":0}]]},"Wait 1 Day":{"main":[[{"node":"timeOffset1","type":"main","index":0}]]},"timeOffset1":{"main":[[{"node":"Generate Signature1","type":"main","index":0}]]},"Generate Signature1":{"main":[[{"node":"Get Project Status1","type":"main","index":0}]]},"Clean Status":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Clean Status1":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"Manager Approved Status","type":"main","index":0}],[{"node":"Manager Rejected1","type":"main","index":0}],[{"node":"Wait 1 Day","type":"main","index":0}]]},"Re-Clean Data":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"First Variables":{"main":[[{"node":"Get Reconciliation File ID","type":"main","index":0}]]},"Manager Approved Status":{"main":[[{"node":"Assembly Webhook2","type":"main","index":0}]]},"Auto Approved Status":{"main":[[{"node":"Assembly Webhook1","type":"main","index":0}]]},"Assembly Webhook1":{"main":[[]]},"Filter":{"main":[[{"node":"Match Line Item to Ticket","type":"main","index":0}]]},"De-Dup & Add Sig Back":{"main":[[{"node":"Filter","type":"main","index":0},{"node":"Match Line Item to Ticket1","type":"main","index":0}]]},"Merge Reco and Info":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Merge Reco and Info1":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"HTTP Request: get dealid":{"main":[[{"node":"HTTP Get HS_line_items","type":"main","index":0}]]},"NetSuitelLineItem":{"main":[[{"node":"HTTP Request: get dealid","type":"main","index":0},{"node":"Merge","type":"main","index":0}]]},"cleanLineItems":{"main":[[{"node":"HTTP Get NS_line_item values","type":"main","index":0}]]},"HTTP Get NS_line_item values":{"main":[[{"node":"Filter1","type":"main","index":0}]]},"HTTP Get HS_line_items":{"main":[[{"node":"cleanLineItems","type":"main","index":0}]]},"cleanJSON":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Filter1":{"main":[[{"node":"cleanJSON","type":"main","index":0}]]},"Complex Reconciliation2":{"main":[[{"node":"Merge Reco and Info1","type":"main","index":0}]]},"Simple Reconciliation1":{"main":[[{"node":"Merge Reco and Info","type":"main","index":0}]]},"Merge":{"main":[[{"node":"lineItemIdMatch","type":"main","index":0}]]},"lineItemIdMatch":{"main":[[{"node":"Merge1","type":"main","index":2}]]},"Merge1":{"main":[[{"node":"StatusCode","type":"main","index":0}]]},"If1":{"main":[[],[]]},"Snowflake1":{"main":[[{"node":"For Simple","type":"main","index":0}]]},"If2":{"main":[[{"node":"Stop and Error","type":"main","index":0}]]},"For Complex":{"main":[[{"node":"If2","type":"main","index":0}]]},"For Simple":{"main":[[{"node":"If2","type":"main","index":0}]]},"Switch3":{"main":[[{"node":"set_trans_rewards","type":"main","index":0}],[{"node":"Seperate Complex and Simple","type":"main","index":0}],[{"node":"set_trans","type":"main","index":0}]]},"Remove Duplicates":{"main":[[{"node":"Snowflake1","type":"main","index":0}]]},"Remove Duplicates1":{"main":[[{"node":"For Complex","type":"main","index":0}]]},"set_trans_rewards":{"main":[[{"node":"Remove Duplicates1","type":"main","index":0}]]},"set_trans":{"main":[[{"node":"Remove Duplicates","type":"main","index":0}]]},"Match Line Item to Ticket1":{"main":[[{"node":"Switch3","type":"main","index":0}]]},"Manager Rejected":{"main":[[]]},"Seperate Complex and Simple":{"main":[[{"node":"Set CPIS","type":"main","index":0}]]},"Set CPIS":{"main":[[{"node":"Snowflake2","type":"main","index":0}]]},"Snowflake2":{"main":[[{"node":"GroupTransactionIDs","type":"main","index":0}]]},"GroupTransactionIDs":{"main":[[{"node":"CPI Check","type":"main","index":0}]]},"CPI Check":{"main":[[{"node":"If2","type":"main","index":0}]]}},"authors":"Steven Vassallo","name":null,"description":null},"tags":[{"updatedAt":"2025-09-16T22:03:04.244Z","createdAt":"2025-09-16T22:03:04.244Z","id":"1JleW3VaKeNkbHMv","name":"catalog"},{"updatedAt":"2025-08-31T22:15:28.746Z","createdAt":"2025-08-31T22:15:28.746Z","id":"MSbYUejSnKte9BCA","name":"insights"},{"updatedAt":"2025-06-06T18:17:40.197Z","createdAt":"2025-06-06T18:17:16.177Z","id":"QSobdHvedr4NOCqq","name":"hubspot HS"},{"updatedAt":"2025-04-30T04:41:58.583Z","createdAt":"2025-04-30T04:41:58.583Z","id":"s7RJscwb71jTz2ag","name":"Snowflake"}]}