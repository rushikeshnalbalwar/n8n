{"updatedAt":"2025-12-18T22:18:39.775Z","createdAt":"2025-12-08T18:17:51.113Z","id":"fFjPmKdDsGAU2ZUD","name":"MANUAL COPY OF Peeq BID automation (BAI-63)","active":true,"isArchived":false,"nodes":[{"parameters":{"jsCode":"// Import necessary library\nconst crypto = require('crypto');\n\n// Function to decrypt encrypted strings\nconst decryptString = (encryptedText, password) => {\n    const algorithm = 'aes-256-cbc';\n    const key = crypto.scryptSync(password, 'salt', 32);\n    \n    const parts = encryptedText.split(':');\n    const iv = Buffer.from(parts[0], 'hex');\n    const encrypted = parts[1];\n    \n    const decipher = crypto.createDecipheriv(algorithm, key, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    \n    return decrypted;\n};\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// Obtain current time in milliseconds for the request_date parameter\nconst requestDate = Date.now();\n\n// ðŸ” GET ENCRYPTED KEYS FROM ENVIRONMENT VARIABLES AND DECRYPT\nconst encryptedApiKey = $vars.e_apikey;\nconst encryptedSecretKey = $vars.e_secret;\nconst encryptionPassword = $vars.e_password;\n\n// Validate environment variables are set\nif (!encryptedApiKey) {\n    throw new Error('âŒ Environment variable \"e_apikey\" is not set or is empty');\n}\nif (!encryptedSecretKey) {\n    throw new Error('âŒ Environment variable \"e_secret\" is not set or is empty');\n}\nif (!encryptionPassword) {\n    throw new Error('âŒ Environment variable \"e_password\" is not set or is empty');\n}\n\nconsole.log('âœ… All environment variables found');\n\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('ðŸ”“ Keys decrypted successfully');\n\n// Get other data from input\nconst countryId = $input.first().json.country_id;\n\n// Get criteria from the criteria node\nconst answer_text = $('criteria').first().json;\n\n// Define the parameters for the request\nconst parameters = {\n    apik: apiKey,              // Your API key\n    request_date: requestDate, // Timestamp in milliseconds\n    country_id: countryId      // The ID for the specific country\n};\n\n// Generate the signature\nconst signature = generateSignature(parameters, secretKey);\n\n// Define the base URL and path for the request\nconst baseUrl = 'https://surveypmr.prodegeapisqa.com/prodegemr';\nconst path = '/lookup-question-by-country';\nconst fullUrl = `${baseUrl}${path}`;\n\n// Return all necessary details to complete the request\nreturn {\n    fullUrl,      // The complete URL for the GET request\n    parameters,   // Parameters required for the request\n    signature,    // Generated signature for authentication\n    requestDate,  // Timestamp used in the request\n    answer_text      // Criteria from the criteria node\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[976,288],"id":"f21a946b-d764-4c08-9966-b547523498e0","name":"Questions By CountryID"},{"parameters":{"jsCode":"// Get input\nconst items = $input.all();\nconst outputItems = [];\n\n// Look for exclude list across all items (if provided)\nlet excludeList = [];\nfor (const item of items) {\n  if (item.json.Exclude) {\n    excludeList = item.json.Exclude;\n    break;\n  }\n}\n\n// Helper: push question if not excluded\nfunction pushQuestion(q) {\n  if (!excludeList.includes(q.question_id)) {\n    outputItems.push({ json: q });\n  }\n}\n\nfor (const item of items) {\n  const data = item.json;\n\n  try {\n    // --- CASE 1: OLD STRUCTURE (MCP tool inside intermediateSteps) ---\n    if (data.intermediateSteps) {\n      const mcpStep = data.intermediateSteps.find(\n        step => step.action && step.action.tool === 'lookup_questions_by_country'\n      );\n\n      if (mcpStep && mcpStep.observation) {\n        const observationArray = JSON.parse(mcpStep.observation);\n        const mcpResponseText = observationArray[0].text;\n        const mcpData = JSON.parse(mcpResponseText);\n\n        if (Array.isArray(mcpData.questions)) {\n          mcpData.questions.forEach(q => pushQuestion(q));\n        }\n        continue;\n      }\n    }\n\n    // --- CASE 2: NEW STRUCTURE (RAW QUESTION OBJECTS LIKE THE ONE YOU SENT) ---\n    // If it has \"question_id\", treat it as a direct question object\n    if (data.question_id) {\n      pushQuestion(data);\n      continue;\n    }\n\n    // --- CASE 3: If the node passes an array of questions ---\n    if (Array.isArray(data)) {\n      data.forEach(q => {\n        if (q.question_id) pushQuestion(q);\n      });\n      continue;\n    }\n\n  } catch (error) {\n    outputItems.push({\n      json: {\n        error: \"Parsing error\",\n        message: error.message,\n        raw: data\n      }\n    });\n  }\n}\n\n// If nothing produced\nif (outputItems.length === 0) {\n  return [\n    {\n      json: {\n        message: \"No questions found or all filtered out\"\n      }\n    }\n  ];\n}\n\nreturn outputItems;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2784,288],"id":"5c6443e3-184f-41c6-a35d-f6f57199dc79","name":"cleaned json"},{"parameters":{"assignments":{"assignments":[{"id":"607df5e8-7715-4c32-9ab9-d174f14bf163","name":"URL","value":"https://surveypmr.prodegeapisqa.com/prodegemr","type":"string"},{"id":"f2506a11-6c0d-465f-bbcb-5c2c5dfdd793","name":"country_id","value":"={{ $json.output.country_id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[752,288],"id":"f6fb20cf-6baa-46a4-a657-d6d405fead8e","name":"setCountryRequestFields"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"90b87dcc-8e15-4e3e-9acb-93164bd4f66e","leftValue":"={{ $json.output.match }}","rightValue":"true","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[3584,288],"id":"18444a29-be50-4aa0-92ef-75dd5a94cb40","name":"Filter1"},{"parameters":{"jsCode":"// Import necessary library\nconst crypto = require('crypto');\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// Obtain current time in milliseconds for the request_date parameter\nconst requestDate = Date.now();\n\n// Get all input items\nconst allInputs = $input.all();\n\n// Extract common data from the first item (should be same across all)\nconst firstInput = allInputs[0].json;\nconst apiKey = firstInput.apiKey;\nconst secretKey = firstInput.secretKey;\nconst countryId = firstInput.country_id;\nconst loi = firstInput.LOI;\nconst ir = firstInput.IR;\n\n// Collect all questions exactly as they are (as strings)\nconst questionsArray = allInputs.map(item => item.json.questions);\n\n// Convert questions array to JSON string for the API\nconst questionsJson = JSON.stringify(questionsArray);\n\n// Extract unique question IDs\nconst questionIds = [...new Set(allInputs.map(item => {\n    const questionData = JSON.parse(item.json.questions);\n    return questionData.questionId;\n}))];\nconst questionIdsString = questionIds.join(',');\n\nconsole.log('All input items:', JSON.stringify(allInputs, null, 2));\nconsole.log('Collected questions array:', questionsArray);\nconsole.log('Questions JSON string:', questionsJson);\n\n// Parameters for signature generation\nconst parametersForSignature = {\n    apik: apiKey,\n    request_date: requestDate\n};\n\n// Generate the signature\nconst signature = generateSignature(parametersForSignature, secretKey);\n\n\n// Return the data for HTTP request\nreturn {\n    //apik: apiKey,\n    request_date: requestDate,\n    country_id: countryId,\n    questions: questionsJson, // Send questions as JSON string\n    LOI: loi,\n    IR: ir,\n    signature: signature,\n    fullUrl: \"https://surveypmr.prodegeapisqa.com/prodegemr/feasibility-run\",\n    question_ids: questionIdsString\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4032,384],"id":"61bf733c-3ac6-4afd-b8af-42cd795b80d3","name":"Compile Feasibility"},{"parameters":{"assignments":{"assignments":[{"id":"607df5e8-7715-4c32-9ab9-d174f14bf163","name":"URL","value":"https://surveypmr.prodegeapisqa.com/prodegemr","type":"string"},{"id":"f2506a11-6c0d-465f-bbcb-5c2c5dfdd793","name":"country_id","value":"={{ $('setCountryRequestFields').first().json.country_id }}","type":"number"},{"id":"14519b0c-8549-494a-90ba-2014ef116cf2","name":"questions","value":"={{ $json.output }}","type":"string"},{"id":"48431f14-5485-4bd1-9098-72d0e4e707f2","name":"LOI","value":"={{ $('criteria').first().json.criteria.loi }}","type":"string"},{"id":"b602df91-cc6c-4036-afe3-b2978e34042c","name":"IR","value":"={{ $('criteria').first().json.criteria.ir }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3808,384],"id":"0e707469-3286-4e91-b9e4-6bcc92efed7d","name":"setFeasibility"},{"parameters":{"assignments":{"assignments":[{"id":"e60df256-5e28-432b-97dd-42cf321d92e0","name":"quotas","value":"={{ $json.data }}","type":"object"},{"id":"c3003dea-a1de-4c9a-b38f-d8d7e5a1364d","name":"quotas.criteria","value":"={{ $('criteria').first().json.criteria }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[6016,704],"id":"42087b4d-e5dc-4f64-8784-80640a3ee4a8","name":"results"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1968,464],"id":"48947895-58c9-48c6-a8af-b4114c3b3718","name":"OpenAI Chat Model6","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"jsonSchemaExample":"{\n  \"quotas\": [\n    {\n      \"country\": \"United States\",\n      \"loi\": \"15 minutes\",\n      \"quota\": 1000,\n      \"criteria\": \"Age 18-65, household income >$50K, drives a honda\",\n      \"car_question\": \"True\",\n      \"income_irregular\": \"False\",\n      \"ir\": \"25%\"\n    },\n    {\n      \"country\": \"United Kingdom\", \n      \"loi\": \"12 minutes\",\n      \"quota\": 500,\n      \"criteria\": \"Age 25-55, employed full-time\",\n      \"car_question\": \"False\",\n      \"income_irregular\": \"False\",\n      \"ir\": \"30%\"\n    },\n    {\n      \"country\": \"Canada\",\n      \"loi\": \"18 minutes\", \n      \"quota\": 750,\n      \"criteria\": \"Age 21-60, urban residents\",\n      \"car_question\": \"False\",\n      \"income_irregular\": \"False\",\n      \"ir\": \"35%\"\n    },\n    {\n      \"country\": \"Australia\",\n      \"loi\": \"14 minutes\",\n      \"quota\": 400,\n      \"criteria\": \"Age 30-65, have children under 18, make over $17,000\",\n      \"car_question\": \"False\",\n      \"income_irregular\": \"True\",\n      \"ir\": \"20%\"\n    }\n  ]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-1840,464],"id":"bdaa8d4b-19ed-40fd-aca8-c9a02fa09d7c","name":"Structured Output Parser"},{"parameters":{"promptType":"define","text":"=Email: {{ $json.email }}","hasOutputParser":true,"options":{"systemMessage":"=You are an assistant that analyzes incoming project bid request emails to extract demographic and sample feasibility questions only.\n\nYour job:\n1. Read the email content\n2. Identify only questions about SAMPLE DEMOGRAPHICS and RESPONDENT CHARACTERISTICS\n   - Age groups, gender distribution, geographic location\n   - Health conditions, lifestyle characteristics, behavior patterns  \n   - Incidence rates for specific populations\n   - Sample composition and quotas\n   - Respondent screening criteria\n\nIGNORE internal questions like:\n- \"Can we deliver by X date?\" \n- \"Do we have enough people?\"\n- \"Can we meet the timeline?\"\n- Questions about company capabilities\n\nONLY extract questions about the TARGET AUDIENCE/SAMPLE, such as:\n- \"What's the feasibility of recruiting adults aged 18-25?\"\n- \"Can we achieve 34% incidence rate for digestive health consumers?\"\n- \"Can we get equal gender distribution?\"\n\nCONVERT the plain text answers into more digestable survey answers. For example:\n\n\"Lives in the USA\" turns into \"United States\"\n\"We need ages 25-34 and 60+\" turns into \"Ages 25-34 and 60+\"\n\nInclude the required sample size mapped to each.\nIf the criteria is related to cars makes and models make Car_Question as \"True\".\nIf the criteria mentions income amounts that are NOT in increments of $5,000, mark income_irregular as \"True\".\n\nExample:\nSample Email input:\nHi team, we have a new survey we want to run. I need 100 responses for males, age 25-35, living in the US, making $17,000 or more annually. Would like to get this done by next month.\n\nSample json output:\n{\n  \"Country\": \"United States\",\n  \"Criteria\": [\n    \"Ages 25-35\",\n    \"Male\", \n    \"Income $17,000+\"\n  ],\n  \"Car_Question\": \"False\",\n  \"income_irregular\": \"True\"\n}\n\nSample Email input 2:\nHi team, we have a new survey we want to run. I need 100 responses for males, drive a lexus, living in the US, making $10,000 or more annually. Would like to get this done by next month.\n\nSample json output:\n{\n  \"Country\": \"United States\",\n  \"Criteria\": [\n    \"Drive a lexus\",\n    \"Male\", \n    \"Income $10,000+\"\n  ],\n  \"Car_Question\": \"True\",\n  \"income_irregular\": \"False\"\n}\n\nReturn only valid JSON with no explanations.","maxIterations":5}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-1968,240],"id":"72099a8a-df7d-4d39-85d4-d920b8bbc6b1","name":"Email Analyst"},{"parameters":{"fieldToSplitOut":"output.quotas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-1168,240],"id":"4080e122-0d6c-4315-8e11-2b35581c6e75","name":"Split Out1"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-720,336],"id":"f0af9bb0-ee0b-4a34-a122-43609ac830b5","name":"Loop Over Items1"},{"parameters":{"authentication":"serviceAccount","operation":"append","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Email Analyst Agent Output":"={{ $json.output.quotas }}","Email Request":"={{ $('setEmail').item.json.email }}","submittedAt":"={{ $('setEmail').item.json.submittedAt }}","Link to Execution":"=https://app.n8n.cloud/workflow/{{ $workflow.id }}/executions/{{ $execution.id }}"},"matchingColumns":[],"schema":[{"id":"submittedAt","displayName":"submittedAt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Email Request","displayName":"Email Request","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Email Analyst Agent Output","displayName":"Email Analyst Agent Output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Question Agent Ouput","displayName":"Question Agent Ouput","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Feasibility Results","displayName":"Feasibility Results","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Link to Execution","displayName":"Link to Execution","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"n8n form link","displayName":"n8n form link","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-1616,240],"id":"014f7229-4347-452b-849d-7c9b28de5a7d","name":"Append row in sheet","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"quotas"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-496,240],"id":"87812ece-25fd-43e6-a931-683ad2174f4c","name":"Aggregate"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"submittedAt","lookupValue":"={{ $('setEmail').first().json.submittedAt }}"}]},"options":{"returnFirstMatch":true}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[4032,80],"id":"4f0d3958-686f-4070-aebd-ae8fbfcb4376","name":"Get Row","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"authentication":"serviceAccount","operation":"update","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Question Agent Ouput":"={{ $json[\"Question Agent Ouput\"] }}, {{ JSON.stringify($('Aggregate1').item.json.output) }}","submittedAt":"={{ $('setEmail').first().json.submittedAt }}"},"matchingColumns":["submittedAt"],"schema":[{"id":"submittedAt","displayName":"submittedAt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Email Request","displayName":"Email Request","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Email Analyst Agent Output","displayName":"Email Analyst Agent Output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Question Agent Ouput","displayName":"Question Agent Ouput","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Feasibility Results","displayName":"Feasibility Results","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Link to Execution","displayName":"Link to Execution","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"n8n form link","displayName":"n8n form link","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[4256,80],"id":"eda5c5ef-c050-4a64-b123-5dd3542091c8","name":"Update Row","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"assignments":{"assignments":[{"id":"40d9d304-9a9d-4663-9b8f-275afe52678b","name":"criteria.country","value":"={{ $json.country }}","type":"string"},{"id":"d153080a-647b-4db8-b2bb-69426a229a07","name":"criteria.loi","value":"={{ $json.loi }}","type":"string"},{"id":"edbb9fcd-7c72-487b-b230-d4bd1aae7227","name":"criteria.quota","value":"={{ $json.quota }}","type":"string"},{"id":"921ec425-2436-484b-8171-7567feb957b0","name":"criteria.ir","value":"={{ $json.ir }}","type":"string"},{"id":"c2b6fa58-5a95-4546-85aa-9ca4ec21a91e","name":"criteria.criteria","value":"={{ $json.criteria }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-496,432],"id":"335436dd-209a-41e8-a534-2fe1a4ed7f42","name":"criteria"},{"parameters":{"assignments":{"assignments":[{"id":"87b37d9d-4c8f-4018-ad1f-72ec948c4e98","name":"output","value":"={{ $('Email Analyst').item.json.output }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1392,240],"id":"96e11bae-a0e8-4edc-a961-f66df886764f","name":"setOutput"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"submittedAt","lookupValue":"={{ $('setEmail').first().json.submittedAt }}"}]},"options":{"returnFirstMatch":true}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-272,240],"id":"b523528f-c701-4b0a-88ea-c2403b7519dd","name":"Get Row1","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"authentication":"serviceAccount","operation":"update","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Feasibility Results":"={{ $('Aggregate').item.json.quotas }}","submittedAt":"={{ $('setEmail').first().json.submittedAt }}"},"matchingColumns":["submittedAt"],"schema":[{"id":"submittedAt","displayName":"submittedAt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Email Request","displayName":"Email Request","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Email Analyst Agent Output","displayName":"Email Analyst Agent Output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Question Agent Ouput","displayName":"Question Agent Ouput","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Feasibility Results","displayName":"Feasibility Results","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Link to Execution","displayName":"Link to Execution","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"n8n form link","displayName":"n8n form link","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-48,240],"id":"1ba58613-7729-449e-86d5-155a54cc6c24","name":"Update Row1","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1017c600-c588-4626-9320-69004d4c976b","leftValue":"={{ $json.output.country_id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[528,432],"id":"f91bfc8a-c721-4242-a109-38ba119d443c","name":"If"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"submittedAt","lookupValue":"={{ $('setEmail').first().json.submittedAt }}"}]},"options":{"returnFirstMatch":true}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[752,528],"id":"5c19a4e5-2da2-412c-a7d2-2b6a8d4809b2","name":"Get Row2","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"authentication":"serviceAccount","operation":"update","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"submittedAt":"={{ $('setEmail').first().json.submittedAt }}","Feasibility Results":"ERROR: No country specified in email"},"matchingColumns":["submittedAt"],"schema":[{"id":"submittedAt","displayName":"submittedAt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Email Request","displayName":"Email Request","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Email Analyst Agent Output","displayName":"Email Analyst Agent Output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Question Agent Ouput","displayName":"Question Agent Ouput","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Feasibility Results","displayName":"Feasibility Results","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[976,528],"id":"218601bc-6eff-40ec-99b2-b473c241f25e","name":"Update Row2","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{"timeout":60000,"maxRetries":5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3248,512],"id":"58826b14-1067-488f-82df-739710b655c9","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"promptType":"define","text":"={{ $json }}","hasOutputParser":true,"options":{"systemMessage":"=Review the question and its answers against this survey feasibility request to determine if it is a match.\n\nCriteria:\n{{ $('criteria').first().json.criteria.criteria }}\n\nFor each question, determine if it matches and is found in the targeting criteria:\n- For questions with options: match against the specific option values\n- For numeric questions (like age): determine if the question is relevant to the criteria, even without specific options\n- For single-select questions: determine if the question is relevant to the criteria and if there are answer options that are relevant to the criteria\n\n**CRITICAL MATCHING RULES:**\n- **EXACT CONTEXT MATCHING**: The question must match the EXACT context of the criteria\n  - If criteria says \"Asthma patients\" â†’ only match questions about the RESPONDENT having asthma\n  - If criteria says \"Male\" â†’ only match questions about the RESPONDENT'S gender\n  - DO NOT match questions about household members, family members, or other people\n  - DO NOT match questions that ask about \"anyone else\" or \"others in household\"\n- **DIRECT RELEVANCE ONLY**: If the question topic is not DIRECTLY and EXPLICITLY mentioned in the criteria, mark as FALSE\n- **RESPONDENT-FOCUSED**: Only match questions that target the survey respondent themselves, not their household/family\n\n**EXAMPLES OF INCORRECT MATCHES:**\n- Criteria: \"Asthma patients\" + Question: \"Has anyone else in your household been diagnosed with asthma?\" â†’ FALSE (asks about others, not respondent)\n- Criteria: \"Male\" + Question: \"What is your spouse's gender?\" â†’ FALSE (asks about spouse, not respondent)\n\nOutput the result in the following JSON format:\n\n{\n  \"questionId\": \"The question ID\",\n  \"question_name\": \"The question name\", \n  \"question_text\": \"The question text\",\n  \"optionId\": \"The answer/option ID, or 'RANGE' for numeric questions, or empty for open-ended\",\n  \"option_text\": \"The answer/option result/text, or the required range/value for numeric questions\",\n  \"match\": true or false if we need the question for the feasibility request\n}\n\nSpecial handling for numeric questions:\n- If {{ $json.question_type }} is \"Numeric\" \n  - Set optionId to \"RANGE\" and option_text to the required range (e.g., \"30-39\")\n- If {{ $json.question_type }} is \"Single-Select\"\n  - Set optionId to the option ID or ID's that match the criteria\n\n**Remember: Only match questions that directly target the survey respondent themselves and exactly match the criteria context.**","maxIterations":5}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[3232,288],"id":"f40680b4-bc87-47b8-beda-4dce85dfb374","name":"QuestionIdentification1","executeOnce":false,"alwaysOutputData":true},{"parameters":{"jsonSchemaExample":"{\n  \"questionId\": \"1\",\n  \"question_name\": \"Age\",\n  \"question_text\": \"What is your age?\",\n  \"optionId\": \"1\",\n  \"option_text\": \"24\",\n  \"match\": true\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[3376,512],"id":"6a6706db-719b-4373-a257-430f1d41170e","name":"Structured Output Parser4"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"output"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[3808,80],"id":"8ce69386-59f9-4e94-91d3-e6d663a80d43","name":"Aggregate1"},{"parameters":{"authentication":"appToken","resource":"engagement","operation":"get","engagementId":{"__rl":true,"value":"={{ $json.engagmentId }}","mode":"id"}},"type":"n8n-nodes-base.hubspot","typeVersion":2.2,"position":[-3632,400],"id":"dfe443e7-3c5e-42b9-b54a-36ddd0f0785f","name":"Get an engagement","credentials":{"hubspotAppToken":{"id":"PlnQEFCxdSC4xSy9","name":"HubSpot n8n-HubSpot-PRODUCTION_20464009-202506-fef"}}},{"parameters":{"assignments":{"assignments":[{"id":"40a62e39-0863-4eae-8b10-873830c4069b","name":"engagmentId","value":"={{ $json.link.split('engagement=')[1]?.split('&')[0] }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3856,400],"id":"b4245508-5975-48bb-800b-c877d31afd1c","name":"setEngagmentId"},{"parameters":{"assignments":{"assignments":[{"id":"40a62e39-0863-4eae-8b10-873830c4069b","name":"link","value":"={{ $json['Hubspot Email Engagment Link'] }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-4080,400],"id":"c07c50ff-c493-4a6e-b17d-1455720320e6","name":"setLink"},{"parameters":{"assignments":{"assignments":[{"id":"6ebfb9fe-4aa7-4cb2-be29-9e518635df52","name":"data","value":"={{ $json.data }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2768,240],"id":"c35827fc-9c8b-4087-86db-ac3dafe27990","name":"setText"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-2544,464],"id":"b39a00af-000b-4aa3-bd27-14a9c262bd63","name":"OpenAI Chat Model3","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"jsonSchemaExample":"{\n\t\"bidRequest\": \"men in USA that have dogs\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-2384,464],"id":"18c5e212-197c-48d7-810e-fca2f41dca35","name":"Structured Output Parser1"},{"parameters":{"promptType":"define","text":"=Request: {{ $json.data }}","hasOutputParser":true,"options":{"systemMessage":"Review the given request and extract the initial Bid request from it. Do not summarize or consolidate any parts of the bid request."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-2544,240],"id":"7aeabd60-e102-4a12-981e-b0bb5b8ea65c","name":"Email Extractor"},{"parameters":{"assignments":{"assignments":[{"id":"8084fe08-51e6-4a8e-b7e9-eb345781a1dd","name":"email","value":"={{ $json.output.bidRequest }}","type":"string"},{"id":"bb3abe6f-0d12-4e35-a4f0-f3659b18f1ce","name":"submittedAt","value":"={{ $now}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2192,240],"id":"8aab3f95-2dd8-463a-85d3-3ca4e1a673f2","name":"setEmail"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6e76c7e4-25fe-440f-bc38-db5a430c6ebf","leftValue":"={{ $json.car_question }}","rightValue":"True","operator":{"type":"string","operation":"contains"}},{"id":"18977b2f-c658-4517-9308-fc4d2e924b7d","leftValue":"={{ $json.income_irregular }}","rightValue":"True","operator":{"type":"string","operation":"contains"}}],"combinator":"or"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-944,240],"id":"8a862196-7510-43f8-9d47-7635c0e8edc6","name":"If1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-720,144],"id":"9fafbff2-cc4c-4c2a-b92b-78074256e018","name":"No Operation, do nothing"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation (BAI-63)","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1321003384,"mode":"list","cachedResultName":"QuestionIDs to Exclude","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=1321003384"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2112,112],"id":"c7b09685-5df2-40b0-aaca-00da73f4e39e","name":"Get Exclude QID List","executeOnce":true,"credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"Exclude"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[2336,112],"id":"176dd60c-800f-48f4-9542-47de552270cf","name":"Combine Exclude"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2560,288],"id":"3081fcc7-1118-4428-8393-07db98dae17b","name":"Merge"},{"parameters":{"promptType":"define","text":"=Analyze this feasibility request and remove any similar or duplicate questions in the targeting criteria.\n\nRequest Data: {{ JSON.stringify($json) }}\n\nSteps:\n1. Identify similar questions (same topic, condition, demographic, or similar answer options).\n2. If similar questions exist, query Snowflake for completes and keep only the question with the highest completes.\n3. Preserve the full structure of the request except the optimized targeting-related questions and normalized LOI and IR.\n\nThen produce a `targeting_criteria` field formatted as a **JSON string**, using:\n- BETWEEN for numeric ranges (e.g., 18â€“29)\n- OR for discrete sets of precodes\n\nFormat example:\n\"[{\\\"question_id\\\":1,\\\"operator\\\":\\\"BETWEEN\\\",\\\"precodes\\\":[18,29]},{\\\"question_id\\\":3,\\\"operator\\\":\\\"OR\\\",\\\"precodes\\\":[1]},{\\\"question_id\\\":236,\\\"operator\\\":\\\"OR\\\",\\\"precodes\\\":[4]}]\"\n\nReturn ONLY the final JSON object with no additional text. Example structure:\n{\n  \"request_date\": 1764020943370,\n  \"country_id\": \"1\",\n  \"questions\": \"[...]\",\n  \"LOI\": \"25\",\n  \"IR\": \"7\",\n  \"signature\": \"...\",\n  \"fullUrl\": \"...\",\n  \"targeting_criteria\": \"[{\\\"question_id\\\":1,\\\"operator\\\":\\\"BETWEEN\\\",\\\"precodes\\\":[18,29]}]\"\n}","hasOutputParser":true,"options":{"systemMessage":"=You are a feasibility optimization agent that processes and optimizes survey targeting requests.\n\nYour tasks:\n\nParse the incoming feasibility request and identify similar or duplicate questions in the targeting portion.\n\nDetermine similarity based on:\n- Same topic or demographic\n- Same medical condition\n- Same or nearly identical answer options\n\nWhen similar questions are detected:\n- Extract their question IDs\n- Query the Snowflake tool for completion counts\n- Keep the question with the highest completes\n- Remove the others\n\nMaintain the exact structure of the request except for the optimized question list.\n\nNormalize LOI and IR fields:\n- Convert LOI to a plain number by removing any text like \"min\", \"minutes\", \"mins\", etc. (e.g., \"25 min\" â†’ \"25\")\n- Convert IR to a plain number by removing the \"%\" symbol (e.g., \"7%\" â†’ \"7\")\n\nAfter optimization, you MUST generate a targeting_criteria JSON string where each final question is formatted as one of the following:\n\nOR operator â€” for discrete precodes\n{\"question_id\": X, \"operator\": \"OR\", \"precodes\": [v1, v2, v3]}\n\nBETWEEN operator â€” only for numeric ranges\n{\"question_id\": X, \"operator\": \"BETWEEN\", \"precodes\": [min, max]}\n\nRules:\n- Only \"OR\" or \"BETWEEN\" operators may be used\n- Use \"BETWEEN\" only if the data clearly represents a numeric range\n- Use \"OR\" for all discrete lists\n- The entire targeting_criteria must be returned as a stringified JSON array\n\nDo not modify any other fields in the request.\n\nCRITICAL OUTPUT REQUIREMENT:\nYou MUST respond with ONLY valid JSON matching the exact structure provided in the prompt. \nDo NOT include any explanation, reasoning, or text outside the JSON.\nDo NOT say \"Agent stop\" or any other concluding remarks.\nDo NOT wrap the output in markdown code blocks.\nStart your response with { and end with }\nOutput ONLY the JSON object, nothing else.","maxIterations":5}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[4448,384],"id":"b3b872ed-0d80-4ebf-86c9-3b96aeee9023","name":"FinalQuestion Check"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{"timeout":60000,"maxRetries":5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[4256,608],"id":"0ea09d8d-f924-4051-875e-0c164604ae9a","name":"OpenAI Chat Model8","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"test_session"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[4384,608],"id":"e1c9de8b-27f1-4c03-b269-6cfa20eb63cd","name":"Simple Memory5"},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1.1,"position":[4512,608],"id":"ccf65cfa-bb2d-49b7-b461-de7030e82cf4","name":"Think5"},{"parameters":{"operation":"executeQuery","query":"SELECT\n  substr (a.questionid, 1) as QuestionID,\n  MAX(q.QuestionName) as QuestionName,\n  p.COUNTRYNAME as Country,\n  c.country_key,\n  COUNT(distinct a.projectid) as Count\nFROM\n  OPS_AUTOMATION_DB.surveys.qual_questions a\n  JOIN OPS_AUTOMATION_DB.surveys.project p on p.projectid = a.projectid\n  JOIN OPS_AUTOMATION_DB.dwstage.mm_country_dim c on c.country = p.countryname\n  LEFT JOIN OPS_AUTOMATION_DB.prodege.profile_question q on q.ExtQuestionID = a.QuestionID\n  AND q.extprofiletypeid = 1\nWHERE\n  p.pmr_status != 'PENDING'\n -- and p.apiuserid \n  AND p.createdon >= dateadd(YEAR,-1,CURRENT_DATE)\n  AND p.createdon <= CURRENT_DATE\n  -- AND c.country_key IN (@ Country @)\n  AND a.questionid in ({{ $json.question_ids }})\n  AND c.country_key = {{ $json.country_id }}\nGROUP BY a.questionid, 3,4\nORDER BY 3, a.questionid"},"type":"n8n-nodes-base.snowflakeTool","typeVersion":1,"position":[4640,608],"id":"7b64be24-be8f-44e9-92ed-d9d2ad6ee557","name":"Snowflake","credentials":{"snowflake":{"id":"gyAQtZa8Xv82pKrh","name":"Snowflake SUPPORT n8n-support-gservice-2025oct"}}},{"parameters":{"jsonSchemaExample":"[\n  {\n    \"request_date\": 1764020943370,\n    \"country_id\": \"1\",\n    \"questions\": \"[\\\"{\\\\\\\"questionId\\\\\\\":\\\\\\\"3\\\\\\\",\\\\\\\"question_name\\\\\\\":\\\\\\\"Gender\\\\\\\",\\\\\\\"question_text\\\\\\\":\\\\\\\"I am...\\\\\\\",\\\\\\\"optionId\\\\\\\":\\\\\\\"1\\\\\\\",\\\\\\\"option_text\\\\\\\":\\\\\\\"Male\\\\\\\",\\\\\\\"match\\\\\\\":true}\\\",\\\"{\\\\\\\"questionId\\\\\\\":\\\\\\\"395\\\\\\\",\\\\\\\"question_name\\\\\\\":\\\\\\\"Ailments 1\\\\\\\",\\\\\\\"question_text\\\\\\\":\\\\\\\"Have you been diagnosed with any of the following illnesses/conditions? Note that the information will be kept in strictest confidence.\\\\\\\",\\\\\\\"optionId\\\\\\\":\\\\\\\"17\\\\\\\",\\\\\\\"option_text\\\\\\\":\\\\\\\"Asthma\\\\\\\",\\\\\\\"match\\\\\\\":true}\\\",\\\"{\\\\\\\"questionId\\\\\\\":\\\\\\\"400\\\\\\\",\\\\\\\"question_name\\\\\\\":\\\\\\\"Sufferer Ailments 1\\\\\\\",\\\\\\\"question_text\\\\\\\":\\\\\\\"Do you suffer from any of the following illnesses/conditions?\\\\\\\",\\\\\\\"optionId\\\\\\\":\\\\\\\"17\\\\\\\",\\\\\\\"option_text\\\\\\\":\\\\\\\"Asthma\\\\\\\",\\\\\\\"match\\\\\\\":true}\\\"]\",\n    \"LOI\": \"\",\n    \"IR\": \"\",\n    \"signature\": \"64Qh9cmf1rAs755wrYfsnJUg-0D-JA2427WjyFKbBvo\",\n    \"fullUrl\": \"https://surveypmr.prodegeapisqa.com/prodegemr/feasibility-run\",\n\n    \"targeting_criteria\": [\n      {\n        \"question_id\": 1,\n        \"operator\": \"BETWEEN\",\n        \"precodes\": [21, 25]\n      },\n      {\n        \"question_id\": 3,\n        \"operator\": \"OR\",\n        \"precodes\": [1]\n      },\n      {\n        \"question_id\": 24,\n        \"operator\": \"OR\",\n        \"precodes\": [\"90703\", \"90245\", \"90815\"]\n      }\n    ]\n  }\n]\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[4768,608],"id":"a03433bc-912d-4e5e-9b47-2f631e613663","name":"Structured Output Parser9"},{"parameters":{"jsCode":"// Import necessary library\nconst crypto = require('crypto');\n\n// Function to decrypt encrypted strings\nconst decryptString = (encryptedText, password) => {\n    const algorithm = 'aes-256-cbc';\n    const key = crypto.scryptSync(password, 'salt', 32);\n    \n    const parts = encryptedText.split(':');\n    const iv = Buffer.from(parts[0], 'hex');\n    const encrypted = parts[1];\n    \n    const decipher = crypto.createDecipheriv(algorithm, key, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    \n    return decrypted;\n};\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// Obtain current time in milliseconds for the request_date parameter\nconst requestDate = Date.now();\n\n// Get data from previous node\nconst inputData = $input.first().json;\n\n// ðŸ” GET ENCRYPTED KEYS FROM ENVIRONMENT VARIABLES AND DECRYPT\nconst encryptedApiKey = $vars.e_apikey;\nconst encryptedSecretKey = $vars.e_secret;\nconst encryptionPassword = $vars.e_password;\n\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('ðŸ”“ Keys decrypted successfully');\n\n// Parse the questions data\nlet matchedQuestions = [];\ntry {\n    const questionsData = JSON.parse(inputData.questions);\n    matchedQuestions = Array.isArray(questionsData) ? questionsData : [questionsData];\n} catch (error) {\n    console.error('Error parsing questions:', error);\n    matchedQuestions = [];\n}\n\n// Build targeting criteria exactly as shown in docs\nconst targetingCriteria = [];\n\nmatchedQuestions.forEach(question => {\n    if (question.match === \"True\" && question.questionId) {\n        let criteriaItem = {};\n        \n        // Build exactly as shown in the documentation\n        if (question.questionId === 1) {\n            criteriaItem = {\n                \"question_id\": 1,\n                \"operator\": \"BETWEEN\", \n                \"precodes\": [21, 25]\n            };\n        } else if (question.questionId === 3) {\n            criteriaItem = {\n                \"question_id\": 3,\n                \"operator\": \"OR\",\n                \"precodes\": [1]\n            };\n        } else if (question.questionId === 24) {\n            criteriaItem = {\n                \"question_id\": 24,\n                \"operator\": \"OR\",\n                \"precodes\": [\"90703\", \"90245\", \"90815\"]\n            };\n        } else {\n            // Default for other question IDs\n            criteriaItem = {\n                \"question_id\": question.questionId,\n                \"operator\": \"OR\",\n                \"precodes\": [1]\n            };\n        }\n        \n        targetingCriteria.push(criteriaItem);\n    }\n});\n\n// Convert to JSON string for the API (this is what gets sent)\nconst targetingCriteriaJson = JSON.stringify(targetingCriteria);\n\nconsole.log('Targeting criteria array:', targetingCriteria);\nconsole.log('Targeting criteria JSON:', targetingCriteriaJson);\n\n// Parameters for signature generation\nconst parametersForSignature = {\n    apik: apiKey,\n    request_date: requestDate\n};\n\n// Generate the signature\nconst signature = generateSignature(parametersForSignature, secretKey);\n\n// Return the data for HTTP request\nreturn {\n    //apik: apiKey,\n    request_date: requestDate,\n    targeting_criteria: targetingCriteriaJson, // Send as JSON string\n    signature: signature,\n    fullUrl: \"https://surveypmr.prodegeapisqa.com/prodegemr/feasibility-run\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-272,432],"id":"71974205-5840-4234-a67e-b829cdad7228","name":"Code in JavaScript"},{"parameters":{"url":"=https://surveypmr.prodegeapis.com/prodegemr/lookup-country-all","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"request_date","value":"={{ $json.request_date }}"},{"name":"signature","value":"={{ $json.signature }}"}]},"options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-48,432],"id":"f11979d1-63fe-4f67-bae1-a15fc5e3dc7e","name":"Get Country ID","credentials":{"httpQueryAuth":{"id":"V3Xxf7Ey1rzsqLV1","name":"Peeq Prod Query Auth"}}},{"parameters":{"url":"=https://surveypmr.prodegeapis.com/prodegemr/lookup-question-by-country","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"request_date","value":"={{ $json.parameters.request_date }}"},{"name":"signature","value":"={{ $json.signature }}"},{"name":"country_id","value":"={{ $json.parameters.country_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1888,384],"id":"8bea8056-53dc-4d18-ab27-4cac25377e70","name":"Get Questions by Country","credentials":{"httpQueryAuth":{"id":"V3Xxf7Ey1rzsqLV1","name":"Peeq Prod Query Auth"}}},{"parameters":{"promptType":"define","text":"=input:  {{ $json.data }}\n\ncountry: {{ $('criteria').item.json.criteria.country }}","hasOutputParser":true,"options":{"systemMessage":"You are a data filtering assistant. Your task is to:\n\n1. Parse the input JSON data containing a list of countries\n2. Find the country that matches the specified country name or country code (case-insensitive)\n3. Return ONLY the matching country's properties as separate fields in JSON format\n\nRules:\n- Match against both country_name and country_code fields\n- Be flexible with matching (e.g., \"United States\", \"USA\", \"US\" should all match)\n- If no match is found, return null for all fields and set error message\n- Return ONLY valid JSON with these exact field names, no additional text\n\nRequired output format (exact field names):\n{\n  \"country_id\": <number or null>,\n  \"country_name\": \"<string or null>\",\n  \"country_code\": \"<string or null>\"\n}\n\nIf not found:\n{\n  \"country_id\": null,\n  \"country_name\": null,\n  \"country_code\": null,\n  \"error\": \"Country not found\"\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[176,432],"id":"43973d43-bf51-4a0b-b53a-384c9de52a99","name":"AI Agent","onError":"continueErrorOutput"},{"parameters":{"model":{"__rl":true,"value":"gpt-5","mode":"list","cachedResultName":"gpt-5"},"options":{"timeout":60000,"maxRetries":5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[176,656],"id":"8e7a3d12-a4b6-4dbc-b8f9-09e088389a94","name":"OpenAI Chat Model5","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"jsonSchemaExample":"{\n  \"country_id\": 1,\n  \"country_name\": \"USA\",\n  \"country_code\": \"US\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[304,656],"id":"3d81d7ad-8f9a-41be-aca6-0f636b8fbf30","name":"Structured Output Parser3"},{"parameters":{"jsCode":"// Parse the stringified JSON data\nconst parsedData = JSON.parse($input.first().json.data);\n\n// Extract the questions array\nconst questions = parsedData.questions;\n\n// Return each question as its own item\nreturn questions.map(question => ({\n  json: question\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2112,384],"id":"f075af2f-ae72-4779-8a6b-448f75fe7a2a","name":"Split Out"},{"parameters":{"jsCode":"// Get the criteria_words from the \"clean criteria\" node\nconst criteriaWords = $('clean criteria').first().json.criteria_words || '';\n\n// Split into array, trim, and lowercase\nconst criteriaList = criteriaWords.split(',').map(c => c.trim().toLowerCase());\n\n// Filter items where question_text, question_name, or any option_text contains any criteria word\nreturn $input.all().filter(item => {\n  const question = item.json;\n\n  // Lowercase fields for comparison\n  const questionText = (question.question_text || '').toLowerCase();\n  const questionName = (question.question_name || '').toLowerCase();\n\n  // Check if any criteria word matches question_text or question_name\n  const matchesQuestion = criteriaList.some(criteria => \n    questionText.includes(criteria) || questionName.includes(criteria)\n  );\n\n  // Check if any criteria word matches any option_text\n  const matchesOptions = question.options && question.options.length > 0\n    ? question.options.some(option => {\n        const optionText = (option.option_text || '').toLowerCase();\n        return criteriaList.some(criteria => optionText.includes(criteria));\n      })\n    : false;\n\n  // Keep if matches question OR options\n  return matchesQuestion || matchesOptions;\n\n}).map(item => ({ json: item.json }));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2336,384],"id":"43520ac2-2517-4ce8-8094-36b810569375","name":"Filter out by Answer_text OR Question_text"},{"parameters":{"model":{"__rl":true,"value":"gpt-5-nano","mode":"list","cachedResultName":"gpt-5-nano"},"options":{"timeout":60000,"maxRetries":5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1200,608],"id":"651303ad-181d-4375-9d7c-ece95f1adcb0","name":"OpenAI Chat Model10","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1.1,"position":[1456,608],"id":"1186f021-7004-453c-8e0f-88dbe702f7d1","name":"Think"},{"parameters":{"sessionIdType":"customKey","sessionKey":"optimization_session"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[1328,608],"id":"9a4c826b-daec-4136-8481-3973b634cdb3","name":"Simple Memory"},{"parameters":{"promptType":"define","text":"=Execute your function and output it appended to the original input.","hasOutputParser":true,"options":{"systemMessage":"=You are a keyword extraction agent.\n\nTask:\nFrom the input criteria in {{ $json.answer_text.criteria.criteria }}, extract **all relevant keywords**, including both:\n\n1. **Specific terms** (e.g., \"Male\", \"Asthma\", \"Dog Owners\")  \n2. **Broader conceptual categories** (e.g., \"gender\", \"patients\", \"ownership\", \"children\", \"education\")\n\nRules:\n- For numeric fields (age, income, height, weight, etc.), extract **only the concept word**, NOT the numbers or ranges. Example: \"Ages 18-25\" â†’ \"age\"\n- Expand specific terms into broader concepts using these examples:\n  - \"Male\" â†’ \"male, gender\"\n  - \"Female\" â†’ \"female, gender\"\n  - \"Dog Owners\" â†’ \"dog, ownership, owners\"\n  - \"Pet Owners\" â†’ \"pet, ownership, owners\"\n  - \"Car Owners\" â†’ \"car, ownership, owners\"\n  - \"Home Owners\" â†’ \"home, ownership, owners\"\n  - \"Parents\" â†’ \"parents, children\"\n  - \"Students\" â†’ \"students, education\"\n- Include each keyword **once**, no duplicates\n- Output as a **comma-separated string** of keywords\n\nExamples:\n- Input: \"Ages 18-25, Asthma patients\"  \n  Output: \"age, asthma, patients\"\n\n- Input: \"Male, Dog Owners\"  \n  Output: \"male, gender, dog, ownership, owners\"\n\n- Input: \"Income $50,000-$75,000, Female, College educated\"  \n  Output: \"income, female, gender, education, college\"\n\nOutput only the final **comma-separated keywords string**, do not include any other text.\n","maxIterations":5,"returnIntermediateSteps":true}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1264,384],"id":"7c4b8f6b-b209-466d-94a9-10c49b65f1be","name":"Get Questions by Country V2","executeOnce":false},{"parameters":{"jsCode":"// Get the output from the previous agent node\nconst agentOutput = $input.first().json; \n// Example structure of agentOutput: { output: \"male, gender\", intermediateSteps: [] }\n\n// Get the original data from the Questions By CountryID node\nconst questionsNodeOutput = $('Questions By CountryID').first().json;\n\n// Add the agent's output as criteria_words\nquestionsNodeOutput.criteria_words = agentOutput.output;\n\n// Return the updated object\nreturn {\n    json: questionsNodeOutput\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1664,384],"id":"95d7de52-5ac1-4616-8e89-4bf2949c7a67","name":"clean criteria"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b8f79dcf-a09a-4684-994c-a9eb30c63977","leftValue":"={{ $json.question_text }}","rightValue":"car","operator":{"type":"string","operation":"notContains"}},{"id":"f1c95927-a35a-4281-91ef-34d46358e05f","leftValue":"={{ $json.question_id }}","rightValue":602,"operator":{"type":"number","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[3008,288],"id":"f2039b82-3c63-4afd-946d-ebcf818dc462","name":"Filter"},{"parameters":{"assignments":{"assignments":[{"id":"607df5e8-7715-4c32-9ab9-d174f14bf163","name":"URL","value":"https://surveypmr.prodegeapisqa.com/prodegemr","type":"string"},{"id":"f2506a11-6c0d-465f-bbcb-5c2c5dfdd793","name":"country_id","value":"={{ $('setCountryRequestFields').first().json.country_id }}","type":"number"},{"id":"14519b0c-8549-494a-90ba-2014ef116cf2","name":"questions","value":"={{ $json.output[0].questions }}","type":"string"},{"id":"b602df91-cc6c-4036-afe3-b2978e34042c","name":"IR","value":"={{ $json.output[0].IR }}","type":"number"},{"id":"a107f78c-33ce-43b3-a72d-586c4b0a20d1","name":"LOI","value":"={{ $json.output[0].LOI }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4880,432],"id":"8773e7aa-89c1-4468-a03f-ca027fc8d57e","name":"setFeasibility2"},{"parameters":{"jsCode":"// Import crypto for signature generation\nconst crypto = require('crypto');\n\n// Function to decrypt encrypted strings\nconst decryptString = (encryptedText, password) => {\n    const algorithm = 'aes-256-cbc';\n    const key = crypto.scryptSync(password, 'salt', 32);\n    \n    const parts = encryptedText.split(':');\n    const iv = Buffer.from(parts[0], 'hex');\n    const encrypted = parts[1];\n    \n    const decipher = crypto.createDecipheriv(algorithm, key, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    \n    return decrypted;\n};\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// ðŸ” GET ENCRYPTED KEYS FROM ENVIRONMENT VARIABLES AND DECRYPT\nconst encryptedApiKey = $vars.e_apikey;\nconst encryptedSecretKey = $vars.e_secret;\nconst encryptionPassword = $vars.e_password;\n\n// Validate environment variables are set\nif (!encryptedApiKey) {\n    throw new Error('âŒ Environment variable \"e_apikey\" is not set or is empty');\n}\nif (!encryptedSecretKey) {\n    throw new Error('âŒ Environment variable \"e_secret\" is not set or is empty');\n}\nif (!encryptionPassword) {\n    throw new Error('âŒ Environment variable \"e_password\" is not set or is empty');\n}\n\nconsole.log('âœ… All environment variables found');\n\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('ðŸ”“ Keys decrypted successfully');\n\n// Get data from setFeasibility node\nconst setFeasibilityData = $input.first().json;\n\n// Get targeting_criteria from agent output (previous to setFeasibility)\nconst agentOutput = $('FinalQuestion Check').first().json;\nlet targetingCriteria = agentOutput.output && agentOutput.output[0] && agentOutput.output[0].targeting_criteria \n    ? agentOutput.output[0].targeting_criteria \n    : agentOutput.targeting_criteria;\n\n// If targeting_criteria is an array, stringify it\nif (targetingCriteria && Array.isArray(targetingCriteria)) {\n    targetingCriteria = JSON.stringify(targetingCriteria);\n}\n\n// Get current timestamp\nconst requestDate = Date.now();\n\n// Build parameters for signature\nconst parametersForSignature = {\n    apik: apiKey,\n    request_date: requestDate\n};\n\n// Add optional parameters if they exist\nif (setFeasibilityData.country_id) parametersForSignature.country_id = setFeasibilityData.country_id;\nif (targetingCriteria) parametersForSignature.targeting_criteria = targetingCriteria;\n//if (setFeasibilityData.LOI) parametersForSignature.LOI = setFeasibilityData.LOI;\n//if (setFeasibilityData.IR) parametersForSignature.IR = setFeasibilityData.IR;\n\n// Generate signature\nconst signature = generateSignature(parametersForSignature, secretKey);\n\n// Build final output\nconst output = {\n   // apik: apiKey,\n    request_date: requestDate,\n    country_id: setFeasibilityData.country_id,\n    targeting_criteria: targetingCriteria,\n    LOI: setFeasibilityData.LOI,\n    IR: setFeasibilityData.IR,\n    signature: signature,\n    fullUrl: `${setFeasibilityData.URL}/feasibility-run`,\n    questions: setFeasibilityData.questions\n};\n\nreturn { json: output };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5360,544],"id":"d279723a-244a-4f02-99c8-e735767209c8","name":"Compile Feasibility2"},{"parameters":{"method":"POST","url":"=https://surveypmr.prodegeapis.com/prodegemr/feasibility-run","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}","sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"request_date","value":"={{ $json.request_date }}"},{"name":"signature","value":"={{ $json.signature }}"},{"name":"country_id","value":"={{ $json.country_id }}"},{"name":"targeting_criteria","value":"={{ $json.targeting_criteria }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5616,640],"id":"173aa232-a937-45f8-aa71-7ae5fd78a00f","name":"Run Feasibility3","credentials":{"httpQueryAuth":{"id":"V3Xxf7Ey1rzsqLV1","name":"Peeq Prod Query Auth"}}},{"parameters":{"jsCode":"// Import crypto for signature generation\nconst crypto = require('crypto');\n\n// Function to decrypt encrypted strings\nconst decryptString = (encryptedText, password) => {\n    const algorithm = 'aes-256-cbc';\n    const key = crypto.scryptSync(password, 'salt', 32);\n    \n    const parts = encryptedText.split(':');\n    const iv = Buffer.from(parts[0], 'hex');\n    const encrypted = parts[1];\n    \n    const decipher = crypto.createDecipheriv(algorithm, key, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    \n    return decrypted;\n};\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// ðŸ” GET ENCRYPTED KEYS FROM ENVIRONMENT VARIABLES AND DECRYPT\nconst encryptedApiKey = $vars.e_apikey;\nconst encryptedSecretKey = $vars.e_secret;\nconst encryptionPassword = $vars.e_password;\n\n// Validate environment variables are set\nif (!encryptedApiKey) {\n    throw new Error('âŒ Environment variable \"e_apikey\" is not set or is empty');\n}\nif (!encryptedSecretKey) {\n    throw new Error('âŒ Environment variable \"e_secret\" is not set or is empty');\n}\nif (!encryptionPassword) {\n    throw new Error('âŒ Environment variable \"e_password\" is not set or is empty');\n}\n\nconsole.log('âœ… All environment variables found');\n\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('ðŸ”“ Keys decrypted successfully');\n\n// Get data from setFeasibility node\nconst setFeasibilityData = $input.first().json;\n\n// Get targeting_criteria from agent output (previous to setFeasibility)\nconst agentOutput = $('FinalQuestion Check').first().json;\nlet targetingCriteria = agentOutput.output && agentOutput.output[0] && agentOutput.output[0].targeting_criteria \n    ? agentOutput.output[0].targeting_criteria \n    : agentOutput.targeting_criteria;\n\n// If targeting_criteria is an array, stringify it\nif (targetingCriteria && Array.isArray(targetingCriteria)) {\n    targetingCriteria = JSON.stringify(targetingCriteria);\n}\n\n// Normalize LOI (remove text like \"min\", \"minutes\", \"mins\", etc.) and convert to integer\nlet normalizedLOI = setFeasibilityData.LOI;\nif (normalizedLOI !== undefined && normalizedLOI !== null) {\n    if (typeof normalizedLOI === 'string') {\n        normalizedLOI = normalizedLOI.replace(/[^0-9.]/g, '');\n    }\n    normalizedLOI = parseInt(normalizedLOI, 10);\n}\n\n// Normalize IR (remove \"%\" symbol) and convert to integer\nlet normalizedIR = setFeasibilityData.IR;\nif (normalizedIR !== undefined && normalizedIR !== null) {\n    if (typeof normalizedIR === 'string') {\n        normalizedIR = normalizedIR.replace(/[^0-9.]/g, '');\n    }\n    normalizedIR = parseInt(normalizedIR, 10);\n}\n\n// Get current timestamp\nconst requestDate = Date.now();\n\n// Build parameters for signature (use numbers as-is)\nconst parametersForSignature = {\n    apik: apiKey,\n    request_date: requestDate\n};\n\n// Add optional parameters if they exist\nif (setFeasibilityData.country_id) parametersForSignature.country_id = setFeasibilityData.country_id;\nif (targetingCriteria) parametersForSignature.targeting_criteria = targetingCriteria;\nif (!isNaN(normalizedLOI)) parametersForSignature.loi = normalizedLOI;  // Keep as number\nif (!isNaN(normalizedIR)) parametersForSignature.expected_incidence_rate = normalizedIR;    // Keep as number\n\n// Generate signature\nconst signature = generateSignature(parametersForSignature, secretKey);\n\n// Build final output (LOI and IR as numbers, unquoted in JSON)\nconst output = {\n    request_date: requestDate,\n    country_id: setFeasibilityData.country_id,\n    targeting_criteria: targetingCriteria,\n    LOI: normalizedLOI,  // Number (integer)\n    IR: normalizedIR,    // Number (integer)\n    signature: signature,\n    fullUrl: `${setFeasibilityData.URL}/feasibility-run`,\n    questions: setFeasibilityData.questions\n};\n\nreturn { json: output };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5440,272],"id":"1a14dd9a-f4ae-43b1-a2e1-79460fafd9fa","name":"Compile Feasibility3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"26083114-207a-44c5-809d-c307ff2e23e9","leftValue":"={{ $json.LOI }}","rightValue":0,"operator":{"type":"number","operation":"gt"}},{"id":"052803ca-1f7b-462e-beba-cb5cffcb67d3","leftValue":"={{ $json.IR }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[5088,432],"id":"78d3c380-a3b5-47aa-8871-bb4f0a53cdb1","name":"If2"},{"parameters":{"method":"POST","url":"=https://surveypmr.prodegeapis.com/prodegemr/feasibility-run","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}","sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"request_date","value":"={{ $json.request_date }}"},{"name":"signature","value":"={{ $json.signature }}"},{"name":"country_id","value":"={{ $json.country_id }}"},{"name":"targeting_criteria","value":"={{ $json.targeting_criteria }}"},{"name":"loi","value":"={{ $json.LOI }}"},{"name":"expected_incidence_rate","value":"={{ $json.IR }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5680,352],"id":"ae6f0d16-c272-42b7-95a0-74dee31494f6","name":"Run Feasibility with LOI/IR","credentials":{"httpQueryAuth":{"id":"V3Xxf7Ey1rzsqLV1","name":"Peeq Prod Query Auth"}}},{"parameters":{"assignments":{"assignments":[{"id":"6ebfb9fe-4aa7-4cb2-be29-9e518635df52","name":"data","value":"={{ $json['Bid Request Text Area']}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3424,112],"id":"1bdacf4e-88cf-4de5-a8ee-d33c3e8c3d3f","name":"setData"},{"parameters":{"assignments":{"assignments":[{"id":"00a6c4d9-5423-45e1-a7b7-1218724634f1","name":"data","value":"={{ $json.metadata.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3424,400],"id":"6f04e6c0-34f1-488a-ba89-d49d2e334c22","name":"setData1"},{"parameters":{"formTitle":"Peeq Bid Email Trigger (Manual API)","formDescription":"=Submit hubspot email engagment link to test. \n\nExample: https://app.hubspot.com/contacts/20464009/record/0-3/44206538524/view/1?engagement=89272792909&type=EMAIL\n\nWARNING: This automation can take 5+ minutes to run.\n\nReview results here: \n\n{{ `<a href=\"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?gid=0#gid=0\" target=\"_blank\">Open Google Sheet</a>` }}\n","formFields":{"values":[{"fieldLabel":"Hubspot Email Engagment Link","placeholder":"https://app.hubspot.com/contacts/20464009/record/0-3/44206538524/view/1?engagement=89272792909&type=EMAIL","requiredField":true}]},"options":{}},"type":"n8n-nodes-base.formTrigger","typeVersion":2.3,"position":[-4304,400],"id":"3c2ade19-f3d1-4831-994c-4a32f3b5210e","name":"Email Form","webhookId":"78509cef-8e94-41c8-845e-b4621b1301e9"},{"parameters":{"formTitle":"Peeq Bid Text Trigger (Manual API)","formDescription":"=Submit hubspot email engagment link to test. \n\nExample: https://app.hubspot.com/contacts/20464009/record/0-3/44206538524/view/1?engagement=89272792909&type=EMAIL\n\nWARNING: This automation can take 5+ minutes to run.\n\nReview results here: \n\n{{ `<a href=\"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?gid=0#gid=0\" target=\"_blank\">Open Google Sheet</a>` }}\n","formFields":{"values":[{"fieldLabel":"Bid Request Text Area","fieldType":"textarea","placeholder":"I need feasibility for males in USA with a dog","defaultValue":"I need feasibility for males in USA with a dog","requiredField":true}]},"options":{}},"type":"n8n-nodes-base.formTrigger","typeVersion":2.3,"position":[-3632,112],"id":"5a1d5ca9-3ae0-49fc-9a82-84b0ac88f36c","name":"Text Form","webhookId":"6a56c58b-64a0-44a2-b7cd-4affdf9e96bd"}],"connections":{"Questions By CountryID":{"main":[[{"node":"Get Exclude QID List","type":"main","index":0},{"node":"Get Questions by Country V2","type":"main","index":0}]]},"cleaned json":{"main":[[{"node":"Filter","type":"main","index":0}]]},"setCountryRequestFields":{"main":[[{"node":"Questions By CountryID","type":"main","index":0}]]},"Filter1":{"main":[[{"node":"setFeasibility","type":"main","index":0},{"node":"Aggregate1","type":"main","index":0}]]},"Compile Feasibility":{"main":[[{"node":"FinalQuestion Check","type":"main","index":0}]]},"setFeasibility":{"main":[[{"node":"Compile Feasibility","type":"main","index":0}]]},"results":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"OpenAI Chat Model6":{"ai_languageModel":[[{"node":"Email Analyst","type":"ai_languageModel","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Email Analyst","type":"ai_outputParser","index":0}]]},"Email Analyst":{"main":[[{"node":"Append row in sheet","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"If1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[{"node":"Aggregate","type":"main","index":0}],[{"node":"criteria","type":"main","index":0}]]},"Append row in sheet":{"main":[[{"node":"setOutput","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Get Row1","type":"main","index":0}]]},"Get Row":{"main":[[{"node":"Update Row","type":"main","index":0}]]},"criteria":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"setOutput":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"Get Row1":{"main":[[{"node":"Update Row1","type":"main","index":0}]]},"If":{"main":[[{"node":"setCountryRequestFields","type":"main","index":0}],[{"node":"Get Row2","type":"main","index":0}]]},"Get Row2":{"main":[[{"node":"Update Row2","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"QuestionIdentification1","type":"ai_languageModel","index":0}]]},"QuestionIdentification1":{"main":[[{"node":"Filter1","type":"main","index":0}]]},"Structured Output Parser4":{"ai_outputParser":[[{"node":"QuestionIdentification1","type":"ai_outputParser","index":0}]]},"Aggregate1":{"main":[[{"node":"Get Row","type":"main","index":0}]]},"Get an engagement":{"main":[[{"node":"setData1","type":"main","index":0}]]},"setEngagmentId":{"main":[[{"node":"Get an engagement","type":"main","index":0}]]},"setLink":{"main":[[{"node":"setEngagmentId","type":"main","index":0}]]},"setText":{"main":[[{"node":"Email Extractor","type":"main","index":0}]]},"OpenAI Chat Model3":{"ai_languageModel":[[{"node":"Email Extractor","type":"ai_languageModel","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"Email Extractor","type":"ai_outputParser","index":0}]]},"Email Extractor":{"main":[[{"node":"setEmail","type":"main","index":0}]]},"setEmail":{"main":[[{"node":"Email Analyst","type":"main","index":0}]]},"If1":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}],[{"node":"Loop Over Items1","type":"main","index":0}]]},"Get Exclude QID List":{"main":[[{"node":"Combine Exclude","type":"main","index":0}]]},"Combine Exclude":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"cleaned json","type":"main","index":0}]]},"FinalQuestion Check":{"main":[[{"node":"setFeasibility2","type":"main","index":0}]]},"OpenAI Chat Model8":{"ai_languageModel":[[{"node":"FinalQuestion Check","type":"ai_languageModel","index":0}]]},"Simple Memory5":{"ai_memory":[[{"node":"FinalQuestion Check","type":"ai_memory","index":0}]]},"Think5":{"ai_tool":[[{"node":"FinalQuestion Check","type":"ai_tool","index":0}]]},"Snowflake":{"ai_tool":[[{"node":"FinalQuestion Check","type":"ai_tool","index":0}]]},"Structured Output Parser9":{"ai_outputParser":[[{"node":"FinalQuestion Check","type":"ai_outputParser","index":0}]]},"Code in JavaScript":{"main":[[{"node":"Get Country ID","type":"main","index":0}]]},"Get Country ID":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Get Questions by Country":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"OpenAI Chat Model5":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"If","type":"main","index":0}],[{"node":"If","type":"main","index":0}]]},"Structured Output Parser3":{"ai_outputParser":[[{"node":"AI Agent","type":"ai_outputParser","index":0}]]},"Split Out":{"main":[[{"node":"Filter out by Answer_text OR Question_text","type":"main","index":0}]]},"Filter out by Answer_text OR Question_text":{"main":[[{"node":"Merge","type":"main","index":1}]]},"OpenAI Chat Model10":{"ai_languageModel":[[{"node":"Get Questions by Country V2","type":"ai_languageModel","index":0}]]},"Think":{"ai_tool":[[{"node":"Get Questions by Country V2","type":"ai_tool","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"Get Questions by Country V2","type":"ai_memory","index":0}]]},"Get Questions by Country V2":{"main":[[{"node":"clean criteria","type":"main","index":0}]]},"clean criteria":{"main":[[{"node":"Get Questions by Country","type":"main","index":0}]]},"Filter":{"main":[[{"node":"QuestionIdentification1","type":"main","index":0}]]},"setFeasibility2":{"main":[[{"node":"If2","type":"main","index":0}]]},"Compile Feasibility2":{"main":[[{"node":"Run Feasibility3","type":"main","index":0}]]},"Run Feasibility3":{"main":[[{"node":"results","type":"main","index":0}]]},"Compile Feasibility3":{"main":[[{"node":"Run Feasibility with LOI/IR","type":"main","index":0}]]},"If2":{"main":[[{"node":"Compile Feasibility3","type":"main","index":0}],[{"node":"Compile Feasibility2","type":"main","index":0}]]},"Run Feasibility with LOI/IR":{"main":[[{"node":"results","type":"main","index":0}]]},"setData":{"main":[[{"node":"setText","type":"main","index":0}]]},"setData1":{"main":[[{"node":"setText","type":"main","index":0}]]},"Email Form":{"main":[[{"node":"setLink","type":"main","index":0}]]},"Text Form":{"main":[[{"node":"setData","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":1200,"availableInMCP":false,"errorWorkflow":"jLFSwa3HZpulBKUR","timeSavedMode":"fixed"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Text Form":[{"json":{"Bid Request Text Area":"Hi! I'm looking for pricing and feasibility for 18-64 y/o's in the US, 50/50 gender split, balanced to census. \r\n\r\nN Size = 5000\r\nestimated IR = 25%\r\nLOI is 12 mins","submittedAt":"2025-12-11T18:18:14.433-08:00","formMode":"production"}}],"QuestionIdentification1":[{"json":{"output":{"questionId":"1","question_name":"Age","question_text":"What is your age?","optionId":"RANGE","option_text":"18-64","match":true}}},{"json":{"output":{"questionId":"3","question_name":"Gender","question_text":"I am...","optionId":"1,2","option_text":"Male,Female","match":true}}},{"json":{"output":{"questionId":"20","question_name":"Languages Spoken","question_text":"What languages do you speak?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"473","question_name":"Parental Status / Pregnancy Status","question_text":"Please choose the options that best describe your household:","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"41","question_name":"Number of Children in Household","question_text":"How many children under the age of 18 live in your household?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"45","question_name":"Age & Gender of Child(ren) in Household","question_text":"Please indicate the age and gender of your child or children:","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"444","question_name":"US DMA","question_text":"What is your DMA?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"395","question_name":"Health Ailment Diagnosis (A-H)","question_text":"Have you been diagnosed with any of the following illnesses/conditions?","optionId":"17","option_text":"Asthma","match":true}}},{"json":{"output":{"questionId":"236","question_name":"Beverage Consumption","question_text":"Which of the following beverages do your regularly consume?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"296","question_name":"Home Movie Viewing Frequency","question_text":"How frequently do you rent or download movies for home viewing (on average)?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"97","question_name":"Industry Work In","question_text":"Which of the following categories best describes your organization's primary industry?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"100","question_name":"B2B Department","question_text":"Which department do you primarily work within at your organization?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"229","question_name":"QSR Frequency","question_text":"How often do you eat fast food (any quick service restaurant) in any given week (on average)?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"232","question_name":"P4W Beverage Consumption","question_text":"Which, if any, of these drinks have you consumed in the past four weeks?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"238","question_name":"Alcoholic Beverage Consumption Weekly","question_text":"On average, how many alcoholic drinks do you consume in a week?","optionId":"RANGE","option_text":"0-7","match":false}}},{"json":{"output":{"questionId":"346","question_name":"TV Hours Watched Weekly","question_text":"On average, how many hours of television do you watch per week?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"348","question_name":"Radio Hours Listened Weekly","question_text":"On average, how many hours of radio do you listen to per week?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"381","question_name":"Cigarette Usage Daily","question_text":"On average, how many cigarettes do you smoke in a day?","optionId":"RANGE","option_text":"0-10","match":false}}},{"json":{"output":{"questionId":"400","question_name":"Sufferer Ailments 1","question_text":"Do you suffer from any of the following illnesses/conditions?","optionId":"17","option_text":"Asthma","match":true}}},{"json":{"output":{"questionId":"402","question_name":"Diagnosed Ailments 1","question_text":"Has anyone else in your household been diagnosed with any of the following illnesses/conditions? Note that the information will be kept in strictest confidence.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"412","question_name":"Household Sufferer Ailments 1","question_text":"Does anyone else in your household suffer from any of the following illnesses/conditions?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"414","question_name":"Vision Correction Usage","question_text":"Do you use glasses or contact lenses?","optionId":"empty","option_text":"","match":false}}},{"json":{"output":{"questionId":"415","question_name":"Hearing Aid Usage","question_text":"Do you use a hearing aid?","optionId":"RANGE","option_text":"","match":false}}},{"json":{"output":{"questionId":"456","question_name":"P4W GROCERY PURCHASING","question_text":"Which of the following groceries have you purchased in the last four weeks?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"527","question_name":"Panel Group","question_text":"","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"597","question_name":"Social Grade","question_text":"Which best describes the occupation of the chief income earner in your household?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"694","question_name":"Brands Purchased (In-Store)","question_text":"In-Store Shopper Purchaser - Brands","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"695","question_name":"Online Shopping: Retailer","question_text":"Online Shopper Visit","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"699","question_name":"Online Shopper Purchaser","question_text":"Merchant Group Converters","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"700","question_name":"In-Store Shopper","question_text":"Receipt Upload","optionId":"empty","option_text":"","match":false}}},{"json":{"output":{"questionId":"701","question_name":"Location Visit","question_text":"Locale Visit","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"734","question_name":"Category Buyers","question_text":"Category Buyers","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"739","question_name":"Retail Channels Shopped (In-Store)","question_text":"Shoppers by Channel","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"746","question_name":"Websites Visited","question_text":"Website Visitors","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"1047","question_name":"Retail Channels Shopped (Online)","question_text":"Retail Channels Shopped (Online)","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"1092","question_name":"Undeliverable Email Status","question_text":"Undeliverable Email Status","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"100002","question_name":"Tobacco Usage P30 days","question_text":"Please indicate which of these tobacco products you have used in the past 30 days","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"100006","question_name":"Investment Accounts","question_text":"Which of the following investment account types do you currently have (if any)?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"100187","question_name":"Health Insurance Provider","question_text":"What is the name of your primary health insurance company?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"100491","question_name":"JDP - Vehicle Finance Company","question_text":"Which provider has financed the purchase or lease of your vehicle?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"101460","question_name":"Frequent flier programs","question_text":"Which of the following frequent flier program(s) are you a member of? Please select all that apply.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"101462","question_name":"Average Vacation Spend","question_text":"When thinking about your average vacation/trip, what would you estimate you spend in total on each vacation?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"102500","question_name":"Mortgage Provider","question_text":"Which of the following financial institutions is the provider of your home mortgage?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"102502","question_name":"Mortgage Recency","question_text":"When did you obtain your mortgage? If you have refinanced your mortgage, please think of the most recent financing of your mortgage.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"102788","question_name":"SimpleOpinions Media Q","question_text":"Which of the following TV Shows do you currently watch the newest season of?  Select all that apply:","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"103021","question_name":"Mortgage JDP","question_text":"Which lender currently services your mortgage loan?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"103371","question_name":"Social Media Usage","question_text":"Which of the following social media apps/platforms do you use on a regular basis (at least monthly)?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"103642","question_name":"Grandparent Status","question_text":"What are the ages of any grandchildren you might have? Select all that apply.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"104050","question_name":"College Savings Plan Type","question_text":"How are you saving for college?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"104320","question_name":"JDP Lending Products","question_text":"Which of the following lending products have you obtained in the past 24 months?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"104487","question_name":"JDP Investment Company","question_text":"What is the name of your primary investment or wealth management firm? If you work with an advisor, select the firm\nyour advisor is affiliated with.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"104891","question_name":"Wine Intel-P12M","question_text":"Which of the following alcoholic beverages have you drunk in the last 12 months?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"105133","question_name":"JDP Internet Service","question_text":"Which provider do you use for your business internet service?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"106877","question_name":"Mortgage JDP_IO-58984","question_text":"Which lender currently services your mortgage loan?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"107340","question_name":"JDP_Vehicle  consideration","question_text":"Which vehicle makes are you likely to consider? Mark all that apply.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"107497","question_name":"Mortgage JDP_IO-62798","question_text":"Which lender currently services your mortgage loan?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"107795","question_name":"Common Jobs","question_text":"Which of the following jobs best describes your current PRIMARY means of income?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"107863","question_name":"Dating Status-KNOT","question_text":"Which of the following best describes your current relationship status?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"107980","question_name":"Cannabis Yearly Spend","question_text":"On a yearly basis, on average, how much do you spend on cannabis?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"107981","question_name":"CBD Products Purchased","question_text":"What types of CBD products do you purchase? Please select all that apply.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"107982","question_name":"CBD Spend","question_text":"On a yearly basis, on average, how much do you spend on CBD products?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"108771","question_name":"B+D Professionals Q4","question_text":"What is your primary occupation?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"108863","question_name":"JDPA Wealth Management Brands 2022","question_text":"What is the name of your primary investment or wealth management firm? If you work with an advisor, select the firm your advisor is affiliated with. ","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"108881","question_name":"JDPA Wealth Management Brands","question_text":"What is the name of your primary investment or wealth management firm? If you work with an advisor, select the firm your advisor is affiliated with.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"108882","question_name":"Past 24 months activities - JDPA","question_text":"Which of the following activities have you done in the past 24 months? Mark all that apply.  ","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"109685","question_name":"Past 9 months activities - JDPA Services","question_text":"Which of the following activities have you done in the past 9 months?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"110187","question_name":"Loans and Lending Products Past 12 Months - JDPA Service","question_text":"Which of the following lending products have you obtained in the past 12 months?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"110188","question_name":"Home Mortgage Loan Lender - JDPA Service","question_text":"Which lender currently services your home mortgage loan?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"110430","question_name":"North America Airports - JDPA Services","question_text":"From which airport did you most recently depart in the past 30 days?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"110516","question_name":"Pharmacy â€“ Mail Order brand list - JDPA Services","question_text":"Which of the following activities have you done in the past 9 months?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"110527","question_name":"JDPA: Financial Advisors Relationship","question_text":"Which of the following best describes the primary relationship you have with your primary investment or wealth management firm?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"111797","question_name":"Age Brackets - JDPA","question_text":"What best describes your age?","optionId":"111,112,113","option_text":"18-25, 26-40, 41-55","match":true}}},{"json":{"output":{"questionId":"115441","question_name":"VG Profiler-Mobile Gamer Genres","question_text":"Which of the following types of mobile-games do you typically play?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"115445","question_name":"VG Profiler-Content Creator","question_text":"Do you consider yourself a content creator? In this case, content creation refers to creating things like writing blogs/essays/reviews, posts, podcasts, short or long form videos, live streams or other media-based posts to engage an audience.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"115543","question_name":"Utilities DM 2.0","question_text":"Which of the following specific utilities do you have decision-making or financial responsibility for at your company?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"117092","question_name":"Adult Collectibles","question_text":"Which of the following types of toys, games or collectibles have you purchased for yourself (meaning either you bought them or you asked someone else to buy them for you) in the last 12 months?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"119506","question_name":"JDP_Vehicle  consideration (New)","question_text":"Which vehicle makes are you likely to consider buying? Mark all that apply.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"119688","question_name":"IO-112819_JDP auto Financing","question_text":"Which provider has financed the purchase or lease of your vehicle ?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"119964","question_name":"JDP Investment Company_IO-114726","question_text":"What is the name of your primary investment or wealth management firm? If you work with an advisor, select the firm your advisor is affiliated with.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120181","question_name":"IO-119135_PhotoUpload","question_text":"As part of this survey, we kindly ask you to upload photos of specific product. You'll find all the details outlined within the survey itself.\n\nPlease keep in mind that our client will review the uploaded images and will only approve them if they meet the specified standards.\n\nDue to the nature of this survey, please allow us 3-4 weeks to credit your incentives.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120185","question_name":"IO-119153","question_text":"Thank you for your answers so far, the subject of the survey is about divorce. Weâ€™ll be ask you questions about your divorce and your financial situation after you when through a divorce.  We know that this subject might bring up troubling experiences from your past. \n\n \n\nYour answer to these questions will be strictly anonymous, and the purpose of the questions is to understand peopleâ€™s financial situation after going through a marriage breakup. \n\n \n\nYou can get in touch with the Samaritans or Mind if any of the topics we ask you about upsets or worries you.  \n\n \n\nAt the end of this survey you will be shown support services related to the topics covered in this survey should you wish to talk to anyone about these experiences. \n\n \n\nDo you provide consent to answer the next questions on this topic?","optionId":"1","option_text":"Yes","match":false}}},{"json":{"output":{"questionId":"120190","question_name":"IO-118943","question_text":"Including yourself, how many people in each age group currently live in your household?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120199","question_name":"IO-105489 [German]","question_text":"Hallo! FÃ¼r diese Studie mÃ¼ssen Sie eine Google-Chrome-Erweiterung herunterladen, um Ihre Seh-Daten von HBO Max, Netflix, Disney+, YouTube oder Amazon Prime herunterzuladen. Die Erweiterung Ã¼berwacht Sie anschlieÃŸend in keiner Weise weiter, beeinflusst die laufende Leistung Ihres GerÃ¤ts nicht und erfordert auch nicht, dass Sie HBO Max, Disney+, Netflix, YouTube oder Amazon Prime Ã¼ber das GerÃ¤t ansehen, auf dem Sie sie installieren. Sie kÃ¶nnen die Erweiterung nach Abschluss der Umfrage lÃ¶schen.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120205","question_name":"IO-119283 Child Participation","question_text":"Thank you for your interest in participating.\n\nYou indicated that you have a child under 18 in your household. This survey is intended for your child aged 9 to 17 to complete.\n\nIf you agree, please hand the computer, tablet, or phone to your child when prompted and have them answer the questions from their own perspective.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120225","question_name":"IO-119420_iHUT_Recruit","question_text":"We have a unique survey opportunity for you to qualify for an In Home Usage Test (IHUT)!\n\nIf you qualify for and complete this survey, you will not only receive the survey incentives, but you will also be eligible to receive a product to test over a 12 days timeframe.\n\nAs part of the study, youâ€™ll later be asked to complete 3 short follow-up surveys from December 5th-16th.\n\nAfter completing all steps of this research, you will receive a compensation up to $35 (shared directly by our client) for the time spent in this product study. You must use the products following instruction and complete our survey to receive compensation.","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120226","question_name":"IO-118943_2","question_text":"What is the age and gender of your child/ Children?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120239","question_name":"IO-119524 [Recruit] German","question_text":"Hallo! Basierend auf Ihren Antworten in dieser Umfrage kÃ¶nnten Sie fÃ¼r die Teilnahme an einer einzigartigen Gelegenheit infrage kommen. Wenn Sie qualifizieren, werden Sie gebeten, 4 Erinnerungsumfragen auszufÃ¼llen. FÃ¼r Ihre vollstÃ¤ndige Teilnahme erhalten Sie eine zusÃ¤tzliche VergÃ¼tung von insgesamt {sb 750, ibd 750, mp 1200, up 750, ys 750}, wenn Sie alle VIER Folgeaufgaben abschlieÃŸen. Vielen Dank im Voraus fÃ¼r Ihre Teilnahme; Ihr Feedback ist uns sehr wichtig. Bitte beachten Sie, dass die vollstÃ¤ndige Auszahlung 4â€“6 Wochen dauern kann, da wir Ihre Antworten validieren mÃ¼ssen. Achten Sie daher bitte darauf, qualitativ hochwertige Antworten zu geben.","optionId":"1","option_text":"Weiter","match":false}}},{"json":{"output":{"questionId":"120251","question_name":"O-119619 _ Recruit","question_text":"Hello!\n\nWeâ€™d like to invite you to participate in a short product evaluation study. You will receive a product to try at home and complete two short surveys about your experience. Honest feedback â€” positive, negative, or neutral â€” is encouraged.\n\nTo participate, we will capture your name, address, email, and phone number so we can send you the product.\n\nQualified respondents will receive $20 equivalent panel points, with an optional chance to upload a video for an additional $5 reward.\n\nAre you interested in participating?","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120257","question_name":"IO-119386 recall ABH","question_text":"Greetings!\n\nThanks for your participation and qualifying the for the Home Usage Test (IHUT) Study on Baby Diapers product a week ago. This is the follow-up survey to know your feedback.\n\nYou will receive additional incentive {sb 1000,mp 1600,ibd 1000,ys 1000,up 1000} after completing this follow-up survey.\n\nPlease select Yes to Continue !!","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120307","question_name":"IO-105119_Child age","question_text":"Please indicate the age and gender of your child or children:","optionId":"","option_text":"","match":false}}},{"json":{"output":{"questionId":"120319","question_name":"IO-120308","question_text":"Greetings!\n\nBased on your responses, you might be eligible to join a community and earn additional reward by completing activities and in-home usage tests. Once you complete at least one activity within the first 24 hours of registering, a product will be sent to your address free of charge within a few days.\n\nYou will then test this product over the next 4â€“6 weeks. For your time and full participation, you will be able to keep the test unit as a reward if you qualify.\n\nTo contact you, we kindly ask you to share your full name, email, home address, and phone number. We assure you that your contact details will be kept confidential and used only for the purposes mentioned above.\n\nWould you like to proceed with this exciting survey?","optionId":"","option_text":"","match":false}}}],"FinalQuestion Check":[{"json":{"output":[{"request_date":1765578969848,"country_id":"1","questions":"[\"{\\\"questionId\\\":\\\"1\\\",\\\"question_name\\\":\\\"Age\\\",\\\"question_text\\\":\\\"What is your age?\\\",\\\"optionId\\\":\\\"RANGE\\\",\\\"option_text\\\":\\\"18-64\\\",\\\"match\\\":true}\",\"{\\\"questionId\\\":\\\"3\\\",\\\"question_name\\\":\\\"Gender\\\",\\\"question_text\\\":\\\"I am...\\\",\\\"optionId\\\":\\\"1,2\\\",\\\"option_text\\\":\\\"Male,Female\\\",\\\"match\\\":true}\",\"{\\\"questionId\\\":\\\"395\\\",\\\"question_name\\\":\\\"Health Ailment Diagnosis (A-H)\\\",\\\"question_text\\\":\\\"Have you been diagnosed with any of the following illnesses/conditions?\\\",\\\"optionId\\\":\\\"17\\\",\\\"option_text\\\":\\\"Asthma\\\",\\\"match\\\":true}\",\"{\\\"questionId\\\":\\\"111797\\\",\\\"question_name\\\":\\\"Age Brackets - JDPA\\\",\\\"question_text\\\":\\\"What best describes your age?\\\",\\\"optionId\\\":\\\"111,112,113\\\",\\\"option_text\\\":\\\"18-25, 26-40, 41-55\\\",\\\"match\\\":true}\"]","LOI":"12","IR":"25","signature":"5TNjQL9e4LFLJKvoeSrCcN5jXpAuZprg6AIsWDVnLBw","fullUrl":"https://surveypmr.prodegeapisqa.com/prodegemr/feasibility-run","targeting_criteria":[{"question_id":1,"operator":"BETWEEN","precodes":[18,64]},{"question_id":3,"operator":"OR","precodes":[1,2]},{"question_id":395,"operator":"OR","precodes":[17]}]}]}}]},"versionId":"706ded24-57ec-4a05-afdc-8a51737a6dff","activeVersionId":"706ded24-57ec-4a05-afdc-8a51737a6dff","triggerCount":2,"shared":[{"updatedAt":"2025-12-08T18:17:51.115Z","createdAt":"2025-12-08T18:17:51.115Z","role":"workflow:owner","workflowId":"fFjPmKdDsGAU2ZUD","projectId":"NOrA7nVi3G84Nq0v"}],"activeVersion":{"updatedAt":"2025-12-18T22:18:39.777Z","createdAt":"2025-12-18T22:18:39.777Z","versionId":"706ded24-57ec-4a05-afdc-8a51737a6dff","workflowId":"fFjPmKdDsGAU2ZUD","nodes":[{"parameters":{"jsCode":"// Import necessary library\nconst crypto = require('crypto');\n\n// Function to decrypt encrypted strings\nconst decryptString = (encryptedText, password) => {\n    const algorithm = 'aes-256-cbc';\n    const key = crypto.scryptSync(password, 'salt', 32);\n    \n    const parts = encryptedText.split(':');\n    const iv = Buffer.from(parts[0], 'hex');\n    const encrypted = parts[1];\n    \n    const decipher = crypto.createDecipheriv(algorithm, key, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    \n    return decrypted;\n};\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// Obtain current time in milliseconds for the request_date parameter\nconst requestDate = Date.now();\n\n// ðŸ” GET ENCRYPTED KEYS FROM ENVIRONMENT VARIABLES AND DECRYPT\nconst encryptedApiKey = $vars.e_apikey;\nconst encryptedSecretKey = $vars.e_secret;\nconst encryptionPassword = $vars.e_password;\n\n// Validate environment variables are set\nif (!encryptedApiKey) {\n    throw new Error('âŒ Environment variable \"e_apikey\" is not set or is empty');\n}\nif (!encryptedSecretKey) {\n    throw new Error('âŒ Environment variable \"e_secret\" is not set or is empty');\n}\nif (!encryptionPassword) {\n    throw new Error('âŒ Environment variable \"e_password\" is not set or is empty');\n}\n\nconsole.log('âœ… All environment variables found');\n\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('ðŸ”“ Keys decrypted successfully');\n\n// Get other data from input\nconst countryId = $input.first().json.country_id;\n\n// Get criteria from the criteria node\nconst answer_text = $('criteria').first().json;\n\n// Define the parameters for the request\nconst parameters = {\n    apik: apiKey,              // Your API key\n    request_date: requestDate, // Timestamp in milliseconds\n    country_id: countryId      // The ID for the specific country\n};\n\n// Generate the signature\nconst signature = generateSignature(parameters, secretKey);\n\n// Define the base URL and path for the request\nconst baseUrl = 'https://surveypmr.prodegeapisqa.com/prodegemr';\nconst path = '/lookup-question-by-country';\nconst fullUrl = `${baseUrl}${path}`;\n\n// Return all necessary details to complete the request\nreturn {\n    fullUrl,      // The complete URL for the GET request\n    parameters,   // Parameters required for the request\n    signature,    // Generated signature for authentication\n    requestDate,  // Timestamp used in the request\n    answer_text      // Criteria from the criteria node\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[976,288],"id":"f21a946b-d764-4c08-9966-b547523498e0","name":"Questions By CountryID"},{"parameters":{"jsCode":"// Get input\nconst items = $input.all();\nconst outputItems = [];\n\n// Look for exclude list across all items (if provided)\nlet excludeList = [];\nfor (const item of items) {\n  if (item.json.Exclude) {\n    excludeList = item.json.Exclude;\n    break;\n  }\n}\n\n// Helper: push question if not excluded\nfunction pushQuestion(q) {\n  if (!excludeList.includes(q.question_id)) {\n    outputItems.push({ json: q });\n  }\n}\n\nfor (const item of items) {\n  const data = item.json;\n\n  try {\n    // --- CASE 1: OLD STRUCTURE (MCP tool inside intermediateSteps) ---\n    if (data.intermediateSteps) {\n      const mcpStep = data.intermediateSteps.find(\n        step => step.action && step.action.tool === 'lookup_questions_by_country'\n      );\n\n      if (mcpStep && mcpStep.observation) {\n        const observationArray = JSON.parse(mcpStep.observation);\n        const mcpResponseText = observationArray[0].text;\n        const mcpData = JSON.parse(mcpResponseText);\n\n        if (Array.isArray(mcpData.questions)) {\n          mcpData.questions.forEach(q => pushQuestion(q));\n        }\n        continue;\n      }\n    }\n\n    // --- CASE 2: NEW STRUCTURE (RAW QUESTION OBJECTS LIKE THE ONE YOU SENT) ---\n    // If it has \"question_id\", treat it as a direct question object\n    if (data.question_id) {\n      pushQuestion(data);\n      continue;\n    }\n\n    // --- CASE 3: If the node passes an array of questions ---\n    if (Array.isArray(data)) {\n      data.forEach(q => {\n        if (q.question_id) pushQuestion(q);\n      });\n      continue;\n    }\n\n  } catch (error) {\n    outputItems.push({\n      json: {\n        error: \"Parsing error\",\n        message: error.message,\n        raw: data\n      }\n    });\n  }\n}\n\n// If nothing produced\nif (outputItems.length === 0) {\n  return [\n    {\n      json: {\n        message: \"No questions found or all filtered out\"\n      }\n    }\n  ];\n}\n\nreturn outputItems;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2784,288],"id":"5c6443e3-184f-41c6-a35d-f6f57199dc79","name":"cleaned json"},{"parameters":{"assignments":{"assignments":[{"id":"607df5e8-7715-4c32-9ab9-d174f14bf163","name":"URL","value":"https://surveypmr.prodegeapisqa.com/prodegemr","type":"string"},{"id":"f2506a11-6c0d-465f-bbcb-5c2c5dfdd793","name":"country_id","value":"={{ $json.output.country_id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[752,288],"id":"f6fb20cf-6baa-46a4-a657-d6d405fead8e","name":"setCountryRequestFields"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"90b87dcc-8e15-4e3e-9acb-93164bd4f66e","leftValue":"={{ $json.output.match }}","rightValue":"true","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[3584,288],"id":"18444a29-be50-4aa0-92ef-75dd5a94cb40","name":"Filter1"},{"parameters":{"jsCode":"// Import necessary library\nconst crypto = require('crypto');\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// Obtain current time in milliseconds for the request_date parameter\nconst requestDate = Date.now();\n\n// Get all input items\nconst allInputs = $input.all();\n\n// Extract common data from the first item (should be same across all)\nconst firstInput = allInputs[0].json;\nconst apiKey = firstInput.apiKey;\nconst secretKey = firstInput.secretKey;\nconst countryId = firstInput.country_id;\nconst loi = firstInput.LOI;\nconst ir = firstInput.IR;\n\n// Collect all questions exactly as they are (as strings)\nconst questionsArray = allInputs.map(item => item.json.questions);\n\n// Convert questions array to JSON string for the API\nconst questionsJson = JSON.stringify(questionsArray);\n\n// Extract unique question IDs\nconst questionIds = [...new Set(allInputs.map(item => {\n    const questionData = JSON.parse(item.json.questions);\n    return questionData.questionId;\n}))];\nconst questionIdsString = questionIds.join(',');\n\nconsole.log('All input items:', JSON.stringify(allInputs, null, 2));\nconsole.log('Collected questions array:', questionsArray);\nconsole.log('Questions JSON string:', questionsJson);\n\n// Parameters for signature generation\nconst parametersForSignature = {\n    apik: apiKey,\n    request_date: requestDate\n};\n\n// Generate the signature\nconst signature = generateSignature(parametersForSignature, secretKey);\n\n\n// Return the data for HTTP request\nreturn {\n    //apik: apiKey,\n    request_date: requestDate,\n    country_id: countryId,\n    questions: questionsJson, // Send questions as JSON string\n    LOI: loi,\n    IR: ir,\n    signature: signature,\n    fullUrl: \"https://surveypmr.prodegeapisqa.com/prodegemr/feasibility-run\",\n    question_ids: questionIdsString\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4032,384],"id":"61bf733c-3ac6-4afd-b8af-42cd795b80d3","name":"Compile Feasibility"},{"parameters":{"assignments":{"assignments":[{"id":"607df5e8-7715-4c32-9ab9-d174f14bf163","name":"URL","value":"https://surveypmr.prodegeapisqa.com/prodegemr","type":"string"},{"id":"f2506a11-6c0d-465f-bbcb-5c2c5dfdd793","name":"country_id","value":"={{ $('setCountryRequestFields').first().json.country_id }}","type":"number"},{"id":"14519b0c-8549-494a-90ba-2014ef116cf2","name":"questions","value":"={{ $json.output }}","type":"string"},{"id":"48431f14-5485-4bd1-9098-72d0e4e707f2","name":"LOI","value":"={{ $('criteria').first().json.criteria.loi }}","type":"string"},{"id":"b602df91-cc6c-4036-afe3-b2978e34042c","name":"IR","value":"={{ $('criteria').first().json.criteria.ir }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3808,384],"id":"0e707469-3286-4e91-b9e4-6bcc92efed7d","name":"setFeasibility"},{"parameters":{"assignments":{"assignments":[{"id":"e60df256-5e28-432b-97dd-42cf321d92e0","name":"quotas","value":"={{ $json.data }}","type":"object"},{"id":"c3003dea-a1de-4c9a-b38f-d8d7e5a1364d","name":"quotas.criteria","value":"={{ $('criteria').first().json.criteria }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[6016,704],"id":"42087b4d-e5dc-4f64-8784-80640a3ee4a8","name":"results"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1968,464],"id":"48947895-58c9-48c6-a8af-b4114c3b3718","name":"OpenAI Chat Model6","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"jsonSchemaExample":"{\n  \"quotas\": [\n    {\n      \"country\": \"United States\",\n      \"loi\": \"15 minutes\",\n      \"quota\": 1000,\n      \"criteria\": \"Age 18-65, household income >$50K, drives a honda\",\n      \"car_question\": \"True\",\n      \"income_irregular\": \"False\",\n      \"ir\": \"25%\"\n    },\n    {\n      \"country\": \"United Kingdom\", \n      \"loi\": \"12 minutes\",\n      \"quota\": 500,\n      \"criteria\": \"Age 25-55, employed full-time\",\n      \"car_question\": \"False\",\n      \"income_irregular\": \"False\",\n      \"ir\": \"30%\"\n    },\n    {\n      \"country\": \"Canada\",\n      \"loi\": \"18 minutes\", \n      \"quota\": 750,\n      \"criteria\": \"Age 21-60, urban residents\",\n      \"car_question\": \"False\",\n      \"income_irregular\": \"False\",\n      \"ir\": \"35%\"\n    },\n    {\n      \"country\": \"Australia\",\n      \"loi\": \"14 minutes\",\n      \"quota\": 400,\n      \"criteria\": \"Age 30-65, have children under 18, make over $17,000\",\n      \"car_question\": \"False\",\n      \"income_irregular\": \"True\",\n      \"ir\": \"20%\"\n    }\n  ]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-1840,464],"id":"bdaa8d4b-19ed-40fd-aca8-c9a02fa09d7c","name":"Structured Output Parser"},{"parameters":{"promptType":"define","text":"=Email: {{ $json.email }}","hasOutputParser":true,"options":{"systemMessage":"=You are an assistant that analyzes incoming project bid request emails to extract demographic and sample feasibility questions only.\n\nYour job:\n1. Read the email content\n2. Identify only questions about SAMPLE DEMOGRAPHICS and RESPONDENT CHARACTERISTICS\n   - Age groups, gender distribution, geographic location\n   - Health conditions, lifestyle characteristics, behavior patterns  \n   - Incidence rates for specific populations\n   - Sample composition and quotas\n   - Respondent screening criteria\n\nIGNORE internal questions like:\n- \"Can we deliver by X date?\" \n- \"Do we have enough people?\"\n- \"Can we meet the timeline?\"\n- Questions about company capabilities\n\nONLY extract questions about the TARGET AUDIENCE/SAMPLE, such as:\n- \"What's the feasibility of recruiting adults aged 18-25?\"\n- \"Can we achieve 34% incidence rate for digestive health consumers?\"\n- \"Can we get equal gender distribution?\"\n\nCONVERT the plain text answers into more digestable survey answers. For example:\n\n\"Lives in the USA\" turns into \"United States\"\n\"We need ages 25-34 and 60+\" turns into \"Ages 25-34 and 60+\"\n\nInclude the required sample size mapped to each.\nIf the criteria is related to cars makes and models make Car_Question as \"True\".\nIf the criteria mentions income amounts that are NOT in increments of $5,000, mark income_irregular as \"True\".\n\nExample:\nSample Email input:\nHi team, we have a new survey we want to run. I need 100 responses for males, age 25-35, living in the US, making $17,000 or more annually. Would like to get this done by next month.\n\nSample json output:\n{\n  \"Country\": \"United States\",\n  \"Criteria\": [\n    \"Ages 25-35\",\n    \"Male\", \n    \"Income $17,000+\"\n  ],\n  \"Car_Question\": \"False\",\n  \"income_irregular\": \"True\"\n}\n\nSample Email input 2:\nHi team, we have a new survey we want to run. I need 100 responses for males, drive a lexus, living in the US, making $10,000 or more annually. Would like to get this done by next month.\n\nSample json output:\n{\n  \"Country\": \"United States\",\n  \"Criteria\": [\n    \"Drive a lexus\",\n    \"Male\", \n    \"Income $10,000+\"\n  ],\n  \"Car_Question\": \"True\",\n  \"income_irregular\": \"False\"\n}\n\nReturn only valid JSON with no explanations.","maxIterations":5}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-1968,240],"id":"72099a8a-df7d-4d39-85d4-d920b8bbc6b1","name":"Email Analyst"},{"parameters":{"fieldToSplitOut":"output.quotas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-1168,240],"id":"4080e122-0d6c-4315-8e11-2b35581c6e75","name":"Split Out1"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-720,336],"id":"f0af9bb0-ee0b-4a34-a122-43609ac830b5","name":"Loop Over Items1"},{"parameters":{"authentication":"serviceAccount","operation":"append","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Email Analyst Agent Output":"={{ $json.output.quotas }}","Email Request":"={{ $('setEmail').item.json.email }}","submittedAt":"={{ $('setEmail').item.json.submittedAt }}","Link to Execution":"=https://app.n8n.cloud/workflow/{{ $workflow.id }}/executions/{{ $execution.id }}"},"matchingColumns":[],"schema":[{"id":"submittedAt","displayName":"submittedAt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Email Request","displayName":"Email Request","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Email Analyst Agent Output","displayName":"Email Analyst Agent Output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Question Agent Ouput","displayName":"Question Agent Ouput","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Feasibility Results","displayName":"Feasibility Results","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Link to Execution","displayName":"Link to Execution","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"n8n form link","displayName":"n8n form link","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-1616,240],"id":"014f7229-4347-452b-849d-7c9b28de5a7d","name":"Append row in sheet","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"quotas"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-496,240],"id":"87812ece-25fd-43e6-a931-683ad2174f4c","name":"Aggregate"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"submittedAt","lookupValue":"={{ $('setEmail').first().json.submittedAt }}"}]},"options":{"returnFirstMatch":true}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[4032,80],"id":"4f0d3958-686f-4070-aebd-ae8fbfcb4376","name":"Get Row","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"authentication":"serviceAccount","operation":"update","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Question Agent Ouput":"={{ $json[\"Question Agent Ouput\"] }}, {{ JSON.stringify($('Aggregate1').item.json.output) }}","submittedAt":"={{ $('setEmail').first().json.submittedAt }}"},"matchingColumns":["submittedAt"],"schema":[{"id":"submittedAt","displayName":"submittedAt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Email Request","displayName":"Email Request","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Email Analyst Agent Output","displayName":"Email Analyst Agent Output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Question Agent Ouput","displayName":"Question Agent Ouput","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Feasibility Results","displayName":"Feasibility Results","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Link to Execution","displayName":"Link to Execution","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"n8n form link","displayName":"n8n form link","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[4256,80],"id":"eda5c5ef-c050-4a64-b123-5dd3542091c8","name":"Update Row","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"assignments":{"assignments":[{"id":"40d9d304-9a9d-4663-9b8f-275afe52678b","name":"criteria.country","value":"={{ $json.country }}","type":"string"},{"id":"d153080a-647b-4db8-b2bb-69426a229a07","name":"criteria.loi","value":"={{ $json.loi }}","type":"string"},{"id":"edbb9fcd-7c72-487b-b230-d4bd1aae7227","name":"criteria.quota","value":"={{ $json.quota }}","type":"string"},{"id":"921ec425-2436-484b-8171-7567feb957b0","name":"criteria.ir","value":"={{ $json.ir }}","type":"string"},{"id":"c2b6fa58-5a95-4546-85aa-9ca4ec21a91e","name":"criteria.criteria","value":"={{ $json.criteria }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-496,432],"id":"335436dd-209a-41e8-a534-2fe1a4ed7f42","name":"criteria"},{"parameters":{"assignments":{"assignments":[{"id":"87b37d9d-4c8f-4018-ad1f-72ec948c4e98","name":"output","value":"={{ $('Email Analyst').item.json.output }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1392,240],"id":"96e11bae-a0e8-4edc-a961-f66df886764f","name":"setOutput"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"submittedAt","lookupValue":"={{ $('setEmail').first().json.submittedAt }}"}]},"options":{"returnFirstMatch":true}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-272,240],"id":"b523528f-c701-4b0a-88ea-c2403b7519dd","name":"Get Row1","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"authentication":"serviceAccount","operation":"update","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Feasibility Results":"={{ $('Aggregate').item.json.quotas }}","submittedAt":"={{ $('setEmail').first().json.submittedAt }}"},"matchingColumns":["submittedAt"],"schema":[{"id":"submittedAt","displayName":"submittedAt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Email Request","displayName":"Email Request","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Email Analyst Agent Output","displayName":"Email Analyst Agent Output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Question Agent Ouput","displayName":"Question Agent Ouput","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Feasibility Results","displayName":"Feasibility Results","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Link to Execution","displayName":"Link to Execution","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"n8n form link","displayName":"n8n form link","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-48,240],"id":"1ba58613-7729-449e-86d5-155a54cc6c24","name":"Update Row1","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1017c600-c588-4626-9320-69004d4c976b","leftValue":"={{ $json.output.country_id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[528,432],"id":"f91bfc8a-c721-4242-a109-38ba119d443c","name":"If"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"submittedAt","lookupValue":"={{ $('setEmail').first().json.submittedAt }}"}]},"options":{"returnFirstMatch":true}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[752,528],"id":"5c19a4e5-2da2-412c-a7d2-2b6a8d4809b2","name":"Get Row2","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"authentication":"serviceAccount","operation":"update","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"submittedAt":"={{ $('setEmail').first().json.submittedAt }}","Feasibility Results":"ERROR: No country specified in email"},"matchingColumns":["submittedAt"],"schema":[{"id":"submittedAt","displayName":"submittedAt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Email Request","displayName":"Email Request","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Email Analyst Agent Output","displayName":"Email Analyst Agent Output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Question Agent Ouput","displayName":"Question Agent Ouput","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Feasibility Results","displayName":"Feasibility Results","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[976,528],"id":"218601bc-6eff-40ec-99b2-b473c241f25e","name":"Update Row2","credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{"timeout":60000,"maxRetries":5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3248,512],"id":"58826b14-1067-488f-82df-739710b655c9","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"promptType":"define","text":"={{ $json }}","hasOutputParser":true,"options":{"systemMessage":"=Review the question and its answers against this survey feasibility request to determine if it is a match.\n\nCriteria:\n{{ $('criteria').first().json.criteria.criteria }}\n\nFor each question, determine if it matches and is found in the targeting criteria:\n- For questions with options: match against the specific option values\n- For numeric questions (like age): determine if the question is relevant to the criteria, even without specific options\n- For single-select questions: determine if the question is relevant to the criteria and if there are answer options that are relevant to the criteria\n\n**CRITICAL MATCHING RULES:**\n- **EXACT CONTEXT MATCHING**: The question must match the EXACT context of the criteria\n  - If criteria says \"Asthma patients\" â†’ only match questions about the RESPONDENT having asthma\n  - If criteria says \"Male\" â†’ only match questions about the RESPONDENT'S gender\n  - DO NOT match questions about household members, family members, or other people\n  - DO NOT match questions that ask about \"anyone else\" or \"others in household\"\n- **DIRECT RELEVANCE ONLY**: If the question topic is not DIRECTLY and EXPLICITLY mentioned in the criteria, mark as FALSE\n- **RESPONDENT-FOCUSED**: Only match questions that target the survey respondent themselves, not their household/family\n\n**EXAMPLES OF INCORRECT MATCHES:**\n- Criteria: \"Asthma patients\" + Question: \"Has anyone else in your household been diagnosed with asthma?\" â†’ FALSE (asks about others, not respondent)\n- Criteria: \"Male\" + Question: \"What is your spouse's gender?\" â†’ FALSE (asks about spouse, not respondent)\n\nOutput the result in the following JSON format:\n\n{\n  \"questionId\": \"The question ID\",\n  \"question_name\": \"The question name\", \n  \"question_text\": \"The question text\",\n  \"optionId\": \"The answer/option ID, or 'RANGE' for numeric questions, or empty for open-ended\",\n  \"option_text\": \"The answer/option result/text, or the required range/value for numeric questions\",\n  \"match\": true or false if we need the question for the feasibility request\n}\n\nSpecial handling for numeric questions:\n- If {{ $json.question_type }} is \"Numeric\" \n  - Set optionId to \"RANGE\" and option_text to the required range (e.g., \"30-39\")\n- If {{ $json.question_type }} is \"Single-Select\"\n  - Set optionId to the option ID or ID's that match the criteria\n\n**Remember: Only match questions that directly target the survey respondent themselves and exactly match the criteria context.**","maxIterations":5}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[3232,288],"id":"f40680b4-bc87-47b8-beda-4dce85dfb374","name":"QuestionIdentification1","executeOnce":false,"alwaysOutputData":true},{"parameters":{"jsonSchemaExample":"{\n  \"questionId\": \"1\",\n  \"question_name\": \"Age\",\n  \"question_text\": \"What is your age?\",\n  \"optionId\": \"1\",\n  \"option_text\": \"24\",\n  \"match\": true\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[3376,512],"id":"6a6706db-719b-4373-a257-430f1d41170e","name":"Structured Output Parser4"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"output"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[3808,80],"id":"8ce69386-59f9-4e94-91d3-e6d663a80d43","name":"Aggregate1"},{"parameters":{"authentication":"appToken","resource":"engagement","operation":"get","engagementId":{"__rl":true,"value":"={{ $json.engagmentId }}","mode":"id"}},"type":"n8n-nodes-base.hubspot","typeVersion":2.2,"position":[-3632,400],"id":"dfe443e7-3c5e-42b9-b54a-36ddd0f0785f","name":"Get an engagement","credentials":{"hubspotAppToken":{"id":"PlnQEFCxdSC4xSy9","name":"HubSpot n8n-HubSpot-PRODUCTION_20464009-202506-fef"}}},{"parameters":{"assignments":{"assignments":[{"id":"40a62e39-0863-4eae-8b10-873830c4069b","name":"engagmentId","value":"={{ $json.link.split('engagement=')[1]?.split('&')[0] }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3856,400],"id":"b4245508-5975-48bb-800b-c877d31afd1c","name":"setEngagmentId"},{"parameters":{"assignments":{"assignments":[{"id":"40a62e39-0863-4eae-8b10-873830c4069b","name":"link","value":"={{ $json['Hubspot Email Engagment Link'] }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-4080,400],"id":"c07c50ff-c493-4a6e-b17d-1455720320e6","name":"setLink"},{"parameters":{"assignments":{"assignments":[{"id":"6ebfb9fe-4aa7-4cb2-be29-9e518635df52","name":"data","value":"={{ $json.data }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2768,240],"id":"c35827fc-9c8b-4087-86db-ac3dafe27990","name":"setText"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-2544,464],"id":"b39a00af-000b-4aa3-bd27-14a9c262bd63","name":"OpenAI Chat Model3","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"jsonSchemaExample":"{\n\t\"bidRequest\": \"men in USA that have dogs\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-2384,464],"id":"18c5e212-197c-48d7-810e-fca2f41dca35","name":"Structured Output Parser1"},{"parameters":{"promptType":"define","text":"=Request: {{ $json.data }}","hasOutputParser":true,"options":{"systemMessage":"Review the given request and extract the initial Bid request from it. Do not summarize or consolidate any parts of the bid request."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-2544,240],"id":"7aeabd60-e102-4a12-981e-b0bb5b8ea65c","name":"Email Extractor"},{"parameters":{"assignments":{"assignments":[{"id":"8084fe08-51e6-4a8e-b7e9-eb345781a1dd","name":"email","value":"={{ $json.output.bidRequest }}","type":"string"},{"id":"bb3abe6f-0d12-4e35-a4f0-f3659b18f1ce","name":"submittedAt","value":"={{ $now}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2192,240],"id":"8aab3f95-2dd8-463a-85d3-3ca4e1a673f2","name":"setEmail"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6e76c7e4-25fe-440f-bc38-db5a430c6ebf","leftValue":"={{ $json.car_question }}","rightValue":"True","operator":{"type":"string","operation":"contains"}},{"id":"18977b2f-c658-4517-9308-fc4d2e924b7d","leftValue":"={{ $json.income_irregular }}","rightValue":"True","operator":{"type":"string","operation":"contains"}}],"combinator":"or"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-944,240],"id":"8a862196-7510-43f8-9d47-7635c0e8edc6","name":"If1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-720,144],"id":"9fafbff2-cc4c-4c2a-b92b-78074256e018","name":"No Operation, do nothing"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko","mode":"list","cachedResultName":"Bid Request Automation (BAI-63)","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1321003384,"mode":"list","cachedResultName":"QuestionIDs to Exclude","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit#gid=1321003384"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2112,112],"id":"c7b09685-5df2-40b0-aaca-00da73f4e39e","name":"Get Exclude QID List","executeOnce":true,"credentials":{"googleApi":{"id":"x5TAmnenTwfnUc5f","name":"boden-n8n-agent-access"}}},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"Exclude"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[2336,112],"id":"176dd60c-800f-48f4-9542-47de552270cf","name":"Combine Exclude"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2560,288],"id":"3081fcc7-1118-4428-8393-07db98dae17b","name":"Merge"},{"parameters":{"promptType":"define","text":"=Analyze this feasibility request and remove any similar or duplicate questions in the targeting criteria.\n\nRequest Data: {{ JSON.stringify($json) }}\n\nSteps:\n1. Identify similar questions (same topic, condition, demographic, or similar answer options).\n2. If similar questions exist, query Snowflake for completes and keep only the question with the highest completes.\n3. Preserve the full structure of the request except the optimized targeting-related questions and normalized LOI and IR.\n\nThen produce a `targeting_criteria` field formatted as a **JSON string**, using:\n- BETWEEN for numeric ranges (e.g., 18â€“29)\n- OR for discrete sets of precodes\n\nFormat example:\n\"[{\\\"question_id\\\":1,\\\"operator\\\":\\\"BETWEEN\\\",\\\"precodes\\\":[18,29]},{\\\"question_id\\\":3,\\\"operator\\\":\\\"OR\\\",\\\"precodes\\\":[1]},{\\\"question_id\\\":236,\\\"operator\\\":\\\"OR\\\",\\\"precodes\\\":[4]}]\"\n\nReturn ONLY the final JSON object with no additional text. Example structure:\n{\n  \"request_date\": 1764020943370,\n  \"country_id\": \"1\",\n  \"questions\": \"[...]\",\n  \"LOI\": \"25\",\n  \"IR\": \"7\",\n  \"signature\": \"...\",\n  \"fullUrl\": \"...\",\n  \"targeting_criteria\": \"[{\\\"question_id\\\":1,\\\"operator\\\":\\\"BETWEEN\\\",\\\"precodes\\\":[18,29]}]\"\n}","hasOutputParser":true,"options":{"systemMessage":"=You are a feasibility optimization agent that processes and optimizes survey targeting requests.\n\nYour tasks:\n\nParse the incoming feasibility request and identify similar or duplicate questions in the targeting portion.\n\nDetermine similarity based on:\n- Same topic or demographic\n- Same medical condition\n- Same or nearly identical answer options\n\nWhen similar questions are detected:\n- Extract their question IDs\n- Query the Snowflake tool for completion counts\n- Keep the question with the highest completes\n- Remove the others\n\nMaintain the exact structure of the request except for the optimized question list.\n\nNormalize LOI and IR fields:\n- Convert LOI to a plain number by removing any text like \"min\", \"minutes\", \"mins\", etc. (e.g., \"25 min\" â†’ \"25\")\n- Convert IR to a plain number by removing the \"%\" symbol (e.g., \"7%\" â†’ \"7\")\n\nAfter optimization, you MUST generate a targeting_criteria JSON string where each final question is formatted as one of the following:\n\nOR operator â€” for discrete precodes\n{\"question_id\": X, \"operator\": \"OR\", \"precodes\": [v1, v2, v3]}\n\nBETWEEN operator â€” only for numeric ranges\n{\"question_id\": X, \"operator\": \"BETWEEN\", \"precodes\": [min, max]}\n\nRules:\n- Only \"OR\" or \"BETWEEN\" operators may be used\n- Use \"BETWEEN\" only if the data clearly represents a numeric range\n- Use \"OR\" for all discrete lists\n- The entire targeting_criteria must be returned as a stringified JSON array\n\nDo not modify any other fields in the request.\n\nCRITICAL OUTPUT REQUIREMENT:\nYou MUST respond with ONLY valid JSON matching the exact structure provided in the prompt. \nDo NOT include any explanation, reasoning, or text outside the JSON.\nDo NOT say \"Agent stop\" or any other concluding remarks.\nDo NOT wrap the output in markdown code blocks.\nStart your response with { and end with }\nOutput ONLY the JSON object, nothing else.","maxIterations":5}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[4448,384],"id":"b3b872ed-0d80-4ebf-86c9-3b96aeee9023","name":"FinalQuestion Check"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{"timeout":60000,"maxRetries":5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[4256,608],"id":"0ea09d8d-f924-4051-875e-0c164604ae9a","name":"OpenAI Chat Model8","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"test_session"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[4384,608],"id":"e1c9de8b-27f1-4c03-b269-6cfa20eb63cd","name":"Simple Memory5"},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1.1,"position":[4512,608],"id":"ccf65cfa-bb2d-49b7-b461-de7030e82cf4","name":"Think5"},{"parameters":{"operation":"executeQuery","query":"SELECT\n  substr (a.questionid, 1) as QuestionID,\n  MAX(q.QuestionName) as QuestionName,\n  p.COUNTRYNAME as Country,\n  c.country_key,\n  COUNT(distinct a.projectid) as Count\nFROM\n  OPS_AUTOMATION_DB.surveys.qual_questions a\n  JOIN OPS_AUTOMATION_DB.surveys.project p on p.projectid = a.projectid\n  JOIN OPS_AUTOMATION_DB.dwstage.mm_country_dim c on c.country = p.countryname\n  LEFT JOIN OPS_AUTOMATION_DB.prodege.profile_question q on q.ExtQuestionID = a.QuestionID\n  AND q.extprofiletypeid = 1\nWHERE\n  p.pmr_status != 'PENDING'\n -- and p.apiuserid \n  AND p.createdon >= dateadd(YEAR,-1,CURRENT_DATE)\n  AND p.createdon <= CURRENT_DATE\n  -- AND c.country_key IN (@ Country @)\n  AND a.questionid in ({{ $json.question_ids }})\n  AND c.country_key = {{ $json.country_id }}\nGROUP BY a.questionid, 3,4\nORDER BY 3, a.questionid"},"type":"n8n-nodes-base.snowflakeTool","typeVersion":1,"position":[4640,608],"id":"7b64be24-be8f-44e9-92ed-d9d2ad6ee557","name":"Snowflake","credentials":{"snowflake":{"id":"gyAQtZa8Xv82pKrh","name":"Snowflake SUPPORT n8n-support-gservice-2025oct"}}},{"parameters":{"jsonSchemaExample":"[\n  {\n    \"request_date\": 1764020943370,\n    \"country_id\": \"1\",\n    \"questions\": \"[\\\"{\\\\\\\"questionId\\\\\\\":\\\\\\\"3\\\\\\\",\\\\\\\"question_name\\\\\\\":\\\\\\\"Gender\\\\\\\",\\\\\\\"question_text\\\\\\\":\\\\\\\"I am...\\\\\\\",\\\\\\\"optionId\\\\\\\":\\\\\\\"1\\\\\\\",\\\\\\\"option_text\\\\\\\":\\\\\\\"Male\\\\\\\",\\\\\\\"match\\\\\\\":true}\\\",\\\"{\\\\\\\"questionId\\\\\\\":\\\\\\\"395\\\\\\\",\\\\\\\"question_name\\\\\\\":\\\\\\\"Ailments 1\\\\\\\",\\\\\\\"question_text\\\\\\\":\\\\\\\"Have you been diagnosed with any of the following illnesses/conditions? Note that the information will be kept in strictest confidence.\\\\\\\",\\\\\\\"optionId\\\\\\\":\\\\\\\"17\\\\\\\",\\\\\\\"option_text\\\\\\\":\\\\\\\"Asthma\\\\\\\",\\\\\\\"match\\\\\\\":true}\\\",\\\"{\\\\\\\"questionId\\\\\\\":\\\\\\\"400\\\\\\\",\\\\\\\"question_name\\\\\\\":\\\\\\\"Sufferer Ailments 1\\\\\\\",\\\\\\\"question_text\\\\\\\":\\\\\\\"Do you suffer from any of the following illnesses/conditions?\\\\\\\",\\\\\\\"optionId\\\\\\\":\\\\\\\"17\\\\\\\",\\\\\\\"option_text\\\\\\\":\\\\\\\"Asthma\\\\\\\",\\\\\\\"match\\\\\\\":true}\\\"]\",\n    \"LOI\": \"\",\n    \"IR\": \"\",\n    \"signature\": \"64Qh9cmf1rAs755wrYfsnJUg-0D-JA2427WjyFKbBvo\",\n    \"fullUrl\": \"https://surveypmr.prodegeapisqa.com/prodegemr/feasibility-run\",\n\n    \"targeting_criteria\": [\n      {\n        \"question_id\": 1,\n        \"operator\": \"BETWEEN\",\n        \"precodes\": [21, 25]\n      },\n      {\n        \"question_id\": 3,\n        \"operator\": \"OR\",\n        \"precodes\": [1]\n      },\n      {\n        \"question_id\": 24,\n        \"operator\": \"OR\",\n        \"precodes\": [\"90703\", \"90245\", \"90815\"]\n      }\n    ]\n  }\n]\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[4768,608],"id":"a03433bc-912d-4e5e-9b47-2f631e613663","name":"Structured Output Parser9"},{"parameters":{"jsCode":"// Import necessary library\nconst crypto = require('crypto');\n\n// Function to decrypt encrypted strings\nconst decryptString = (encryptedText, password) => {\n    const algorithm = 'aes-256-cbc';\n    const key = crypto.scryptSync(password, 'salt', 32);\n    \n    const parts = encryptedText.split(':');\n    const iv = Buffer.from(parts[0], 'hex');\n    const encrypted = parts[1];\n    \n    const decipher = crypto.createDecipheriv(algorithm, key, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    \n    return decrypted;\n};\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// Obtain current time in milliseconds for the request_date parameter\nconst requestDate = Date.now();\n\n// Get data from previous node\nconst inputData = $input.first().json;\n\n// ðŸ” GET ENCRYPTED KEYS FROM ENVIRONMENT VARIABLES AND DECRYPT\nconst encryptedApiKey = $vars.e_apikey;\nconst encryptedSecretKey = $vars.e_secret;\nconst encryptionPassword = $vars.e_password;\n\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('ðŸ”“ Keys decrypted successfully');\n\n// Parse the questions data\nlet matchedQuestions = [];\ntry {\n    const questionsData = JSON.parse(inputData.questions);\n    matchedQuestions = Array.isArray(questionsData) ? questionsData : [questionsData];\n} catch (error) {\n    console.error('Error parsing questions:', error);\n    matchedQuestions = [];\n}\n\n// Build targeting criteria exactly as shown in docs\nconst targetingCriteria = [];\n\nmatchedQuestions.forEach(question => {\n    if (question.match === \"True\" && question.questionId) {\n        let criteriaItem = {};\n        \n        // Build exactly as shown in the documentation\n        if (question.questionId === 1) {\n            criteriaItem = {\n                \"question_id\": 1,\n                \"operator\": \"BETWEEN\", \n                \"precodes\": [21, 25]\n            };\n        } else if (question.questionId === 3) {\n            criteriaItem = {\n                \"question_id\": 3,\n                \"operator\": \"OR\",\n                \"precodes\": [1]\n            };\n        } else if (question.questionId === 24) {\n            criteriaItem = {\n                \"question_id\": 24,\n                \"operator\": \"OR\",\n                \"precodes\": [\"90703\", \"90245\", \"90815\"]\n            };\n        } else {\n            // Default for other question IDs\n            criteriaItem = {\n                \"question_id\": question.questionId,\n                \"operator\": \"OR\",\n                \"precodes\": [1]\n            };\n        }\n        \n        targetingCriteria.push(criteriaItem);\n    }\n});\n\n// Convert to JSON string for the API (this is what gets sent)\nconst targetingCriteriaJson = JSON.stringify(targetingCriteria);\n\nconsole.log('Targeting criteria array:', targetingCriteria);\nconsole.log('Targeting criteria JSON:', targetingCriteriaJson);\n\n// Parameters for signature generation\nconst parametersForSignature = {\n    apik: apiKey,\n    request_date: requestDate\n};\n\n// Generate the signature\nconst signature = generateSignature(parametersForSignature, secretKey);\n\n// Return the data for HTTP request\nreturn {\n    //apik: apiKey,\n    request_date: requestDate,\n    targeting_criteria: targetingCriteriaJson, // Send as JSON string\n    signature: signature,\n    fullUrl: \"https://surveypmr.prodegeapisqa.com/prodegemr/feasibility-run\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-272,432],"id":"71974205-5840-4234-a67e-b829cdad7228","name":"Code in JavaScript"},{"parameters":{"url":"=https://surveypmr.prodegeapis.com/prodegemr/lookup-country-all","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"request_date","value":"={{ $json.request_date }}"},{"name":"signature","value":"={{ $json.signature }}"}]},"options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-48,432],"id":"f11979d1-63fe-4f67-bae1-a15fc5e3dc7e","name":"Get Country ID","credentials":{"httpQueryAuth":{"id":"V3Xxf7Ey1rzsqLV1","name":"Peeq Prod Query Auth"}}},{"parameters":{"url":"=https://surveypmr.prodegeapis.com/prodegemr/lookup-question-by-country","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"request_date","value":"={{ $json.parameters.request_date }}"},{"name":"signature","value":"={{ $json.signature }}"},{"name":"country_id","value":"={{ $json.parameters.country_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1888,384],"id":"8bea8056-53dc-4d18-ab27-4cac25377e70","name":"Get Questions by Country","credentials":{"httpQueryAuth":{"id":"V3Xxf7Ey1rzsqLV1","name":"Peeq Prod Query Auth"}}},{"parameters":{"promptType":"define","text":"=input:  {{ $json.data }}\n\ncountry: {{ $('criteria').item.json.criteria.country }}","hasOutputParser":true,"options":{"systemMessage":"You are a data filtering assistant. Your task is to:\n\n1. Parse the input JSON data containing a list of countries\n2. Find the country that matches the specified country name or country code (case-insensitive)\n3. Return ONLY the matching country's properties as separate fields in JSON format\n\nRules:\n- Match against both country_name and country_code fields\n- Be flexible with matching (e.g., \"United States\", \"USA\", \"US\" should all match)\n- If no match is found, return null for all fields and set error message\n- Return ONLY valid JSON with these exact field names, no additional text\n\nRequired output format (exact field names):\n{\n  \"country_id\": <number or null>,\n  \"country_name\": \"<string or null>\",\n  \"country_code\": \"<string or null>\"\n}\n\nIf not found:\n{\n  \"country_id\": null,\n  \"country_name\": null,\n  \"country_code\": null,\n  \"error\": \"Country not found\"\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[176,432],"id":"43973d43-bf51-4a0b-b53a-384c9de52a99","name":"AI Agent","onError":"continueErrorOutput"},{"parameters":{"model":{"__rl":true,"value":"gpt-5","mode":"list","cachedResultName":"gpt-5"},"options":{"timeout":60000,"maxRetries":5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[176,656],"id":"8e7a3d12-a4b6-4dbc-b8f9-09e088389a94","name":"OpenAI Chat Model5","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{"jsonSchemaExample":"{\n  \"country_id\": 1,\n  \"country_name\": \"USA\",\n  \"country_code\": \"US\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[304,656],"id":"3d81d7ad-8f9a-41be-aca6-0f636b8fbf30","name":"Structured Output Parser3"},{"parameters":{"jsCode":"// Parse the stringified JSON data\nconst parsedData = JSON.parse($input.first().json.data);\n\n// Extract the questions array\nconst questions = parsedData.questions;\n\n// Return each question as its own item\nreturn questions.map(question => ({\n  json: question\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2112,384],"id":"f075af2f-ae72-4779-8a6b-448f75fe7a2a","name":"Split Out"},{"parameters":{"jsCode":"// Get the criteria_words from the \"clean criteria\" node\nconst criteriaWords = $('clean criteria').first().json.criteria_words || '';\n\n// Split into array, trim, and lowercase\nconst criteriaList = criteriaWords.split(',').map(c => c.trim().toLowerCase());\n\n// Filter items where question_text, question_name, or any option_text contains any criteria word\nreturn $input.all().filter(item => {\n  const question = item.json;\n\n  // Lowercase fields for comparison\n  const questionText = (question.question_text || '').toLowerCase();\n  const questionName = (question.question_name || '').toLowerCase();\n\n  // Check if any criteria word matches question_text or question_name\n  const matchesQuestion = criteriaList.some(criteria => \n    questionText.includes(criteria) || questionName.includes(criteria)\n  );\n\n  // Check if any criteria word matches any option_text\n  const matchesOptions = question.options && question.options.length > 0\n    ? question.options.some(option => {\n        const optionText = (option.option_text || '').toLowerCase();\n        return criteriaList.some(criteria => optionText.includes(criteria));\n      })\n    : false;\n\n  // Keep if matches question OR options\n  return matchesQuestion || matchesOptions;\n\n}).map(item => ({ json: item.json }));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2336,384],"id":"43520ac2-2517-4ce8-8094-36b810569375","name":"Filter out by Answer_text OR Question_text"},{"parameters":{"model":{"__rl":true,"value":"gpt-5-nano","mode":"list","cachedResultName":"gpt-5-nano"},"options":{"timeout":60000,"maxRetries":5}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1200,608],"id":"651303ad-181d-4375-9d7c-ece95f1adcb0","name":"OpenAI Chat Model10","credentials":{"openAiApi":{"id":"Q8Dkie3VMouch4E5","name":"OpenAi 1L6 4E5"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1.1,"position":[1456,608],"id":"1186f021-7004-453c-8e0f-88dbe702f7d1","name":"Think"},{"parameters":{"sessionIdType":"customKey","sessionKey":"optimization_session"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[1328,608],"id":"9a4c826b-daec-4136-8481-3973b634cdb3","name":"Simple Memory"},{"parameters":{"promptType":"define","text":"=Execute your function and output it appended to the original input.","hasOutputParser":true,"options":{"systemMessage":"=You are a keyword extraction agent.\n\nTask:\nFrom the input criteria in {{ $json.answer_text.criteria.criteria }}, extract **all relevant keywords**, including both:\n\n1. **Specific terms** (e.g., \"Male\", \"Asthma\", \"Dog Owners\")  \n2. **Broader conceptual categories** (e.g., \"gender\", \"patients\", \"ownership\", \"children\", \"education\")\n\nRules:\n- For numeric fields (age, income, height, weight, etc.), extract **only the concept word**, NOT the numbers or ranges. Example: \"Ages 18-25\" â†’ \"age\"\n- Expand specific terms into broader concepts using these examples:\n  - \"Male\" â†’ \"male, gender\"\n  - \"Female\" â†’ \"female, gender\"\n  - \"Dog Owners\" â†’ \"dog, ownership, owners\"\n  - \"Pet Owners\" â†’ \"pet, ownership, owners\"\n  - \"Car Owners\" â†’ \"car, ownership, owners\"\n  - \"Home Owners\" â†’ \"home, ownership, owners\"\n  - \"Parents\" â†’ \"parents, children\"\n  - \"Students\" â†’ \"students, education\"\n- Include each keyword **once**, no duplicates\n- Output as a **comma-separated string** of keywords\n\nExamples:\n- Input: \"Ages 18-25, Asthma patients\"  \n  Output: \"age, asthma, patients\"\n\n- Input: \"Male, Dog Owners\"  \n  Output: \"male, gender, dog, ownership, owners\"\n\n- Input: \"Income $50,000-$75,000, Female, College educated\"  \n  Output: \"income, female, gender, education, college\"\n\nOutput only the final **comma-separated keywords string**, do not include any other text.\n","maxIterations":5,"returnIntermediateSteps":true}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1264,384],"id":"7c4b8f6b-b209-466d-94a9-10c49b65f1be","name":"Get Questions by Country V2","executeOnce":false},{"parameters":{"jsCode":"// Get the output from the previous agent node\nconst agentOutput = $input.first().json; \n// Example structure of agentOutput: { output: \"male, gender\", intermediateSteps: [] }\n\n// Get the original data from the Questions By CountryID node\nconst questionsNodeOutput = $('Questions By CountryID').first().json;\n\n// Add the agent's output as criteria_words\nquestionsNodeOutput.criteria_words = agentOutput.output;\n\n// Return the updated object\nreturn {\n    json: questionsNodeOutput\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1664,384],"id":"95d7de52-5ac1-4616-8e89-4bf2949c7a67","name":"clean criteria"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b8f79dcf-a09a-4684-994c-a9eb30c63977","leftValue":"={{ $json.question_text }}","rightValue":"car","operator":{"type":"string","operation":"notContains"}},{"id":"f1c95927-a35a-4281-91ef-34d46358e05f","leftValue":"={{ $json.question_id }}","rightValue":602,"operator":{"type":"number","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[3008,288],"id":"f2039b82-3c63-4afd-946d-ebcf818dc462","name":"Filter"},{"parameters":{"assignments":{"assignments":[{"id":"607df5e8-7715-4c32-9ab9-d174f14bf163","name":"URL","value":"https://surveypmr.prodegeapisqa.com/prodegemr","type":"string"},{"id":"f2506a11-6c0d-465f-bbcb-5c2c5dfdd793","name":"country_id","value":"={{ $('setCountryRequestFields').first().json.country_id }}","type":"number"},{"id":"14519b0c-8549-494a-90ba-2014ef116cf2","name":"questions","value":"={{ $json.output[0].questions }}","type":"string"},{"id":"b602df91-cc6c-4036-afe3-b2978e34042c","name":"IR","value":"={{ $json.output[0].IR }}","type":"number"},{"id":"a107f78c-33ce-43b3-a72d-586c4b0a20d1","name":"LOI","value":"={{ $json.output[0].LOI }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4880,432],"id":"8773e7aa-89c1-4468-a03f-ca027fc8d57e","name":"setFeasibility2"},{"parameters":{"jsCode":"// Import crypto for signature generation\nconst crypto = require('crypto');\n\n// Function to decrypt encrypted strings\nconst decryptString = (encryptedText, password) => {\n    const algorithm = 'aes-256-cbc';\n    const key = crypto.scryptSync(password, 'salt', 32);\n    \n    const parts = encryptedText.split(':');\n    const iv = Buffer.from(parts[0], 'hex');\n    const encrypted = parts[1];\n    \n    const decipher = crypto.createDecipheriv(algorithm, key, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    \n    return decrypted;\n};\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// ðŸ” GET ENCRYPTED KEYS FROM ENVIRONMENT VARIABLES AND DECRYPT\nconst encryptedApiKey = $vars.e_apikey;\nconst encryptedSecretKey = $vars.e_secret;\nconst encryptionPassword = $vars.e_password;\n\n// Validate environment variables are set\nif (!encryptedApiKey) {\n    throw new Error('âŒ Environment variable \"e_apikey\" is not set or is empty');\n}\nif (!encryptedSecretKey) {\n    throw new Error('âŒ Environment variable \"e_secret\" is not set or is empty');\n}\nif (!encryptionPassword) {\n    throw new Error('âŒ Environment variable \"e_password\" is not set or is empty');\n}\n\nconsole.log('âœ… All environment variables found');\n\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('ðŸ”“ Keys decrypted successfully');\n\n// Get data from setFeasibility node\nconst setFeasibilityData = $input.first().json;\n\n// Get targeting_criteria from agent output (previous to setFeasibility)\nconst agentOutput = $('FinalQuestion Check').first().json;\nlet targetingCriteria = agentOutput.output && agentOutput.output[0] && agentOutput.output[0].targeting_criteria \n    ? agentOutput.output[0].targeting_criteria \n    : agentOutput.targeting_criteria;\n\n// If targeting_criteria is an array, stringify it\nif (targetingCriteria && Array.isArray(targetingCriteria)) {\n    targetingCriteria = JSON.stringify(targetingCriteria);\n}\n\n// Get current timestamp\nconst requestDate = Date.now();\n\n// Build parameters for signature\nconst parametersForSignature = {\n    apik: apiKey,\n    request_date: requestDate\n};\n\n// Add optional parameters if they exist\nif (setFeasibilityData.country_id) parametersForSignature.country_id = setFeasibilityData.country_id;\nif (targetingCriteria) parametersForSignature.targeting_criteria = targetingCriteria;\n//if (setFeasibilityData.LOI) parametersForSignature.LOI = setFeasibilityData.LOI;\n//if (setFeasibilityData.IR) parametersForSignature.IR = setFeasibilityData.IR;\n\n// Generate signature\nconst signature = generateSignature(parametersForSignature, secretKey);\n\n// Build final output\nconst output = {\n   // apik: apiKey,\n    request_date: requestDate,\n    country_id: setFeasibilityData.country_id,\n    targeting_criteria: targetingCriteria,\n    LOI: setFeasibilityData.LOI,\n    IR: setFeasibilityData.IR,\n    signature: signature,\n    fullUrl: `${setFeasibilityData.URL}/feasibility-run`,\n    questions: setFeasibilityData.questions\n};\n\nreturn { json: output };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5360,544],"id":"d279723a-244a-4f02-99c8-e735767209c8","name":"Compile Feasibility2"},{"parameters":{"method":"POST","url":"=https://surveypmr.prodegeapis.com/prodegemr/feasibility-run","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}","sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"request_date","value":"={{ $json.request_date }}"},{"name":"signature","value":"={{ $json.signature }}"},{"name":"country_id","value":"={{ $json.country_id }}"},{"name":"targeting_criteria","value":"={{ $json.targeting_criteria }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5616,640],"id":"173aa232-a937-45f8-aa71-7ae5fd78a00f","name":"Run Feasibility3","credentials":{"httpQueryAuth":{"id":"V3Xxf7Ey1rzsqLV1","name":"Peeq Prod Query Auth"}}},{"parameters":{"jsCode":"// Import crypto for signature generation\nconst crypto = require('crypto');\n\n// Function to decrypt encrypted strings\nconst decryptString = (encryptedText, password) => {\n    const algorithm = 'aes-256-cbc';\n    const key = crypto.scryptSync(password, 'salt', 32);\n    \n    const parts = encryptedText.split(':');\n    const iv = Buffer.from(parts[0], 'hex');\n    const encrypted = parts[1];\n    \n    const decipher = crypto.createDecipheriv(algorithm, key, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    \n    return decrypted;\n};\n\n// Function to generate the signature\nconst generateSignature = (parameters, secretKey) => {\n    const sortedKeys = Object.keys(parameters).sort();\n    const stringToSign = sortedKeys.map(key => `${key}=${parameters[key]}`).join(':');\n    const utf8Bytes = Buffer.from(`${secretKey}:${stringToSign}`, 'utf-8');\n    const hash = crypto.createHash('sha256').update(utf8Bytes).digest();\n    const base64Hash = hash.toString('base64');\n    const signature = base64Hash.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n    return signature;\n};\n\n// ðŸ” GET ENCRYPTED KEYS FROM ENVIRONMENT VARIABLES AND DECRYPT\nconst encryptedApiKey = $vars.e_apikey;\nconst encryptedSecretKey = $vars.e_secret;\nconst encryptionPassword = $vars.e_password;\n\n// Validate environment variables are set\nif (!encryptedApiKey) {\n    throw new Error('âŒ Environment variable \"e_apikey\" is not set or is empty');\n}\nif (!encryptedSecretKey) {\n    throw new Error('âŒ Environment variable \"e_secret\" is not set or is empty');\n}\nif (!encryptionPassword) {\n    throw new Error('âŒ Environment variable \"e_password\" is not set or is empty');\n}\n\nconsole.log('âœ… All environment variables found');\n\nconst apiKey = decryptString(encryptedApiKey, encryptionPassword);\nconst secretKey = decryptString(encryptedSecretKey, encryptionPassword);\n\nconsole.log('ðŸ”“ Keys decrypted successfully');\n\n// Get data from setFeasibility node\nconst setFeasibilityData = $input.first().json;\n\n// Get targeting_criteria from agent output (previous to setFeasibility)\nconst agentOutput = $('FinalQuestion Check').first().json;\nlet targetingCriteria = agentOutput.output && agentOutput.output[0] && agentOutput.output[0].targeting_criteria \n    ? agentOutput.output[0].targeting_criteria \n    : agentOutput.targeting_criteria;\n\n// If targeting_criteria is an array, stringify it\nif (targetingCriteria && Array.isArray(targetingCriteria)) {\n    targetingCriteria = JSON.stringify(targetingCriteria);\n}\n\n// Normalize LOI (remove text like \"min\", \"minutes\", \"mins\", etc.) and convert to integer\nlet normalizedLOI = setFeasibilityData.LOI;\nif (normalizedLOI !== undefined && normalizedLOI !== null) {\n    if (typeof normalizedLOI === 'string') {\n        normalizedLOI = normalizedLOI.replace(/[^0-9.]/g, '');\n    }\n    normalizedLOI = parseInt(normalizedLOI, 10);\n}\n\n// Normalize IR (remove \"%\" symbol) and convert to integer\nlet normalizedIR = setFeasibilityData.IR;\nif (normalizedIR !== undefined && normalizedIR !== null) {\n    if (typeof normalizedIR === 'string') {\n        normalizedIR = normalizedIR.replace(/[^0-9.]/g, '');\n    }\n    normalizedIR = parseInt(normalizedIR, 10);\n}\n\n// Get current timestamp\nconst requestDate = Date.now();\n\n// Build parameters for signature (use numbers as-is)\nconst parametersForSignature = {\n    apik: apiKey,\n    request_date: requestDate\n};\n\n// Add optional parameters if they exist\nif (setFeasibilityData.country_id) parametersForSignature.country_id = setFeasibilityData.country_id;\nif (targetingCriteria) parametersForSignature.targeting_criteria = targetingCriteria;\nif (!isNaN(normalizedLOI)) parametersForSignature.loi = normalizedLOI;  // Keep as number\nif (!isNaN(normalizedIR)) parametersForSignature.expected_incidence_rate = normalizedIR;    // Keep as number\n\n// Generate signature\nconst signature = generateSignature(parametersForSignature, secretKey);\n\n// Build final output (LOI and IR as numbers, unquoted in JSON)\nconst output = {\n    request_date: requestDate,\n    country_id: setFeasibilityData.country_id,\n    targeting_criteria: targetingCriteria,\n    LOI: normalizedLOI,  // Number (integer)\n    IR: normalizedIR,    // Number (integer)\n    signature: signature,\n    fullUrl: `${setFeasibilityData.URL}/feasibility-run`,\n    questions: setFeasibilityData.questions\n};\n\nreturn { json: output };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5440,272],"id":"1a14dd9a-f4ae-43b1-a2e1-79460fafd9fa","name":"Compile Feasibility3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"26083114-207a-44c5-809d-c307ff2e23e9","leftValue":"={{ $json.LOI }}","rightValue":0,"operator":{"type":"number","operation":"gt"}},{"id":"052803ca-1f7b-462e-beba-cb5cffcb67d3","leftValue":"={{ $json.IR }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[5088,432],"id":"78d3c380-a3b5-47aa-8871-bb4f0a53cdb1","name":"If2"},{"parameters":{"method":"POST","url":"=https://surveypmr.prodegeapis.com/prodegemr/feasibility-run","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}","sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"request_date","value":"={{ $json.request_date }}"},{"name":"signature","value":"={{ $json.signature }}"},{"name":"country_id","value":"={{ $json.country_id }}"},{"name":"targeting_criteria","value":"={{ $json.targeting_criteria }}"},{"name":"loi","value":"={{ $json.LOI }}"},{"name":"expected_incidence_rate","value":"={{ $json.IR }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5680,352],"id":"ae6f0d16-c272-42b7-95a0-74dee31494f6","name":"Run Feasibility with LOI/IR","credentials":{"httpQueryAuth":{"id":"V3Xxf7Ey1rzsqLV1","name":"Peeq Prod Query Auth"}}},{"parameters":{"assignments":{"assignments":[{"id":"6ebfb9fe-4aa7-4cb2-be29-9e518635df52","name":"data","value":"={{ $json['Bid Request Text Area']}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3424,112],"id":"1bdacf4e-88cf-4de5-a8ee-d33c3e8c3d3f","name":"setData"},{"parameters":{"assignments":{"assignments":[{"id":"00a6c4d9-5423-45e1-a7b7-1218724634f1","name":"data","value":"={{ $json.metadata.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3424,400],"id":"6f04e6c0-34f1-488a-ba89-d49d2e334c22","name":"setData1"},{"parameters":{"formTitle":"Peeq Bid Email Trigger (Manual API)","formDescription":"=Submit hubspot email engagment link to test. \n\nExample: https://app.hubspot.com/contacts/20464009/record/0-3/44206538524/view/1?engagement=89272792909&type=EMAIL\n\nWARNING: This automation can take 5+ minutes to run.\n\nReview results here: \n\n{{ `<a href=\"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?gid=0#gid=0\" target=\"_blank\">Open Google Sheet</a>` }}\n","formFields":{"values":[{"fieldLabel":"Hubspot Email Engagment Link","placeholder":"https://app.hubspot.com/contacts/20464009/record/0-3/44206538524/view/1?engagement=89272792909&type=EMAIL","requiredField":true}]},"options":{}},"type":"n8n-nodes-base.formTrigger","typeVersion":2.3,"position":[-4304,400],"id":"3c2ade19-f3d1-4831-994c-4a32f3b5210e","name":"Email Form","webhookId":"78509cef-8e94-41c8-845e-b4621b1301e9"},{"parameters":{"formTitle":"Peeq Bid Text Trigger (Manual API)","formDescription":"=Submit hubspot email engagment link to test. \n\nExample: https://app.hubspot.com/contacts/20464009/record/0-3/44206538524/view/1?engagement=89272792909&type=EMAIL\n\nWARNING: This automation can take 5+ minutes to run.\n\nReview results here: \n\n{{ `<a href=\"https://docs.google.com/spreadsheets/d/1Qg1TCdGnOehSgbEbHt1OFZIgE3XNtwO7T2jlnSPn1Ko/edit?gid=0#gid=0\" target=\"_blank\">Open Google Sheet</a>` }}\n","formFields":{"values":[{"fieldLabel":"Bid Request Text Area","fieldType":"textarea","placeholder":"I need feasibility for males in USA with a dog","defaultValue":"I need feasibility for males in USA with a dog","requiredField":true}]},"options":{}},"type":"n8n-nodes-base.formTrigger","typeVersion":2.3,"position":[-3632,112],"id":"5a1d5ca9-3ae0-49fc-9a82-84b0ac88f36c","name":"Text Form","webhookId":"6a56c58b-64a0-44a2-b7cd-4affdf9e96bd"}],"connections":{"Questions By CountryID":{"main":[[{"node":"Get Exclude QID List","type":"main","index":0},{"node":"Get Questions by Country V2","type":"main","index":0}]]},"cleaned json":{"main":[[{"node":"Filter","type":"main","index":0}]]},"setCountryRequestFields":{"main":[[{"node":"Questions By CountryID","type":"main","index":0}]]},"Filter1":{"main":[[{"node":"setFeasibility","type":"main","index":0},{"node":"Aggregate1","type":"main","index":0}]]},"Compile Feasibility":{"main":[[{"node":"FinalQuestion Check","type":"main","index":0}]]},"setFeasibility":{"main":[[{"node":"Compile Feasibility","type":"main","index":0}]]},"results":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"OpenAI Chat Model6":{"ai_languageModel":[[{"node":"Email Analyst","type":"ai_languageModel","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Email Analyst","type":"ai_outputParser","index":0}]]},"Email Analyst":{"main":[[{"node":"Append row in sheet","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"If1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[{"node":"Aggregate","type":"main","index":0}],[{"node":"criteria","type":"main","index":0}]]},"Append row in sheet":{"main":[[{"node":"setOutput","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Get Row1","type":"main","index":0}]]},"Get Row":{"main":[[{"node":"Update Row","type":"main","index":0}]]},"criteria":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"setOutput":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"Get Row1":{"main":[[{"node":"Update Row1","type":"main","index":0}]]},"If":{"main":[[{"node":"setCountryRequestFields","type":"main","index":0}],[{"node":"Get Row2","type":"main","index":0}]]},"Get Row2":{"main":[[{"node":"Update Row2","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"QuestionIdentification1","type":"ai_languageModel","index":0}]]},"QuestionIdentification1":{"main":[[{"node":"Filter1","type":"main","index":0}]]},"Structured Output Parser4":{"ai_outputParser":[[{"node":"QuestionIdentification1","type":"ai_outputParser","index":0}]]},"Aggregate1":{"main":[[{"node":"Get Row","type":"main","index":0}]]},"Get an engagement":{"main":[[{"node":"setData1","type":"main","index":0}]]},"setEngagmentId":{"main":[[{"node":"Get an engagement","type":"main","index":0}]]},"setLink":{"main":[[{"node":"setEngagmentId","type":"main","index":0}]]},"setText":{"main":[[{"node":"Email Extractor","type":"main","index":0}]]},"OpenAI Chat Model3":{"ai_languageModel":[[{"node":"Email Extractor","type":"ai_languageModel","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"Email Extractor","type":"ai_outputParser","index":0}]]},"Email Extractor":{"main":[[{"node":"setEmail","type":"main","index":0}]]},"setEmail":{"main":[[{"node":"Email Analyst","type":"main","index":0}]]},"If1":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}],[{"node":"Loop Over Items1","type":"main","index":0}]]},"Get Exclude QID List":{"main":[[{"node":"Combine Exclude","type":"main","index":0}]]},"Combine Exclude":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"cleaned json","type":"main","index":0}]]},"FinalQuestion Check":{"main":[[{"node":"setFeasibility2","type":"main","index":0}]]},"OpenAI Chat Model8":{"ai_languageModel":[[{"node":"FinalQuestion Check","type":"ai_languageModel","index":0}]]},"Simple Memory5":{"ai_memory":[[{"node":"FinalQuestion Check","type":"ai_memory","index":0}]]},"Think5":{"ai_tool":[[{"node":"FinalQuestion Check","type":"ai_tool","index":0}]]},"Snowflake":{"ai_tool":[[{"node":"FinalQuestion Check","type":"ai_tool","index":0}]]},"Structured Output Parser9":{"ai_outputParser":[[{"node":"FinalQuestion Check","type":"ai_outputParser","index":0}]]},"Code in JavaScript":{"main":[[{"node":"Get Country ID","type":"main","index":0}]]},"Get Country ID":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Get Questions by Country":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"OpenAI Chat Model5":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"If","type":"main","index":0}],[{"node":"If","type":"main","index":0}]]},"Structured Output Parser3":{"ai_outputParser":[[{"node":"AI Agent","type":"ai_outputParser","index":0}]]},"Split Out":{"main":[[{"node":"Filter out by Answer_text OR Question_text","type":"main","index":0}]]},"Filter out by Answer_text OR Question_text":{"main":[[{"node":"Merge","type":"main","index":1}]]},"OpenAI Chat Model10":{"ai_languageModel":[[{"node":"Get Questions by Country V2","type":"ai_languageModel","index":0}]]},"Think":{"ai_tool":[[{"node":"Get Questions by Country V2","type":"ai_tool","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"Get Questions by Country V2","type":"ai_memory","index":0}]]},"Get Questions by Country V2":{"main":[[{"node":"clean criteria","type":"main","index":0}]]},"clean criteria":{"main":[[{"node":"Get Questions by Country","type":"main","index":0}]]},"Filter":{"main":[[{"node":"QuestionIdentification1","type":"main","index":0}]]},"setFeasibility2":{"main":[[{"node":"If2","type":"main","index":0}]]},"Compile Feasibility2":{"main":[[{"node":"Run Feasibility3","type":"main","index":0}]]},"Run Feasibility3":{"main":[[{"node":"results","type":"main","index":0}]]},"Compile Feasibility3":{"main":[[{"node":"Run Feasibility with LOI/IR","type":"main","index":0}]]},"If2":{"main":[[{"node":"Compile Feasibility3","type":"main","index":0}],[{"node":"Compile Feasibility2","type":"main","index":0}]]},"Run Feasibility with LOI/IR":{"main":[[{"node":"results","type":"main","index":0}]]},"setData":{"main":[[{"node":"setText","type":"main","index":0}]]},"setData1":{"main":[[{"node":"setText","type":"main","index":0}]]},"Email Form":{"main":[[{"node":"setLink","type":"main","index":0}]]},"Text Form":{"main":[[{"node":"setData","type":"main","index":0}]]}},"authors":"Boden Johnson","name":null,"description":null},"tags":[{"updatedAt":"2025-09-16T22:03:04.244Z","createdAt":"2025-09-16T22:03:04.244Z","id":"1JleW3VaKeNkbHMv","name":"catalog"},{"updatedAt":"2025-08-31T22:15:28.746Z","createdAt":"2025-08-31T22:15:28.746Z","id":"MSbYUejSnKte9BCA","name":"insights"},{"updatedAt":"2025-06-06T18:17:40.197Z","createdAt":"2025-06-06T18:17:16.177Z","id":"QSobdHvedr4NOCqq","name":"hubspot HS"}]}